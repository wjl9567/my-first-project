<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>我的登记记录</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta name="theme-color" content="#0f766e" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <style>
      /* 与 scan / 后台统一设计语言 */
      * { box-sizing: border-box; }
      :root {
        --primary: #0d9488;
        --primary-dark: #0f766e;
        --surface: #ffffff;
        --border: #e2e8f0;
        --text: #334155;
        --text-muted: #64748b;
        --radius: 12px;
        --shadow: 0 2px 8px rgba(13, 148, 136, 0.06);
        --safe-bottom: env(safe-area-inset-bottom, 0px);
        --safe-top: env(safe-area-inset-top, 0px);
      }
      body {
        font-family: "PingFang SC", "Microsoft YaHei", -apple-system, BlinkMacSystemFont, sans-serif;
        margin: 0;
        padding: 16px 16px calc(60px + var(--safe-bottom));
        padding-top: calc(12px + var(--safe-top));
        min-height: 100vh;
        min-height: -webkit-fill-available;
        background: linear-gradient(180deg, #f0fdfa 0%, #e0f2fe 38%, #f0f9ff 100%);
        font-size: 16px;
        color: var(--text);
        -webkit-tap-highlight-color: transparent;
      }
      .page-header {
        text-align: center;
        margin-bottom: 24px;
      }
      .page-header h1 {
        font-size: 20px;
        font-weight: 600;
        margin: 0 0 6px;
        color: var(--primary-dark);
      }
      .page-header .sub {
        font-size: 13px;
        color: var(--text-muted);
      }
      .wrap {
        max-width: 420px;
        margin: 0 auto;
      }
      .toolbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 16px;
      }
      .filters {
        background: var(--surface);
        border-radius: var(--radius);
        padding: 12px 14px;
        margin-bottom: 12px;
        border: 1px solid var(--border);
        box-shadow: var(--shadow);
      }
      .filter-row {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 10px;
        flex-wrap: wrap;
      }
      .filter-row:last-of-type { margin-bottom: 0; }
      .filter-row label { font-size: 13px; color: var(--text-muted); min-width: 64px; }
      .filter-row input[type="date"],
      .filter-row input[type="text"] {
        flex: 1;
        min-width: 0;
        max-width: 140px;
        padding: 8px 10px;
        border-radius: 8px;
        border: 1px solid var(--border);
        font-size: 14px;
      }
      .filter-sep { font-size: 12px; color: var(--text-muted); }
      .btn-apply {
        min-height: 36px;
        padding: 0 16px;
        border-radius: 8px;
        border: none;
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: #fff;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
      }
      .btn-apply:active { opacity: 0.9; }
      .toolbar .hint {
        font-size: 14px;
        color: var(--text-muted);
      }
      .btn-refresh {
        min-height: 44px;
        padding: 0 20px;
        border-radius: var(--radius);
        border: 1px solid var(--border);
        background: var(--surface);
        color: var(--primary-dark);
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        box-shadow: var(--shadow);
      }
      .btn-refresh:active { opacity: 0.9; }
      .load-more-wrap { text-align: center; margin-top: 16px; margin-bottom: 8px; }
      .btn-load-more {
        min-height: 44px;
        padding: 0 24px;
        border-radius: var(--radius);
        border: 1px solid var(--border);
        background: var(--surface);
        color: var(--primary-dark);
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        box-shadow: var(--shadow);
      }
      .btn-load-more:active { opacity: 0.9; }
      .btn-load-more:disabled { opacity: 0.6; cursor: not-allowed; }
      .record-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .record-card {
        background: var(--surface);
        border-radius: 14px;
        padding: 16px;
        border: 1px solid var(--border);
        box-shadow: var(--shadow);
      }
      .record-card .time {
        font-size: 13px;
        color: var(--text-muted);
        margin-bottom: 6px;
      }
      .record-card .device {
        font-size: 16px;
        font-weight: 600;
        color: var(--primary-dark);
        margin-bottom: 4px;
      }
      .record-card .meta {
        font-size: 14px;
        color: var(--text);
      }
      .record-card .extra {
        font-size: 13px;
        color: var(--text-muted);
        margin-top: 6px;
        line-height: 1.5;
      }
      .record-card .note {
        font-size: 14px;
        color: var(--text-muted);
        margin-top: 6px;
        padding-top: 8px;
        border-top: 1px solid var(--border);
      }
      .record-card .card-actions {
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid var(--border);
      }
      .record-card .btn-undo {
        padding: 6px 14px;
        font-size: 13px;
        border-radius: var(--radius);
        border: 1px solid var(--border);
        background: var(--surface);
        color: var(--text-muted);
        cursor: pointer;
      }
      .record-card .btn-undo:active { opacity: 0.9; }
      .record-card .btn-undo:disabled { opacity: 0.6; cursor: not-allowed; }
      .record-card.record-card-undo {
        background: #f1f5f9;
        color: var(--text-muted);
      }
      .record-card-undo .device { color: var(--text-muted); }
      .record-card-undo .record-undo-tag {
        display: inline-block;
        margin-left: 8px;
        padding: 2px 8px;
        font-size: 12px;
        border-radius: 4px;
        background: #cbd5e1;
        color: #64748b;
      }
      .undo-confirm-overlay {
        position: fixed;
        left: 0;
        right: 0;
        top: 0;
        bottom: 0;
        background: rgba(0,0,0,0.4);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 999;
        padding: 20px;
      }
      .undo-confirm-box {
        background: var(--surface);
        border-radius: var(--radius);
        padding: 20px;
        max-width: 320px;
        width: 100%;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      }
      .undo-confirm-box .msg { font-size: 15px; color: var(--text); margin-bottom: 16px; line-height: 1.5; }
      .undo-confirm-box .btns { display: flex; gap: 12px; justify-content: flex-end; }
      .undo-confirm-box .btns button { padding: 10px 20px; border-radius: var(--radius); font-size: 15px; font-weight: 600; cursor: pointer; border: none; }
      .undo-confirm-box .btns .btn-cancel { background: var(--border); color: var(--text); }
      .undo-confirm-box .btns .btn-ok { background: var(--primary-dark); color: #fff; }
      .empty-state {
        text-align: center;
        padding: 48px 24px;
        background: var(--surface);
        border-radius: 16px;
        border: 1px dashed var(--border);
        box-shadow: var(--shadow);
      }
      .empty-state p {
        margin: 0 0 16px;
        font-size: 15px;
        color: var(--text-muted);
      }
      .empty-state a {
        display: inline-block;
        min-height: 44px;
        line-height: 44px;
        padding: 0 24px;
        border-radius: var(--radius);
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: #fff;
        font-size: 16px;
        font-weight: 600;
        text-decoration: none;
      }
      .empty-state a:active { opacity: 0.9; }
      .loading, .error-msg {
        text-align: center;
        padding: 24px;
        font-size: 15px;
        color: var(--text-muted);
      }
      .error-msg { color: #dc2626; }
      .error-msg p { margin: 8px 0; }
      .error-msg .error-login-link { color: var(--primary); font-weight: 500; }
      .bottom-nav {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        height: calc(56px + var(--safe-bottom));
        padding-bottom: var(--safe-bottom);
        background: var(--surface);
        border-top: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 -2px 12px rgba(0, 0, 0, 0.06);
        z-index: 100;
      }
      .bottom-nav a {
        flex: 1;
        max-width: 180px;
        min-height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 15px;
        font-weight: 600;
        color: var(--text-muted);
        text-decoration: none;
        -webkit-tap-highlight-color: transparent;
      }
      .bottom-nav a.active { color: var(--primary-dark); }
      .bottom-nav a:active { opacity: 0.8; }
      .page-version {
        text-align: center;
        margin-top: 20px;
        font-size: 12px;
        color: var(--text-muted);
      }
    </style>
  </head>
  <body>
    <div class="page-header">
      <h1>我的登记记录</h1>
      <p class="sub">最近登记一览</p>
    </div>

    <div class="wrap">
      <div class="filters">
        <div class="filter-row">
          <label>登记日期</label>
          <input type="date" id="filter-date-from" />
          <span class="filter-sep">至</span>
          <input type="date" id="filter-date-to" />
        </div>
        <div class="filter-row">
          <input type="text" id="filter-bed" placeholder="床号" />
          <input type="text" id="filter-device" placeholder="设备编号" />
          <button type="button" class="btn-apply" id="btn-apply">筛选</button>
        </div>
      </div>
      <div class="toolbar">
        <span class="hint" id="count-hint"></span>
        <button type="button" class="btn-refresh" id="btn-refresh">刷新</button>
      </div>

      <div id="list-container">
        <div class="loading" id="loading">加载中...</div>
        <div class="record-list" id="record-list" style="display:none;"></div>
        <div class="load-more-wrap" id="load-more-wrap" style="display:none;">
          <button type="button" class="btn-load-more" id="btn-load-more">加载更多</button>
        </div>
        <div class="empty-state" id="empty-state" style="display:none;">
          <p>暂无登记记录</p>
          <a href="/h5/scan">去登记</a>
        </div>
        <div class="error-msg" id="error-msg" style="display:none;"></div>
      </div>
    </div>

    <div id="undo-confirm-wrap" class="undo-confirm-overlay" style="display:none;">
      <div class="undo-confirm-box">
        <p class="msg">仅支持撤销最近 {{ undo_window_hours|default(24) }} 小时内的登记，撤销后不能恢复。请确认是否撤销这条登记记录？</p>
        <div class="btns">
          <button type="button" class="btn-cancel" id="undo-confirm-cancel">取消</button>
          <button type="button" class="btn-ok" id="undo-confirm-ok">确定</button>
        </div>
      </div>
    </div>

    <div class="page-version">版本 v{{ app_version }}</div>
    <nav class="bottom-nav" aria-label="主导航">
      <a href="/h5/scan">登记</a>
      <a href="/h5/my-records" class="active">我的记录</a>
    </nav>

    <script>
      function escapeHtml(s) {
        if (s == null || s === undefined) return "";
        return String(s).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#39;");
      }
      (function () {
        var hash = location.hash.slice(1);
        var q = new URLSearchParams(location.search);
        var token = new URLSearchParams(hash).get("token") || q.get("token");
        if (token) {
          try { localStorage.setItem("device_scan_token", token); } catch (e) {}
        }
      })();
      function authHeaders() {
        try {
          var t = localStorage.getItem("device_scan_token");
          return t ? { "Authorization": "Bearer " + t } : {};
        } catch (e) { return {}; }
      }

      var typeNames = {
        1: "常规使用",
        2: "借用",
        3: "维修/故障",
        4: "校准/质控",
        5: "其他"
      };

      function formatTime(iso) {
        var d = new Date(iso);
        var now = new Date();
        var today = now.getFullYear() + "-" + (now.getMonth()+1) + "-" + now.getDate();
        var dDate = d.getFullYear() + "-" + (d.getMonth()+1) + "-" + d.getDate();
        if (dDate === today) {
          return "今天 " + d.toLocaleTimeString("zh-CN", { hour: "2-digit", minute: "2-digit" });
        }
        return d.toLocaleString("zh-CN", { month: "2-digit", day: "2-digit", hour: "2-digit", minute: "2-digit" });
      }

      var loadingEl = document.getElementById("loading");
      var listEl = document.getElementById("record-list");
      var loadMoreWrap = document.getElementById("load-more-wrap");
      var btnLoadMore = document.getElementById("btn-load-more");
      var emptyEl = document.getElementById("empty-state");
      var errorEl = document.getElementById("error-msg");
      var countHint = document.getElementById("count-hint");
      var btnRefresh = document.getElementById("btn-refresh");

      var pageSize = 30;
      var recordsLoaded = [];
      var totalCount = null;

      function showLoading() {
        loadingEl.style.display = "block";
        listEl.style.display = "none";
        loadMoreWrap.style.display = "none";
        emptyEl.style.display = "none";
        errorEl.style.display = "none";
      }

      function formatDateOnly(iso) {
        if (!iso) return "";
        var d = new Date(iso);
        return d.getFullYear() + "-" + String(d.getMonth() + 1).padStart(2, "0") + "-" + String(d.getDate()).padStart(2, "0");
      }
      function formatTimeOnly(iso) {
        if (!iso) return "";
        var d = new Date(iso);
        return d.toLocaleTimeString("zh-CN", { hour: "2-digit", minute: "2-digit" });
      }

      function renderRecordCards(records) {
        listEl.innerHTML = "";
        (records || []).forEach(function (r) {
          var isUndo = !!r.is_deleted;
          var card = document.createElement("div");
          card.className = "record-card" + (isUndo ? " record-card-undo" : "");
          var typeText = typeNames[r.usage_type] || String(r.usage_type);
          var undoTag = isUndo ? "<span class=\"record-undo-tag\">已撤销</span>" : "";
          var regDate = r.registration_date ? formatDateOnly(r.registration_date) : "";
          var deviceLine = escapeHtml(r.device_name ? (r.device_name + "（" + (r.device_code || "") + "）") : ("设备 " + (r.device_code || "")));
          var extraParts = [];
          if (r.bed_number) extraParts.push("床号 " + escapeHtml(r.bed_number));
          if (r.id_number) extraParts.push("ID " + escapeHtml(r.id_number));
          if (r.patient_name) extraParts.push(escapeHtml(r.patient_name));
          if (r.start_time) extraParts.push("开机 " + formatTimeOnly(r.start_time));
          if (r.end_time) extraParts.push("关机 " + formatTimeOnly(r.end_time));
          var eqCond = r.equipment_condition === "abnormal" ? "异常" : (r.equipment_condition === "normal" ? "正常" : "");
          if (eqCond) extraParts.push("状况 " + eqCond);
          var daily = r.daily_maintenance === "disinfect" ? "消毒" : (r.daily_maintenance === "clean" ? "清洁" : "");
          if (daily) extraParts.push(daily);
          var extraHtml = extraParts.length ? "<div class=\"extra\">" + extraParts.join(" · ") + "</div>" : "";
          var actionsHtml = isUndo
            ? ""
            : "<div class=\"card-actions\"><button type=\"button\" class=\"btn-undo\" data-id=\"" + (r.id || "") + "\">撤销</button></div>";
          card.innerHTML =
            "<div class=\"time\">" + (regDate || formatTime(r.start_time)) + undoTag + "</div>" +
            "<div class=\"device\">" + deviceLine + " · " + escapeHtml(typeText) + "</div>" +
            (r.user_name ? "<div class=\"meta\">维护人：" + escapeHtml(r.user_name) + "</div>" : "<div class=\"meta\">使用类型：" + escapeHtml(typeText) + "</div>") +
            extraHtml +
            (r.terminal_disinfection ? "<div class=\"note\">终末消毒：" + escapeHtml(r.terminal_disinfection.length > 40 ? r.terminal_disinfection.slice(0, 40) + "…" : r.terminal_disinfection) + "</div>" : "") +
            (r.note ? "<div class=\"note\">" + escapeHtml(r.note.length > 50 ? r.note.slice(0, 50) + "…" : r.note) + "</div>" : "") +
            actionsHtml;
          listEl.appendChild(card);
          if (!isUndo) {
            var btn = card.querySelector(".btn-undo");
            if (btn) btn.addEventListener("click", function () { onUndo(r.id, card); });
          }
        });
      }

      var undoPendingId = null;
      var undoPendingCard = null;
      function onUndo(recordId, cardEl) {
        if (!recordId) return;
        undoPendingId = recordId;
        undoPendingCard = cardEl;
        var wrap = document.getElementById("undo-confirm-wrap");
        if (wrap) wrap.style.display = "flex";
      }
      function doUndoRequest() {
        var recordId = undoPendingId;
        var cardEl = undoPendingCard;
        undoPendingId = null;
        undoPendingCard = null;
        var wrap = document.getElementById("undo-confirm-wrap");
        if (wrap) wrap.style.display = "none";
        if (!recordId) return;
        var btn = cardEl ? cardEl.querySelector(".btn-undo") : null;
        if (btn) btn.disabled = true;
        fetch("/api/usage/" + recordId + "/undo", {
          method: "POST",
          headers: authHeaders(),
        })
          .then(function (res) {
            if (res.status === 401) {
              alert("请先登录");
              if (btn) btn.disabled = false;
              return;
            }
            if (res.status === 403) {
              alert("只能撤销自己的登记记录");
              if (btn) btn.disabled = false;
              return;
            }
            if (!res.ok) {
              res.json().then(function (body) {
                var msg = (body && body.detail) ? (typeof body.detail === "string" ? body.detail : "撤销失败") : "撤销失败，请稍后重试";
                alert(msg);
              }).catch(function () { alert("撤销失败，请稍后重试"); });
              if (btn) btn.disabled = false;
              return;
            }
            recordsLoaded = recordsLoaded.filter(function (r) { return r.id !== recordId; });
            if (totalCount != null) totalCount = Math.max(0, totalCount - 1);
            countHint.textContent = "已撤销";
            countHint.style.color = "var(--primary-dark)";
            if (recordsLoaded.length === 0) {
              emptyEl.style.display = "block";
              listEl.style.display = "none";
              loadMoreWrap.style.display = "none";
              countHint.textContent = "已撤销";
              listEl.innerHTML = "";
            } else {
              var hasMore = totalCount != null ? recordsLoaded.length < totalCount : recordsLoaded.length >= pageSize;
              loadMoreWrap.style.display = hasMore ? "block" : "none";
              if (cardEl && cardEl.parentNode) cardEl.remove();
            }
            setTimeout(function () {
              countHint.style.color = "";
              countHint.textContent = recordsLoaded.length > 0
                ? (totalCount != null ? "共 " + totalCount + " 条，已加载 " + recordsLoaded.length + " 条" : "已加载 " + recordsLoaded.length + " 条")
                : "";
            }, 2000);
          })
          .catch(function () {
            alert("网络异常，请稍后重试");
            if (btn) btn.disabled = false;
          });
      }

      function showList(records, total) {
        loadingEl.style.display = "none";
        errorEl.style.display = "none";
        recordsLoaded = records || [];
        totalCount = total != null ? total : recordsLoaded.length;
        if (!recordsLoaded.length) {
          emptyEl.style.display = "block";
          listEl.style.display = "none";
          loadMoreWrap.style.display = "none";
          countHint.textContent = "";
          return;
        }
        emptyEl.style.display = "none";
        listEl.style.display = "flex";
        if (totalCount != null) {
          countHint.textContent = "共 " + totalCount + " 条，已加载 " + recordsLoaded.length + " 条";
        } else {
          countHint.textContent = "已加载 " + recordsLoaded.length + " 条";
        }
        renderRecordCards(recordsLoaded);
        var hasMore = totalCount != null ? recordsLoaded.length < totalCount : recordsLoaded.length >= pageSize;
        loadMoreWrap.style.display = hasMore ? "block" : "none";
      }

      function showError(msg, showLoginLink) {
        loadingEl.style.display = "none";
        listEl.style.display = "none";
        loadMoreWrap.style.display = "none";
        emptyEl.style.display = "none";
        errorEl.style.display = "block";
        if (showLoginLink) {
          errorEl.innerHTML = "<p>" + escapeHtml(msg) + "</p><p><a href=\"/h5/scan\" class=\"error-login-link\">前往登记页登录</a></p>";
        } else {
          errorEl.textContent = msg;
        }
        countHint.textContent = "";
      }

      function getFilterParams() {
        var dateFrom = document.getElementById("filter-date-from");
        var dateTo = document.getElementById("filter-date-to");
        var bed = document.getElementById("filter-bed");
        var device = document.getElementById("filter-device");
        var parts = [];
        if (dateFrom && dateFrom.value) parts.push("registration_date_from=" + encodeURIComponent(dateFrom.value));
        if (dateTo && dateTo.value) parts.push("registration_date_to=" + encodeURIComponent(dateTo.value));
        if (bed && bed.value.trim()) parts.push("bed_number=" + encodeURIComponent(bed.value.trim()));
        if (device && device.value.trim()) parts.push("device_code=" + encodeURIComponent(device.value.trim()));
        return parts.join("&");
      }
      function buildListParams(offset) {
        var params = "limit=" + pageSize + "&offset=" + offset + "&include_deleted=true";
        var filter = getFilterParams();
        if (filter) params += "&" + filter;
        return params;
      }

      function loadRecords(append) {
        if (!append) showLoading();
        var offset = append ? recordsLoaded.length : 0;
        var listUrl = "/api/usage?" + buildListParams(offset);
        if (append) {
          btnLoadMore.disabled = true;
          btnLoadMore.textContent = "加载中...";
        }
        fetch(listUrl, { headers: authHeaders() })
          .then(function (res) {
            if (res.status === 401) {
              try { localStorage.removeItem("device_scan_token"); } catch (e) {}
              showError("请先登录后查看记录", true);
              return Promise.reject(new Error("未登录"));
            }
            if (!res.ok) throw new Error("加载失败");
            return res.json();
          })
          .then(function (data) {
            if (append) {
              btnLoadMore.disabled = false;
              btnLoadMore.textContent = "加载更多";
            }
            if (!data || !Array.isArray(data)) return;
            var nextList = append ? recordsLoaded.concat(data) : data;
            if (!append) {
              var countUrl = "/api/usage/count?include_deleted=true";
              var fp = getFilterParams();
              if (fp) countUrl += "&" + fp;
              fetch(countUrl, { headers: authHeaders() })
                .then(function (r) { return r.ok ? r.json() : null; })
                .catch(function () { return null; })
                .then(function (o) {
                  var total = (o && typeof o.total === "number") ? o.total : (data.length >= pageSize ? data.length + 1 : data.length);
                  showList(nextList, total);
                });
            } else {
              var effectiveTotal = data.length < pageSize ? nextList.length : totalCount;
              showList(nextList, effectiveTotal);
            }
          })
          .catch(function (e) {
            if (append) {
              btnLoadMore.disabled = false;
              btnLoadMore.textContent = "加载更多";
            }
            if (e.message !== "未登录") showError(e.message || "加载失败，请稍后重试");
          });
      }

      function loadMore() {
        if (recordsLoaded.length < pageSize && totalCount !== null) return;
        loadRecords(true);
      }

      btnRefresh.addEventListener("click", function () { loadRecords(false); });
      var btnApply = document.getElementById("btn-apply");
      if (btnApply) btnApply.addEventListener("click", function () { loadRecords(false); });
      if (btnLoadMore) btnLoadMore.addEventListener("click", loadMore);
      var undoConfirmOk = document.getElementById("undo-confirm-ok");
      var undoConfirmCancel = document.getElementById("undo-confirm-cancel");
      if (undoConfirmOk) undoConfirmOk.addEventListener("click", doUndoRequest);
      if (undoConfirmCancel) undoConfirmCancel.addEventListener("click", function () {
        document.getElementById("undo-confirm-wrap").style.display = "none";
        undoPendingId = null;
        undoPendingCard = null;
      });
      loadRecords(false);
    </script>
  </body>
</html>
