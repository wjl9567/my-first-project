<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>è®¾å¤‡ä½¿ç”¨ç™»è®°</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta name="theme-color" content="#0f766e" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <style>
      /* ä¸åå°ç»Ÿä¸€ï¼šä¸»è‰²ã€åœ†è§’ã€é˜´å½± */
      * { box-sizing: border-box; }
      :root {
        --primary: #0d9488;
        --primary-dark: #0f766e;
        --primary-tint: #ccfbf1;
        --surface: #ffffff;
        --border: #e2e8f0;
        --text: #334155;
        --text-muted: #64748b;
        --radius: 12px;
        --touch-min: 44px;
        --safe-bottom: env(safe-area-inset-bottom, 0px);
        --safe-top: env(safe-area-inset-top, 0px);
        --shadow: 0 2px 8px rgba(13, 148, 136, 0.06);
      }
      body {
        font-family: "PingFang SC", "Microsoft YaHei", -apple-system, BlinkMacSystemFont, sans-serif;
        margin: 0;
        padding: 16px 16px calc(60px + var(--safe-bottom));
        padding-top: calc(12px + var(--safe-top));
        min-height: 100vh;
        min-height: -webkit-fill-available;
        background: linear-gradient(180deg, #f0fdfa 0%, #e0f2fe 38%, #f0f9ff 100%);
        font-size: 16px;
        color: var(--text);
        -webkit-tap-highlight-color: transparent;
      }
      .page-header {
        text-align: center;
        margin-bottom: 24px;
      }
      .page-header h1 {
        font-size: 20px;
        font-weight: 600;
        margin: 0 0 6px;
        color: var(--primary-dark);
      }
      .page-header .sub {
        font-size: 14px;
        color: var(--text-muted);
        line-height: 1.6;
      }
      .page-header .sub .step-current { color: var(--primary-dark); font-weight: 700; }
      .page-header .sub .step-next { color: #94a3b8; font-weight: 400; }
      .dev-login-hint {
        margin: 0 16px 12px;
        padding: 10px 12px;
        font-size: 12px;
        color: var(--text-muted);
        background: #f1f5f9;
        border-radius: 8px;
      }
      .dev-login-hint a { color: var(--primary); font-weight: 500; }
      .card {
        max-width: 420px;
        margin: 0 auto;
        background: var(--surface);
        border-radius: 16px;
        box-shadow: var(--shadow);
        padding: 24px 20px 28px;
        border: 1px solid var(--border);
      }
      /* æ‰«ä¸€æ‰« + è¾“å…¥ ä¸¤ç§æ–¹å¼ */
      .device-entry {
        margin-bottom: 20px;
      }
      .device-entry .label {
        font-size: 14px;
        color: #475569;
        margin-bottom: 10px;
        font-weight: 500;
      }
      .btn-scan {
        width: 100%;
        min-height: 56px;
        margin-bottom: 20px;
        padding: 16px 24px;
        border-radius: var(--radius);
        border: none;
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: #fff;
        font-size: 18px;
        font-weight: 700;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        box-shadow: 0 4px 14px rgba(13, 148, 136, 0.35);
        -webkit-tap-highlight-color: transparent;
        transition: transform 0.15s ease, box-shadow 0.2s ease, filter 0.15s ease;
      }
      .btn-scan:hover { box-shadow: 0 6px 18px rgba(13, 148, 136, 0.4); }
      .btn-scan:active {
        transform: scale(0.98);
        filter: brightness(0.92);
      }
      .btn-scan svg {
        width: 26px;
        height: 26px;
        fill: currentColor;
      }
      .divider {
        text-align: center;
        margin: 16px 0;
        font-size: 13px;
        color: #94a3b8;
      }
      .device-input-row {
        display: flex;
        gap: 10px;
      }
      .device-code-error {
        font-size: 14px;
        color: #dc2626;
        margin-top: 6px;
        line-height: 1.4;
      }
      .device-input-row input {
        flex: 1;
        min-height: var(--touch-min);
        padding: 12px 16px;
        border-radius: var(--radius);
        border: 2px solid var(--border);
        font-size: 16px;
        -webkit-appearance: none;
        appearance: none;
      }
      .device-input-row input::placeholder { color: #94a3b8; }
      .device-input-row input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.12);
      }
      .device-input-row button {
        min-height: var(--touch-min);
        min-width: 76px;
        padding: 0 20px;
        border-radius: var(--radius);
        border: none;
        background: #94a3b8;
        color: #fff;
        font-size: 16px;
        font-weight: 600;
        cursor: not-allowed;
        transition: background 0.2s, cursor 0.2s;
      }
      .device-input-row button:not(:disabled) {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        cursor: pointer;
      }
      .device-input-row button:not(:disabled):active { filter: brightness(0.95); }
      .device-input-row button:disabled {
        cursor: not-allowed;
      }
      /* è®¾å¤‡ä¿¡æ¯å—ï¼šé»˜è®¤æµ…ç°æç¤º / é”™è¯¯æ—¶çº¢åº• */
      .device-info {
        background: #f1f5f9;
        border-radius: var(--radius);
        padding: 14px 16px;
        margin-bottom: 14px;
        font-size: 15px;
        color: var(--text-muted);
        border-left: 4px solid #e2e8f0;
        font-weight: 400;
      }
      .device-info.loading { color: var(--text-muted); }
      .device-info.error {
        background: #fef2f2;
        border-left-color: #dc2626;
        color: #991b1b;
        font-weight: 500;
      }
      .change-device {
        display: inline-block;
        margin-top: 6px;
        padding: 6px 0;
        min-height: var(--touch-min);
        line-height: 1.4;
        font-size: 14px;
        color: var(--teal-600);
        cursor: pointer;
        background: none;
        border: none;
        text-decoration: underline;
      }
      .form-section {
        margin-top: 24px;
        padding-top: 24px;
        border-top: 1px solid var(--border);
      }
      .field {
        margin-bottom: 16px;
      }
      .field label {
        display: block;
        margin-bottom: 6px;
        font-size: 14px;
        color: var(--text);
        font-weight: 500;
      }
      .field.required label::before {
        content: "* ";
        color: #dc2626;
      }
      .field.optional label::after {
        content: "ï¼ˆé€‰å¡«ï¼‰";
        font-weight: 400;
        color: var(--text-muted);
      }
      .field-hidden { display: none !important; }
      .field input,
      .field select,
      .field textarea {
        width: 100%;
        min-height: var(--touch-min);
        padding: 12px 14px;
        border-radius: var(--radius);
        border: 1px solid var(--border);
        font-size: 17px;
        -webkit-appearance: none;
        appearance: none;
      }
      .field textarea {
        min-height: 88px;
        resize: vertical;
      }
      .field input:focus,
      .field select:focus,
      .field textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.12);
      }
      .time-field-inline .time-block {
        display: flex;
        flex-wrap: wrap;
        gap: 12px 20px;
        align-items: center;
      }
      .time-group {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 10px 14px;
        background: var(--bg-page, #f8fafc);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        min-height: var(--touch-min);
      }
      .time-group-label {
        font-weight: 500;
        color: var(--text);
        white-space: nowrap;
        margin-right: 4px;
        font-size: 15px;
      }
      .time-group select {
        width: auto;
        min-width: 56px;
        padding: 8px 10px;
        font-size: 16px;
        border-radius: 8px;
        border: 1px solid var(--border);
        background: #fff;
        -webkit-appearance: none;
        appearance: none;
        cursor: pointer;
      }
      .time-group select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 2px rgba(13, 148, 136, 0.15);
      }
      .time-sep {
        font-weight: 600;
        color: var(--text-muted);
        font-size: 16px;
        line-height: 1;
      }
      .required-star { color: #dc2626; margin-right: 2px; }
      /* è®¾å¤‡çŠ¶å†µ/æ—¥å¸¸ä¿å…»ï¼šå•é€‰é¢˜æ ·å¼ï¼Œé€‰ä¸­é¡¹å‰æ˜¾ç¤ºæ‰“é’© âˆš */
      .radio-group {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        min-height: var(--touch-min);
        align-items: center;
      }
      .radio-label {
        position: relative;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        font-weight: 400;
        cursor: pointer;
        -webkit-tap-highlight-color: transparent;
        padding: 12px 16px;
        border-radius: var(--radius);
        border: 2px solid #d9d9d9;
        background: #fff;
        transition: border-color 0.2s, background 0.2s, color 0.2s;
      }
      .radio-label input[type="radio"] {
        position: absolute;
        width: 100%;
        height: 100%;
        margin: 0;
        opacity: 0;
        cursor: pointer;
      }
      .radio-label .radio-visual {
        width: 20px;
        height: 20px;
        min-width: 20px;
        min-height: 20px;
        border: 2px solid #d9d9d9;
        border-radius: 4px;
        background: #fff;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: 700;
        color: transparent;
        transition: border-color 0.2s, background 0.2s, color 0.2s;
      }
      .radio-label:has(input:checked) {
        border-color: #1677ff;
        background: #e6f7ff;
        color: #1677ff;
        font-weight: 600;
      }
      .radio-label:has(input:checked) .radio-visual {
        border-color: #1677ff;
        background: #1677ff;
        color: #fff;
      }
      .radio-label:has(input:checked) .radio-visual::before {
        content: "âœ“";
      }
      .btn-submit {
        width: 100%;
        min-height: 52px;
        margin-top: 24px;
        padding: 14px;
        border-radius: var(--radius);
        border: none;
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: #fff;
        font-size: 18px;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(13, 148, 136, 0.25);
      }
      .btn-submit:active:not(:disabled) { transform: scale(0.98); }
      .btn-submit:disabled {
        background: #94a3b8;
        box-shadow: none;
        cursor: not-allowed;
      }
      .status { margin-top: 12px; font-size: 14px; text-align: center; min-height: 20px; }
      .status.error { color: #dc2626; font-weight: 500; }
      /* æˆåŠŸé¢æ¿ */
      .success-panel {
        margin-top: 24px;
        padding: 24px 16px;
        background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
        border: 2px solid #6ee7b7;
        border-radius: 16px;
        text-align: center;
      }
      .success-panel h3 {
        margin: 0 0 8px;
        font-size: 20px;
        color: #065f46;
      }
      .success-panel .success-hint {
        margin: 0 0 20px;
        font-size: 14px;
        color: #047857;
        line-height: 1.5;
      }
      .success-panel .actions {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .success-panel .actions button {
        min-height: var(--touch-min);
        padding: 12px 20px;
        border-radius: var(--radius);
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        border: none;
      }
      .success-panel .btn-next {
        background: var(--surface);
        color: var(--primary-dark);
        border: 2px solid var(--primary);
      }
      /* åº•éƒ¨å¯¼èˆªï¼šä¸ my_records ä¸€è‡´ */
      .bottom-nav {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        height: calc(56px + var(--safe-bottom));
        padding-bottom: var(--safe-bottom);
        background: var(--surface);
        border-top: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0;
        box-shadow: 0 -2px 12px rgba(0, 0, 0, 0.06);
        z-index: 100;
      }
      .bottom-nav a {
        flex: 1;
        max-width: 180px;
        min-height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        font-size: 15px;
        font-weight: 600;
        color: var(--text-muted);
        text-decoration: none;
        -webkit-tap-highlight-color: transparent;
      }
      .bottom-nav a.active {
        color: var(--primary-dark);
      }
      .bottom-nav a:active { opacity: 0.8; }
      .page-version {
        text-align: center;
        margin-top: 20px;
        font-size: 12px;
        color: var(--text-muted);
      }

      /* æ‰«ä¸€æ‰« å…¨å±é®ç½© */
      .scan-overlay {
        position: fixed;
        left: 0;
        top: 0;
        right: 0;
        bottom: 0;
        background: #000;
        z-index: 1000;
        display: none;
        flex-direction: column;
        padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
      }
      .scan-overlay.active { display: flex; }
      .scan-overlay .scan-header {
        flex-shrink: 0;
        padding: 16px;
        background: rgba(0,0,0,0.6);
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .scan-overlay .scan-header h2 { margin: 0; font-size: 18px; }
      .scan-overlay .scan-cancel {
        min-height: 44px;
        padding: 0 20px;
        border: none;
        background: transparent;
        color: #fff;
        font-size: 16px;
        cursor: pointer;
        text-decoration: underline;
      }
      .scan-overlay .scan-body {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        min-height: 200px;
      }
      .scan-overlay video {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .scan-overlay canvas {
        position: absolute;
        left: -9999px;
      }
      .scan-overlay .scan-frame {
        position: relative;
        z-index: 2;
        width: 260px;
        height: 260px;
        border: 3px solid rgba(13, 148, 136, 0.9);
        border-radius: 16px;
        box-shadow: 0 0 0 9999px rgba(0,0,0,0.5);
      }
      .scan-overlay .scan-hint {
        position: absolute;
        bottom: 24px;
        left: 20px;
        right: 20px;
        text-align: center;
        color: rgba(255,255,255,0.9);
        font-size: 14px;
      }
      .scan-overlay .scan-error {
        padding: 20px;
        text-align: center;
        color: #fca5a5;
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <div class="page-header">
      <h1>è®¾å¤‡ä½¿ç”¨ç»´æŠ¤ç™»è®°</h1>
      <p class="sub"><span class="step-current">æ‰«ä¸€æ‰«æˆ–è¾“å…¥è®¾å¤‡ç¼–å·</span><span class="step-next"> â†’ å¡«å†™ç™»è®°ä¿¡æ¯ â†’ æäº¤</span></p>
    </div>
    <div id="dev-login-hint" class="dev-login-hint" style="display:none;">
      å¼€å‘ç¯å¢ƒï¼šè¯·å…ˆåœ¨ <a href="/admin">åå°</a> ä½¿ç”¨ç®¡ç†å‘˜è´¦å·ç™»å½•ï¼ˆéœ€åœ¨ backend ç›®å½• .env ä¸­é…ç½® ADMIN_USERNAMEã€ADMIN_PASSWORDï¼‰ï¼ŒåŒä¸€æµè§ˆå™¨å†åˆ·æ–°æœ¬é¡µå³å¯ç™»è®°ã€‚
    </div>

    <div class="card">
      <div class="device-entry">
        <button type="button" id="btn-scan" class="btn-scan">
          <svg viewBox="0 0 24 24"><path d="M4 6h2v12H4V6zm14 0h2v12h-2V6zM2 4v16h4V4H2zm6 0v16h8V4H8zm10 0v16h4V4h-4z"/></svg>
          æ‰«ä¸€æ‰«
        </button>
        <p class="divider">æˆ– è¾“å…¥è®¾å¤‡ç¼–å·</p>
        <div class="device-input-row">
          <input
            id="device-code-input"
            type="text"
            placeholder="è¯·è¾“å…¥è®¾å¤‡ç¼–å·åæŸ¥è¯¢"
            autocomplete="off"
            inputmode="text"
            enterkeyhint="go"
          />
          <button type="button" id="btn-query-device" disabled>æŸ¥è¯¢</button>
        </div>
        <div id="device-code-error" class="device-code-error" style="display:none;" role="alert"></div>
      </div>

      <div class="device-info" id="device-info">ğŸ’¡ è¯·ç‚¹å‡»ã€Œæ‰«ä¸€æ‰«ã€æˆ–è¾“å…¥è®¾å¤‡ç¼–å·å¼€å§‹ç™»è®°</div>
      <button type="button" class="change-device" id="change-device" style="display:none;">æ›´æ¢è®¾å¤‡</button>

      <div class="form-section" id="form-section" style="display:none;">
        <div class="field required">
          <label>æ“ä½œç±»å‹</label>
          <select id="usage_type" aria-label="æ“ä½œç±»å‹"></select>
        </div>
        <div class="field required">
          <label>ç™»è®°æ—¥æœŸ</label>
          <input id="registration_date" type="date" />
        </div>
        <div class="field optional">
          <label>åºŠå·</label>
          <input id="bed_number" type="text" placeholder="é€‰å¡«" maxlength="32" />
        </div>
        <div class="field optional">
          <label>ID å·</label>
          <input id="id_number" type="text" placeholder="é€‰å¡«" maxlength="64" />
        </div>
        <div class="field optional">
          <label>å§“å</label>
          <input id="patient_name" type="text" placeholder="é€‰å¡«" maxlength="64" />
        </div>
        <div class="field required time-field-inline">
          <div class="time-block">
            <div class="time-group">
              <span class="time-group-label"><span class="required-star">*</span>å¼€æœºæ—¶é—´</span>
              <select id="power_on_hour" aria-label="å¼€æœºæ—¶"></select>
              <span class="time-sep">:</span>
              <select id="power_on_minute" aria-label="å¼€æœºåˆ†"></select>
            </div>
            <div class="time-group">
              <span class="time-group-label"><span class="required-star">*</span>å…³æœºæ—¶é—´</span>
              <select id="power_off_hour" aria-label="å…³æœºæ—¶"></select>
              <span class="time-sep">:</span>
              <select id="power_off_minute" aria-label="å…³æœºåˆ†"></select>
            </div>
          </div>
        </div>
        <div class="field">
          <label><span class="required-star">*</span>è®¾å¤‡çŠ¶å†µ</label>
          <div class="radio-group">
            <label class="radio-label">
              <input type="radio" name="equipment_condition" value="normal" checked />
              <span class="radio-visual" aria-hidden="true"></span>
              <span class="radio-text">æ­£å¸¸</span>
            </label>
            <label class="radio-label">
              <input type="radio" name="equipment_condition" value="abnormal" />
              <span class="radio-visual" aria-hidden="true"></span>
              <span class="radio-text">å¼‚å¸¸</span>
            </label>
          </div>
        </div>
        <div class="field">
          <label><span class="required-star">*</span>æ—¥å¸¸ä¿å…»</label>
          <div class="radio-group">
            <label class="radio-label">
              <input type="radio" name="daily_maintenance" value="clean" checked />
              <span class="radio-visual" aria-hidden="true"></span>
              <span class="radio-text">æ¸…æ´</span>
            </label>
            <label class="radio-label">
              <input type="radio" name="daily_maintenance" value="disinfect" />
              <span class="radio-visual" aria-hidden="true"></span>
              <span class="radio-text">æ¶ˆæ¯’</span>
            </label>
          </div>
        </div>
        <div class="field optional">
          <label>ç»ˆæœ«æ¶ˆæ¯’</label>
          <textarea id="terminal_disinfection" rows="2" maxlength="500" placeholder="é€‰å¡«ï¼Œå¯å¡«å†™ç»ˆæœ«æ¶ˆæ¯’å¤‡æ³¨"></textarea>
        </div>

        <button type="button" id="submit-btn" class="btn-submit">æäº¤ç™»è®°</button>
        <div class="status" id="status"></div>
      </div>

      <div class="success-panel" id="success-panel" style="display:none;">
        <h3>ç™»è®°æˆåŠŸ</h3>
        <p class="success-hint">æœ¬å°è®¾å¤‡ä½¿ç”¨ç»´æŠ¤ç™»è®°å·²ä¿å­˜ï¼Œå¯ç»§ç»­ç™»è®°ä¸‹ä¸€å°ã€‚</p>
        <div class="actions">
          <button type="button" class="btn-next" id="btn-next-device">ç™»è®°ä¸‹ä¸€å°</button>
        </div>
      </div>
    </div>

    <!-- æ‰«ä¸€æ‰« å…¨å±å±‚ -->
    <div class="scan-overlay" id="scan-overlay">
      <div class="scan-header">
        <h2>æ‰«ä¸€æ‰«</h2>
        <button type="button" class="scan-cancel" id="scan-cancel">å–æ¶ˆ</button>
      </div>
      <div class="scan-body">
        <video id="scan-video" playsinline muted></video>
        <canvas id="scan-canvas"></canvas>
        <div class="scan-frame"></div>
        <p class="scan-hint">å°†è®¾å¤‡äºŒç»´ç æ”¾å…¥æ¡†å†…</p>
      </div>
      <div class="scan-error" id="scan-error" style="display:none;"></div>
    </div>

    <div class="page-version">ç‰ˆæœ¬ v{{ app_version }}</div>

    <nav class="bottom-nav" aria-label="ä¸»å¯¼èˆª">
      <a href="/h5/scan" class="active">ç™»è®°</a>
      <a href="/h5/my-records">æˆ‘çš„è®°å½•</a>
    </nav>

    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script>
      (function () {
        const hash = location.hash.slice(1);
        const q = new URLSearchParams(location.search);
        const token = new URLSearchParams(hash).get("token") || q.get("token");
        if (token) {
          try { localStorage.setItem("device_scan_token", token); } catch (e) {}
          if (q.get("token")) {
            q.delete("token");
            const s = q.toString();
            history.replaceState(null, "", location.pathname + (s ? "?" + s : "") + location.hash);
          }
        }
      })();
      (function () {
        try {
          if (!localStorage.getItem("device_scan_token") && (location.hostname === "localhost" || location.hostname === "127.0.0.1")) {
            var h = document.getElementById("dev-login-hint");
            if (h) h.style.display = "block";
          }
        } catch (e) {}
      })();
      function authHeaders() {
        try {
          const t = localStorage.getItem("device_scan_token");
          return t ? { "Authorization": "Bearer " + t } : {};
        } catch (e) { return {}; }
      }

      const deviceIdFromUrl = new URLSearchParams(location.search).get("device_id");
      const deviceCodeFromUrl = new URLSearchParams(location.search).get("device_code");
      const deviceCodeInput = document.getElementById("device-code-input");
      const deviceCodeErrorEl = document.getElementById("device-code-error");
      const btnQueryDevice = document.getElementById("btn-query-device");
      const btnScan = document.getElementById("btn-scan");
      const deviceInfoEl = document.getElementById("device-info");
      const changeDeviceBtn = document.getElementById("change-device");
      const formSection = document.getElementById("form-section");
      const statusEl = document.getElementById("status");
      const submitBtn = document.getElementById("submit-btn");
      const successPanel = document.getElementById("success-panel");
      const btnNextDevice = document.getElementById("btn-next-device");
      const scanOverlay = document.getElementById("scan-overlay");
      const scanVideo = document.getElementById("scan-video");
      const scanCanvas = document.getElementById("scan-canvas");
      const scanCancel = document.getElementById("scan-cancel");
      const scanErrorEl = document.getElementById("scan-error");
      const registrationDateEl = document.getElementById("registration_date");
      const bedNumberEl = document.getElementById("bed_number");
      const idNumberEl = document.getElementById("id_number");
      const patientNameEl = document.getElementById("patient_name");
      const powerOnHourEl = document.getElementById("power_on_hour");
      const powerOnMinuteEl = document.getElementById("power_on_minute");
      const powerOffHourEl = document.getElementById("power_off_hour");
      const powerOffMinuteEl = document.getElementById("power_off_minute");
      const terminalDisinfectionEl = document.getElementById("terminal_disinfection");
      const usageTypeEl = document.getElementById("usage_type");

      var DEVICE_CODE_ERROR_MSG = "è¯¥è®¾å¤‡ç¼–ç ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤ï¼Œè¯·æ ¸å¯¹åé‡æ–°è¾“å…¥/æ‰«æ";

      function showDeviceCodeError(msg) {
        deviceCodeErrorEl.textContent = msg || "";
        deviceCodeErrorEl.style.display = msg ? "block" : "none";
      }

      function _setUsageTypeOptions(list) {
        if (!usageTypeEl) return;
        var items = (Array.isArray(list) && list.length) ? list : [
          { code: "1", label: "å¸¸è§„ä½¿ç”¨" },
          { code: "2", label: "å€Ÿç”¨" },
          { code: "3", label: "ç»´ä¿®/æ•…éšœ" },
          { code: "4", label: "æ ¡å‡†/è´¨æ§" },
          { code: "5", label: "å…¶ä»–" },
        ];
        usageTypeEl.innerHTML = "";
        var ph = document.createElement("option");
        ph.value = "";
        ph.textContent = "è¯·é€‰æ‹©æ“ä½œç±»å‹";
        usageTypeEl.appendChild(ph);
        items.forEach(function (it) {
          if (!it) return;
          var code = (it.code === 0 || it.code) ? String(it.code) : "";
          var label = (it.label === 0 || it.label) ? String(it.label) : code;
          if (!code) return;
          var opt = document.createElement("option");
          opt.value = code;
          opt.textContent = label;
          usageTypeEl.appendChild(opt);
        });
        // åªæœ‰ä¸€ä¸ªå¯é€‰é¡¹æ—¶è‡ªåŠ¨é€‰ä¸­ï¼Œå‡å°‘æ— æ„ä¹‰é€‰æ‹©
        if (usageTypeEl.options.length === 2) usageTypeEl.value = usageTypeEl.options[1].value;
      }

      function loadUsageTypeOptions() {
        if (!usageTypeEl) return;
        // å…ˆæ¸²æŸ“å ä½ï¼Œé¿å…ç©ºç™½
        usageTypeEl.innerHTML = "<option value=\"\">è¯·é€‰æ‹©æ“ä½œç±»å‹</option>";
        fetch("/api/dict?dict_type=usage_type")
          .then(function (r) { return r.ok ? r.json() : null; })
          .then(function (data) { _setUsageTypeOptions(data); })
          .catch(function () { _setUsageTypeOptions(null); });
      }

      function fillTimeSelects() {
        var i;
        function fillHour(sel) {
          if (!sel) return;
          sel.innerHTML = "";
          for (i = 0; i < 24; i++) {
            var opt = document.createElement("option");
            opt.value = String(i).padStart(2, "0");
            opt.textContent = opt.value;
            sel.appendChild(opt);
          }
        }
        function fillMinute(sel) {
          if (!sel) return;
          sel.innerHTML = "";
          for (i = 0; i < 60; i++) {
            var opt = document.createElement("option");
            opt.value = String(i).padStart(2, "0");
            opt.textContent = opt.value;
            sel.appendChild(opt);
          }
        }
        fillHour(powerOnHourEl);
        fillMinute(powerOnMinuteEl);
        fillHour(powerOffHourEl);
        fillMinute(powerOffMinuteEl);
      }
      function setDefaultDateAndTime() {
        var d = new Date();
        var dateStr = d.getFullYear() + "-" + String(d.getMonth() + 1).padStart(2, "0") + "-" + String(d.getDate()).padStart(2, "0");
        if (registrationDateEl && !registrationDateEl.value) registrationDateEl.value = dateStr;
        if (powerOnHourEl) powerOnHourEl.value = "08";
        if (powerOnMinuteEl) powerOnMinuteEl.value = "00";
        if (powerOffHourEl) powerOffHourEl.value = "18";
        if (powerOffMinuteEl) powerOffMinuteEl.value = "00";
      }
      function clearFormDataExceptDeviceCode() {
        if (usageTypeEl) usageTypeEl.value = "";
        if (registrationDateEl) registrationDateEl.value = "";
        if (bedNumberEl) bedNumberEl.value = "";
        if (idNumberEl) idNumberEl.value = "";
        if (patientNameEl) patientNameEl.value = "";
        if (powerOnHourEl) powerOnHourEl.value = "08";
        if (powerOnMinuteEl) powerOnMinuteEl.value = "00";
        if (powerOffHourEl) powerOffHourEl.value = "18";
        if (powerOffMinuteEl) powerOffMinuteEl.value = "00";
        if (terminalDisinfectionEl) terminalDisinfectionEl.value = "";
        var radios = document.querySelectorAll("input[name='equipment_condition']");
        if (radios.length) radios[0].checked = true;
        radios = document.querySelectorAll("input[name='daily_maintenance']");
        if (radios.length) radios[0].checked = true;
        setDefaultDateAndTime();
      }

      function setValidationInvalid() {
        device = null;
        successPanel.style.display = "none";
        showDeviceCodeError(DEVICE_CODE_ERROR_MSG);
        clearFormDataExceptDeviceCode();
        deviceCodeInput.focus();
        submitBtn.disabled = true;
        formSection.style.display = "none";
        changeDeviceBtn.style.display = "none";
        deviceInfoEl.textContent = TIP_DEFAULT;
        deviceInfoEl.className = "device-info";
        updateQueryButtonState();
      }

      function setValidationValid() {
        showDeviceCodeError("");
        submitBtn.disabled = false;
      }

      let device = null;
      let scanStream = null;
      let scanAnimationId = null;

      var TIP_DEFAULT = "ğŸ’¡ è¯·ç‚¹å‡»ã€Œæ‰«ä¸€æ‰«ã€æˆ–è¾“å…¥è®¾å¤‡ç¼–å·å¼€å§‹ç™»è®°";
      function showDeviceState(msg, isError) {
        deviceInfoEl.textContent = isError ? "âŒ " + msg : msg;
        deviceInfoEl.className = "device-info" + (isError ? " error" : "");
      }
      function updateQueryButtonState() {
        var val = (deviceCodeInput && deviceCodeInput.value || "").trim();
        if (btnQueryDevice) btnQueryDevice.disabled = !val;
      }

      function setDeviceLoaded(d) {
        successPanel.style.display = "none";
        device = d;
        deviceCodeInput.value = d.device_code;
        deviceInfoEl.textContent = d.name + "ï¼ˆ" + d.device_code + "ï¼‰ â€” " + (d.dept || "æœªåˆ†é…ç§‘å®¤");
        deviceInfoEl.className = "device-info";
        changeDeviceBtn.style.display = "block";
        formSection.style.display = "block";
        setDefaultDateAndTime();
        setValidationValid();
        updateQueryButtonState();
      }

      function setDeviceCleared() {
        device = null;
        deviceCodeInput.value = "";
        showDeviceCodeError("");
        successPanel.style.display = "none";
        deviceCodeInput.focus();
        deviceInfoEl.textContent = TIP_DEFAULT;
        deviceInfoEl.className = "device-info";
        changeDeviceBtn.style.display = "none";
        formSection.style.display = "none";
        submitBtn.disabled = true;
        updateQueryButtonState();
      }

      async function loadDeviceById(id) {
        successPanel.style.display = "none";
        showDeviceState("æ­£åœ¨åŠ è½½...", false);
        deviceInfoEl.classList.add("loading");
        showDeviceCodeError("");
        try {
          const res = await fetch("/api/devices/" + id, { headers: authHeaders() });
          if (!res.ok) throw new Error("è®¾å¤‡ä¸å­˜åœ¨æˆ–å·²åœç”¨");
          setDeviceLoaded(await res.json());
        } catch (e) {
          setValidationInvalid();
        }
        deviceInfoEl.classList.remove("loading");
      }

      async function loadDeviceByCode(code) {
        successPanel.style.display = "none";
        const trimmed = (code || "").trim();
        if (!trimmed) {
          showDeviceState("è¯·è¾“å…¥è®¾å¤‡ç¼–å·", true);
          showDeviceCodeError("");
          return;
        }
        deviceCodeInput.value = trimmed;
        showDeviceState("æ­£åœ¨æŸ¥è¯¢...", false);
        deviceInfoEl.classList.add("loading");
        showDeviceCodeError("");
        try {
          const res = await fetch("/api/devices?q=" + encodeURIComponent(trimmed), { headers: authHeaders() });
          if (!res.ok) throw new Error("æŸ¥è¯¢å¤±è´¥");
          const list = await res.json();
          const found = list.find(function (d) { return d.device_code === trimmed; });
          if (!found) {
            setValidationInvalid();
            deviceInfoEl.classList.remove("loading");
            return;
          }
          setDeviceLoaded(found);
        } catch (e) {
          setValidationInvalid();
        }
        deviceInfoEl.classList.remove("loading");
      }

      function onQueryDevice() {
        if (device) return;
        loadDeviceByCode(deviceCodeInput.value);
      }

      /* è§£ææ‰«ç ç»“æœï¼šURL ä¸­ device_id= / device_code=ï¼Œæˆ–çº¯è®¾å¤‡ç¼–å· */
      function parseScanResult(raw) {
        if (!raw || typeof raw !== "string") return null;
        var s = raw.trim();
        if (!s) return null;
        try {
          var u;
          if (/^https?:\/\//i.test(s)) u = new URL(s);
          else if (s.indexOf("/") === 0) u = new URL(s, location.origin);
          else if (s.indexOf("?") !== -1) u = new URL(s, location.origin + "/");
          else return { type: "code", value: s };
          var id = u.searchParams.get("device_id");
          if (id && /^\d+$/.test(id)) return { type: "id", value: parseInt(id, 10) };
          var code = u.searchParams.get("device_code");
          if (code) return { type: "code", value: code.trim() };
        } catch (e) {}
        return { type: "code", value: s };
      }

      function onScanSuccess(rawString) {
        var parsed = parseScanResult(rawString);
        if (!parsed) return;
        stopScan();
        if (parsed.type === "id") loadDeviceById(parsed.value);
        else loadDeviceByCode(parsed.value);
      }

      function stopScan() {
        if (scanAnimationId) {
          cancelAnimationFrame(scanAnimationId);
          scanAnimationId = null;
        }
        if (scanStream && scanStream.getTracks) {
          scanStream.getTracks().forEach(function (t) { t.stop(); });
          scanStream = null;
        }
        scanVideo.srcObject = null;
        scanOverlay.classList.remove("active");
        scanErrorEl.style.display = "none";
      }

      function startScan() {
        if (device) return;
        scanErrorEl.style.display = "none";
        scanOverlay.classList.add("active");
        var canvas = scanCanvas;
        var ctx = canvas.getContext("2d");
        var video = scanVideo;

        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
          .then(function (stream) {
            scanStream = stream;
            video.srcObject = stream;
            video.setAttribute("playsinline", true);
            video.play();
            function tick() {
              if (!scanOverlay.classList.contains("active")) return;
              if (video.readyState === video.HAVE_ENOUGH_DATA) {
                canvas.height = video.videoHeight;
                canvas.width = video.videoWidth;
                ctx.drawImage(video, 0, 0);
                var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                if (typeof jsQR !== "undefined") {
                  var code = jsQR(imageData.data, imageData.width, imageData.height);
                  if (code && code.data) {
                    onScanSuccess(code.data);
                    return;
                  }
                }
              }
              scanAnimationId = requestAnimationFrame(tick);
            }
            tick();
          })
          .catch(function (err) {
            scanErrorEl.style.display = "block";
            scanErrorEl.textContent = "æ— æ³•ä½¿ç”¨æ‘„åƒå¤´ï¼Œè¯·å…è®¸ç›¸æœºæƒé™æˆ–æ”¹ç”¨è¾“å…¥ç¼–å·ã€‚";
          });
      }

      async function validateDeviceCodeOnBlur(trimmed) {
        try {
          var res = await fetch("/api/devices?q=" + encodeURIComponent(trimmed), { headers: authHeaders() });
          if (!res.ok) { setValidationInvalid(); return; }
          var list = await res.json();
          var found = list.find(function (d) { return d.device_code === trimmed; });
          if (!found) { setValidationInvalid(); return; }
          setDeviceLoaded(found);
        } catch (e) {
          setValidationInvalid();
        }
      }

      fillTimeSelects();
      loadUsageTypeOptions();
      setDefaultDateAndTime();

      deviceCodeInput.addEventListener("input", updateQueryButtonState);
      deviceCodeInput.addEventListener("keyup", updateQueryButtonState);
      deviceCodeInput.addEventListener("change", updateQueryButtonState);
      deviceCodeInput.addEventListener("blur", function () {
        var trimmed = deviceCodeInput.value.trim();
        if (!trimmed) { showDeviceCodeError(""); return; }
        if (device && device.device_code === trimmed) return;
        validateDeviceCodeOnBlur(trimmed);
      });
      updateQueryButtonState();

      btnScan.addEventListener("click", startScan);
      scanCancel.addEventListener("click", stopScan);
      changeDeviceBtn.addEventListener("click", function () { setDeviceCleared(); });
      deviceCodeInput.addEventListener("keydown", function (e) {
        if (e.key === "Enter") { e.preventDefault(); if (!device) onQueryDevice(); }
      });
      btnQueryDevice.addEventListener("click", onQueryDevice);

      async function submitUsage() {
        if (!device) return;
        if (submitBtn.disabled) return;
        var usageTypeRaw = (usageTypeEl && usageTypeEl.value) ? usageTypeEl.value.trim() : "";
        if (!usageTypeRaw) {
          statusEl.className = "status error";
          statusEl.textContent = "è¯·é€‰æ‹©æ“ä½œç±»å‹";
          return;
        }
        if (!/^\d+$/.test(usageTypeRaw)) {
          statusEl.className = "status error";
          statusEl.textContent = "æ“ä½œç±»å‹ä¸åˆæ³•ï¼Œè¯·é‡æ–°é€‰æ‹©";
          return;
        }
        var usageTypeInt = parseInt(usageTypeRaw, 10);
        var bedNumber = (bedNumberEl && bedNumberEl.value) ? bedNumberEl.value.trim() : null;
        var idNumber = (idNumberEl && idNumberEl.value) ? idNumberEl.value.trim() : null;
        var regDate = registrationDateEl && registrationDateEl.value ? registrationDateEl.value : "";
        var onTime = (powerOnHourEl && powerOnMinuteEl) ? (powerOnHourEl.value + ":" + powerOnMinuteEl.value) : "08:00";
        var offTime = (powerOffHourEl && powerOffMinuteEl) ? (powerOffHourEl.value + ":" + powerOffMinuteEl.value) : "18:00";
        var startTime = regDate && onTime ? regDate + "T" + onTime + ":00" : null;
        var endTime = regDate && offTime ? regDate + "T" + offTime + ":00" : null;
        var eqCond = (document.querySelector("input[name='equipment_condition']:checked") || {}).value || "normal";
        var daily = (document.querySelector("input[name='daily_maintenance']:checked") || {}).value || "clean";
        submitBtn.disabled = true;
        submitBtn.textContent = "æäº¤ä¸­...";
        statusEl.textContent = "";
        statusEl.className = "status";
        var payload = {
          device_code: device.device_code,
          usage_type: usageTypeInt,
          registration_date: regDate || null,
          bed_number: bedNumber || null,
          id_number: idNumber || null,
          patient_name: (patientNameEl && patientNameEl.value) ? patientNameEl.value.trim() : null,
          start_time: startTime,
          end_time: endTime,
          equipment_condition: eqCond,
          daily_maintenance: daily,
          terminal_disinfection: (terminalDisinfectionEl && terminalDisinfectionEl.value) ? terminalDisinfectionEl.value.trim() : null,
          photo_urls: [],
          source: "h5",
        };
        try {
          var res = await fetch("/api/usage", {
            method: "POST",
            headers: { "Content-Type": "application/json", ...authHeaders() },
            body: JSON.stringify(payload),
          });
          if (!res.ok) {
            if (res.status === 401) try { localStorage.removeItem("device_scan_token"); } catch (e) {}
            var err = await res.json().catch(function () { return {}; });
            var msg = res.status === 401 ? "è¯·å…ˆç™»å½•åç™»è®°" : (err.detail || "æäº¤å¤±è´¥");
            if (res.status === 401 && (location.hostname === "localhost" || location.hostname === "127.0.0.1"))
              msg += " å¼€å‘ç¯å¢ƒå¯ <a href=\"/admin\">å‰å¾€åå°ç™»å½•</a> ååˆ·æ–°æœ¬é¡µã€‚";
            throw new Error(msg);
          }
          clearFormDataExceptDeviceCode();
          statusEl.textContent = "";
          setDeviceCleared();
          successPanel.style.display = "block";
          successPanel.scrollIntoView({ behavior: "smooth", block: "nearest" });
        } catch (e) {
          statusEl.className = "status error";
          if (e.message && e.message.indexOf("<a ") !== -1) {
            statusEl.innerHTML = e.message;
          } else {
            statusEl.textContent = e.message;
          }
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = "æäº¤ç™»è®°";
        }
      }

      submitBtn.addEventListener("click", submitUsage);
      btnNextDevice.addEventListener("click", function () {
        successPanel.style.display = "none";
        deviceCodeInput.focus();
      });

      setDefaultDateAndTime();
      if (deviceCodeFromUrl) loadDeviceByCode(deviceCodeFromUrl);
        else if (deviceIdFromUrl) loadDeviceById(deviceIdFromUrl);
    </script>
  </body>
</html>
