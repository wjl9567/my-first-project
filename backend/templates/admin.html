<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>后台管理 - 设备扫码登记</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      /* 统一设计语言：青绿主色、留白、圆角 12px、轻阴影 */
      :root {
        --primary: #0d9488;
        --primary-dark: #0f766e;
        --primary-darker: #134e4a;
        --primary-tint: #ccfbf1;
        --primary-bg: #f0fdfa;
        --surface: #ffffff;
        --bg-page: #f8fafc;
        --border: #e2e8f0;
        --text: #334155;
        --text-muted: #64748b;
        --radius: 12px;
        --radius-sm: 10px;
        --shadow: 0 2px 8px rgba(13, 148, 136, 0.06);
        --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.06);
      }
      * { box-sizing: border-box; }
      body {
        font-family: "PingFang SC", "Microsoft YaHei", -apple-system, BlinkMacSystemFont, sans-serif;
        margin: 0;
        min-height: 100vh;
        background: var(--bg-page);
        color: var(--text);
      }

      /* 登录页：与 H5 同款背景，卡片统一风格 */
      .login-wrap {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 24px;
        background: linear-gradient(160deg, #f0fdfa 0%, #e0f2fe 35%, #f0f9ff 100%);
      }
      .login-prompt {
        background: var(--surface);
        border-radius: 16px;
        box-shadow: var(--shadow);
        padding: 40px;
        max-width: 400px;
        width: 100%;
        text-align: center;
        border: 1px solid var(--border);
      }
      .login-prompt h1 { margin: 0 0 8px; font-size: 22px; color: var(--primary-dark); font-weight: 600; }
      .login-prompt .login-sub { color: var(--text-muted); margin: 0 0 24px; font-size: 14px; }
      .login-form { text-align: left; margin-top: 20px; }
      .login-form .form-row { margin-bottom: 16px; }
      .login-form label { display: block; margin-bottom: 6px; color: var(--text); font-weight: 500; font-size: 14px; }
      .login-form input {
        width: 100%;
        padding: 12px 14px;
        border-radius: var(--radius-sm);
        border: 1px solid var(--border);
        font-size: 15px;
      }
      .login-form input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.12); }
      .login-form button {
        width: 100%;
        margin-top: 8px;
        padding: 12px 16px;
        border-radius: var(--radius-sm);
        border: none;
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: #fff;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
      }
      .login-form button:hover { opacity: 0.95; }
      .login-divider { margin: 24px 0 16px; color: var(--text-muted); font-size: 13px; }
      .msg { font-size: 14px; margin-top: 10px; min-height: 22px; }
      .msg.err { color: #dc2626; font-weight: 500; }
      .msg.ok { color: #059669; font-weight: 500; }
      .login-prompt a { color: var(--primary); font-weight: 600; text-decoration: none; }
      .login-prompt a:hover { text-decoration: underline; }

      /* 管理布局：侧栏 + 主区 */
      .admin-layout { display: flex; min-height: 100vh; height: 100vh; }
      .admin-sidebar {
        width: 220px;
        background: linear-gradient(180deg, var(--primary-dark) 0%, var(--primary-darker) 100%);
        color: #fff;
        flex-shrink: 0;
        display: flex;
        flex-direction: column;
      }
      .admin-sidebar .logo {
        padding: 20px 16px;
        font-size: 17px;
        font-weight: 600;
        letter-spacing: 0.02em;
        border-bottom: 1px solid rgba(255,255,255,0.12);
      }
      .admin-nav { padding: 12px 0; }
      .admin-nav a {
        display: block;
        padding: 12px 20px;
        color: rgba(255,255,255,0.88);
        text-decoration: none;
        font-size: 14px;
        transition: background 0.2s, color 0.2s;
      }
      .admin-nav a:hover { background: rgba(255,255,255,0.1); color: #fff; }
      .admin-nav a.active { background: rgba(255,255,255,0.18); color: #fff; font-weight: 600; }
      .sidebar-version {
        margin-top: auto;
        padding: 16px 20px 20px;
        font-size: 12px;
        color: rgba(255,255,255,0.55);
      }

      /* 主内容区：顶栏与内容统一背景 */
      .admin-main {
        flex: 1;
        overflow: auto;
        height: 100vh;
        padding: 24px;
        background: var(--bg-page);
      }
      .admin-topbar {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: 16px;
        padding: 14px 20px;
        margin-bottom: 20px;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow-sm);
      }
      .admin-topbar .user-name {
        font-size: 14px;
        color: var(--primary-dark);
        font-weight: 600;
      }
      .admin-topbar .logout-btn {
        padding: 8px 16px;
        border-radius: var(--radius-sm);
        border: none;
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: #fff;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
      }
      .admin-topbar .logout-btn:hover { opacity: 0.92; }

      .admin-main h2 {
        margin: 0 0 20px;
        font-size: 20px;
        font-weight: 600;
        color: var(--primary-dark);
        padding-bottom: 12px;
        border-bottom: 2px solid var(--primary-tint);
      }
      .admin-panel { display: none; }
      .admin-panel.active { display: block; }

      .card {
        background: var(--surface);
        border-radius: var(--radius);
        box-shadow: var(--shadow-sm);
        padding: 24px;
        margin-bottom: 20px;
        border: 1px solid var(--border);
      }
      .card h3 { margin: 0 0 16px; font-size: 16px; font-weight: 600; color: var(--text); }
      table { width: 100%; border-collapse: collapse; font-size: 14px; }
      th, td { padding: 12px 16px; border-bottom: 1px solid var(--border); text-align: left; }
      th {
        background: var(--primary-bg);
        color: var(--primary-dark);
        font-weight: 600;
        font-size: 13px;
      }
      tbody tr:hover { background: var(--primary-bg); }
      tbody tr.inactive-row { background: #f1f5f9; color: var(--text-muted); }
      .btn-disable { background: #b91c1c !important; color: #fff !important; padding: 6px 12px !important; font-size: 13px !important; border-radius: var(--radius-sm) !important; }
      .btn-enable { background: #059669 !important; color: #fff !important; padding: 6px 12px !important; font-size: 13px !important; border-radius: var(--radius-sm) !important; }
      input, select {
        padding: 10px 14px;
        border-radius: var(--radius-sm);
        border: 1px solid var(--border);
        font-size: 14px;
      }
      input:focus, select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.1); }
      button {
        padding: 10px 18px;
        border-radius: var(--radius-sm);
        border: none;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
      }
      button:not(.secondary) {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: #fff;
      }
      button.secondary { background: var(--text-muted); color: #fff; }
      .pagination-wrap { margin-top: 12px; display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
      .pagination-wrap button { padding: 8px 14px; }
      button:disabled { opacity: 0.6; cursor: not-allowed; }
      .form-row { margin-bottom: 12px; }
      .form-row label { display: inline-block; width: 90px; color: var(--text); font-weight: 500; }
      .flex { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
      .mb { margin-bottom: 16px; }
      a { color: var(--primary); font-weight: 500; text-decoration: none; }
      a:hover { text-decoration: underline; }

      .stat-cards { display: flex; gap: 16px; flex-wrap: wrap; margin-bottom: 24px; }
      .stat-card {
        background: var(--surface);
        border-radius: var(--radius);
        padding: 20px 24px;
        min-width: 160px;
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--border);
        border-left: 4px solid var(--primary);
      }
      .stat-card .label { font-size: 13px; color: var(--text-muted); margin-bottom: 4px; }
      .stat-card .value { font-size: 24px; font-weight: 600; color: var(--primary-dark); }
      .stat-card-clickable { cursor: pointer; transition: box-shadow 0.2s, background 0.2s; }
      .stat-card-clickable:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); background: var(--bg-elevated); }
      .dict-table { min-width: 520px; }
      .dict-table td:first-child { font-weight: 500; color: var(--text); }
      .dict-table .dict-row-deleted { background: #f8fafc; color: var(--text-muted); }
      .dict-table button { padding: 6px 10px; font-size: 12px; margin-right: 4px; }
      .dict-table .dict-edit-input { width: 120px; padding: 4px 8px; margin-right: 6px; }
      .dict-desc { color: var(--text-muted); margin: 0 0 12px; font-size: 14px; }
      .device-show-deleted-wrap { margin-left: 12px; font-weight: 500; color: var(--text); }
      .device-show-deleted-wrap input { margin-right: 6px; }
      tbody tr.device-row-deleted { background: #f8fafc; color: var(--text-muted); }
      .device-edit-input { width: 90px; padding: 4px 8px; margin-right: 4px; }
      .device-edit-select { min-width: 80px; padding: 4px 8px; margin-right: 4px; }

      /* 表头列宽拖拽：固定表头、不换行，列宽调整后可完整展示内容 */
      .resizable-cols { table-layout: fixed; }
      .resizable-cols th, .resizable-cols td {
        white-space: nowrap;
        overflow-x: auto;
        box-sizing: border-box;
      }
      .resizable-cols th { position: relative; }
      .resizable-cols .col-resize-handle {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        width: 8px;
        cursor: col-resize;
        user-select: none;
        -webkit-user-select: none;
        z-index: 1;
      }
      .resizable-cols .col-resize-handle:hover { background: rgba(13, 148, 136, 0.15); }
      .resizable-cols .col-resize-handle:active { background: rgba(13, 148, 136, 0.25); }
      body.col-resizing { cursor: col-resize; user-select: none; }
      .loading-cell { text-align: center; color: var(--text-muted); padding: 24px !important; }

      /* 使用记录查询：表格横向滚动、筛选区小屏适配 */
      .usage-table-wrap {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        margin: 0 -4px 12px;
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        background: var(--surface);
      }
      #table-usage { min-width: 1100px; width: max-content; margin-bottom: 0; }
      #table-usage th, #table-usage td { min-width: 60px; max-width: 180px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
      #table-usage th:nth-child(1), #table-usage td:nth-child(1) { min-width: 90px; }
      #table-usage th:nth-child(3), #table-usage td:nth-child(3) { min-width: 100px; }
      #table-usage th:nth-child(14), #table-usage td:nth-child(14) { max-width: 200px; white-space: normal; word-break: break-all; }
      .usage-filters { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
      .usage-filters label { white-space: nowrap; color: var(--text); font-weight: 500; font-size: 13px; }
      .usage-filters input, .usage-filters select { min-width: 0; }
      .usage-filters .filter-group { display: inline-flex; align-items: center; gap: 6px; }
      .usage-actions { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-top: 8px; }
      @media (max-width: 900px) {
        .admin-main { padding: 12px; }
        .usage-filters .filter-group { flex: 1 1 140px; min-width: 120px; }
        .usage-filters input[type="date"], .usage-filters input[type="text"] { width: 100%; max-width: 160px; }
        .usage-actions { margin-top: 12px; }
        .usage-actions button { flex: 1; min-width: 80px; }
      }
      @media (max-width: 600px) {
        .usage-filters .filter-group { flex: 1 1 100%; }
        .usage-filters input[type="date"], .usage-filters input[type="text"] { max-width: none; }
      }
    </style>
  </head>
  <body>
    <div id="login-wrap" class="login-wrap" style="display:none;">
      <div id="login-prompt" class="login-prompt">
        <h1>后台管理</h1>
        <p class="login-sub">请登录（需管理员权限）</p>
        <div class="login-form">
          <div class="form-row">
            <label>用户名</label>
            <input type="text" id="login-username" placeholder="管理员用户名" autocomplete="username" />
          </div>
          <div class="form-row">
            <label>密码</label>
            <input type="password" id="login-password" placeholder="密码" autocomplete="current-password" />
          </div>
          <div class="msg" id="login-msg"></div>
          <button type="button" id="btn-login">管理员账号登录</button>
        </div>
        <p class="login-divider">或</p>
        <p><a href="/api/auth/wecom/login?next_path=/admin">企业微信登录</a></p>
      </div>
    </div>

    <div id="admin-layout" class="admin-layout" style="display:none;">
      <aside class="admin-sidebar">
        <div class="logo">设备登记管理</div>
        <nav class="admin-nav">
          <a href="#" class="admin-menu active" data-panel="dashboard">工作台</a>
          <a href="#" class="admin-menu" data-panel="devices">设备管理</a>
          <a href="#" class="admin-menu" data-panel="users">用户管理</a>
          <a href="#" class="admin-menu" data-panel="usage">使用记录查询</a>
          <a href="#" class="admin-menu" data-panel="dict">字典管理</a>
          <a href="#" class="admin-menu" data-panel="audit">审计日志</a>
        </nav>
        <div class="sidebar-version">版本 v{{ app_version }}</div>
      </aside>
      <main class="admin-main">
        <div class="admin-topbar">
          <span class="user-name" id="user-name">管理员</span>
          <button type="button" id="btn-logout" class="logout-btn">退出登录</button>
        </div>
        <div id="panel-dashboard" class="admin-panel active">
          <h2>工作台</h2>
          <div class="stat-cards">
            <div class="stat-card stat-card-clickable" data-panel="devices" data-device-filter="">
              <div class="label">设备总数</div>
              <div class="value" id="stat-device-count">—</div>
            </div>
            <div class="stat-card stat-card-clickable" data-panel="devices" data-device-filter="">
              <div class="label">启用设备</div>
              <div class="value" id="stat-active-count">—</div>
            </div>
            <div class="stat-card stat-card-clickable" data-panel="devices" data-device-filter="inactive_only">
              <div class="label">已停用设备</div>
              <div class="value" id="stat-inactive-count">—</div>
            </div>
            <div class="stat-card stat-card-clickable" data-panel="devices" data-device-filter="deleted_only">
              <div class="label">已删除设备</div>
              <div class="value" id="stat-deleted-count">—</div>
            </div>
            <div class="stat-card stat-card-clickable" data-panel="users" data-device-filter="">
              <div class="label">用户数</div>
              <div class="value" id="stat-user-count">—</div>
            </div>
            <div class="stat-card stat-card-clickable" data-panel="usage" data-device-filter="">
              <div class="label">使用记录条数</div>
              <div class="value" id="stat-usage-count">—</div>
            </div>
          </div>
          <div class="card">
            <h3>快捷操作</h3>
            <p style="margin:0;color:#64748b;">从左侧菜单进入 <strong>设备管理</strong> 维护设备信息，进入 <strong>使用记录查询</strong> 按条件查询并导出登记记录。</p>
          </div>
        </div>

        <div id="panel-devices" class="admin-panel">
          <h2>设备管理</h2>
          <div class="card">
            <div class="form-row flex mb">
              <label>编号</label><input id="new-code" placeholder="设备编号" />
              <label>名称</label><input id="new-name" placeholder="设备名称" />
              <label>科室</label><input id="new-dept" placeholder="科室" />
              <button id="btn-add">新增设备</button>
              <button type="button" id="btn-device-export-csv" class="secondary">导出 CSV</button>
              <button type="button" id="btn-device-export-xlsx" class="secondary">导出 Excel</button>
              <label class="device-show-deleted-wrap"><input type="checkbox" id="device-deleted-only" /> 只显示已删除</label>
              <label class="device-show-inactive-wrap"><input type="checkbox" id="device-inactive-only" /> 只显示已停用</label>
            </div>
            <div class="flex mb">
              <label>搜索</label>
              <input id="device-filter-q" placeholder="设备名称或编号" />
              <label>科室</label>
              <input id="device-filter-dept" list="device-dept-options" placeholder="按科室筛选" />
              <datalist id="device-dept-options"></datalist>
              <button type="button" id="btn-device-query">查询</button>
              <button type="button" id="btn-device-reset" class="secondary">清空筛选</button>
            </div>
            <div class="msg" id="device-msg"></div>
            <table id="table-devices" class="resizable-cols">
              <thead>
                <tr><th>编号</th><th>名称</th><th>科室</th><th>状态</th><th>启用</th><th>二维码</th><th>操作</th></tr>
              </thead>
              <tbody id="device-list"></tbody>
            </table>
            <div class="pagination-wrap" id="device-pagination">
              <span id="device-page-info">共 0 条</span>
              <button type="button" id="device-prev" class="secondary">上一页</button>
              <button type="button" id="device-next" class="secondary">下一页</button>
            </div>
          </div>
        </div>

        <div id="panel-users" class="admin-panel">
          <h2>用户管理</h2>
          <div class="card">
            <p class="mb" style="color:var(--text-muted);">系统用户列表（企业微信登录或管理员账号），仅查看。</p>
            <table id="table-users" class="resizable-cols">
              <thead>
                <tr><th>ID</th><th>用户名</th><th>姓名</th><th>角色</th><th>科室</th><th>创建时间</th></tr>
              </thead>
              <tbody id="user-list"></tbody>
            </table>
            <div class="pagination-wrap" id="user-pagination">
              <span id="user-page-info">共 0 条</span>
              <button type="button" id="user-prev" class="secondary">上一页</button>
              <button type="button" id="user-next" class="secondary">下一页</button>
            </div>
          </div>
        </div>

        <div id="panel-usage" class="admin-panel">
          <h2>使用记录查询</h2>
          <div class="card">
            <div class="usage-filters mb">
              <span class="filter-group"><label>设备</label><input id="filter-device" list="device-options" placeholder="名称或编号" /></span>
              <datalist id="device-options"></datalist>
              <span class="filter-group"><label>科室</label><input id="filter-dept" list="dept-options" placeholder="科室" /></span>
              <datalist id="dept-options"></datalist>
              <span class="filter-group"><label>登记日期起</label><input type="date" id="filter-reg-from" /></span>
              <span class="filter-group"><label>登记日期止</label><input type="date" id="filter-reg-to" /></span>
              <span class="filter-group"><label>床号</label><input id="filter-bed" placeholder="床号" /></span>
              <span class="filter-group"><label>开始日期</label><input type="date" id="filter-from" /></span>
              <span class="filter-group"><label>结束日期</label><input type="date" id="filter-to" /></span>
            </div>
            <div class="usage-actions">
              <button id="btn-query">查询</button>
              <button id="btn-export" class="secondary">导出 CSV</button>
              <button id="btn-export-xlsx" class="secondary">导出 Excel</button>
              <button id="btn-export-pdf" class="secondary">导出 PDF</button>
            </div>
            <div class="msg" id="usage-msg"></div>
            <div class="usage-table-wrap" role="region" aria-label="使用记录表格，可左右滑动查看全部列">
              <table id="table-usage" class="resizable-cols">
                <thead>
                  <tr><th>登记日期</th><th>实际登记时间</th><th>设备</th><th>床号</th><th>ID号</th><th>姓名</th><th>开机</th><th>关机</th><th>维护人</th><th>类型</th><th>设备状况</th><th>日常保养</th><th>终末消毒</th><th>备注</th></tr>
                </thead>
                <tbody id="usage-list"></tbody>
              </table>
            </div>
            <div class="pagination-wrap" id="usage-pagination">
              <span id="usage-page-info">共 0 条</span>
              <button type="button" id="usage-prev" class="secondary">上一页</button>
              <button type="button" id="usage-next" class="secondary">下一页</button>
            </div>
          </div>
        </div>

        <div id="panel-dict" class="admin-panel">
          <h2>字典管理</h2>
          <div class="card">
            <h3>使用类型</h3>
            <p class="dict-desc">登记时可选的使用类型，可增删改、启用/停用；删除仅打标识不物理删除。</p>
            <div class="form-row flex mb">
              <label>编码</label><input type="number" id="dict-usage-code" placeholder="如 1" min="1" />
              <label>显示名称</label><input id="dict-usage-label" placeholder="如 其他" />
              <button type="button" id="dict-usage-add">新增</button>
            </div>
            <div class="msg" id="dict-usage-msg"></div>
            <table id="table-dict-usage" class="dict-table resizable-cols">
              <thead>
                <tr><th>编码</th><th>显示名称</th><th>状态</th><th>已删除</th><th>操作</th></tr>
              </thead>
              <tbody id="dict-usage-tbody"></tbody>
            </table>
          </div>
          <div class="card">
            <h3>设备状态</h3>
            <p class="dict-desc">设备运行状态，用于设备管理中的状态字段。</p>
            <div class="form-row flex mb">
              <label>编码</label><input type="number" id="dict-status-code" placeholder="如 1" min="1" />
              <label>显示名称</label><input id="dict-status-label" placeholder="如 可用" />
              <button type="button" id="dict-status-add">新增</button>
            </div>
            <div class="msg" id="dict-status-msg"></div>
            <table id="table-dict-status" class="dict-table resizable-cols">
              <thead>
                <tr><th>编码</th><th>显示名称</th><th>状态</th><th>已删除</th><th>操作</th></tr>
              </thead>
              <tbody id="dict-status-tbody"></tbody>
            </table>
          </div>
        </div>

        <div id="panel-audit" class="admin-panel">
          <h2>审计日志</h2>
          <div class="card">
            <div class="flex mb">
              <label>操作类型</label>
              <select id="audit-filter-action">
                <option value="">全部</option>
                <option value="device.create">设备-新增</option>
                <option value="device.update">设备-更新</option>
                <option value="device.delete">设备-删除</option>
                <option value="device.restore">设备-恢复</option>
                <option value="usage.export">使用记录-导出</option>
                <option value="auth.login">登录</option>
              </select>
              <label>开始时间</label>
              <input type="datetime-local" id="audit-filter-from" />
              <label>结束时间</label>
              <input type="datetime-local" id="audit-filter-to" />
              <button id="btn-audit-query">查询</button>
            </div>
            <div class="msg" id="audit-msg"></div>
            <table id="table-audit" class="resizable-cols">
              <thead>
                <tr><th>时间</th><th>操作人</th><th>操作说明</th><th>备注</th></tr>
              </thead>
              <tbody id="audit-list"></tbody>
            </table>
          </div>
        </div>
      </main>
    </div>

    <script>
      function escapeHtml(s) {
        if (s == null || s === undefined) return "";
        return String(s).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#39;");
      }
      (function () {
        const hash = location.hash.slice(1);
        const q = new URLSearchParams(location.search);
        const token = new URLSearchParams(hash).get("token") || q.get("token");
        if (token) {
          try { localStorage.setItem("device_scan_token", token); } catch (e) {}
        }
      })();
      function authHeaders() {
        try {
          const t = localStorage.getItem("device_scan_token");
          return t ? { "Authorization": "Bearer " + t } : {};
        } catch (e) { return {}; }
      }
      function ensureAuth(res) {
        if (res && res.status === 401) {
          try { localStorage.removeItem("device_scan_token"); } catch (e) {}
          location.reload();
          return false;
        }
        return true;
      }
      var _origFetch = window.fetch;
      window.fetch = function (url, opts) {
        return _origFetch.apply(this, arguments).then(function (res) {
          if (url && typeof url === "string" && url.indexOf("/api/") !== -1 && res.status === 401) {
            try { localStorage.removeItem("device_scan_token"); } catch (e) {}
            location.reload();
          }
          return res;
        });
      };

      var COL_RESIZE_MIN = 80;
      var COL_RESIZE_MAX_RATIO = 0.5;
      var COL_RESIZE_STORAGE_PREFIX = "device_scan_cols_";
      var COL_RESIZE_DEFAULT_PX = 120;

      function initResizableColumns(tableEl) {
        if (!tableEl || !tableEl.classList.contains("resizable-cols")) return;
        var tableId = tableEl.id || ("table-" + Math.random().toString(36).slice(2, 8));
        tableEl.id = tableId;
        var thead = tableEl.querySelector("thead");
        var tr = thead && thead.querySelector("tr");
        if (!tr) return;
        var ths = tr.querySelectorAll("th");
        var colCount = ths.length;
        if (colCount === 0) return;

        var colgroup = tableEl.querySelector("colgroup");
        if (!colgroup) {
          colgroup = document.createElement("colgroup");
          tableEl.insertBefore(colgroup, tableEl.firstChild);
        }
        colgroup.innerHTML = "";
        var cols = [];
        for (var i = 0; i < colCount; i++) {
          var col = document.createElement("col");
          colgroup.appendChild(col);
          cols.push(col);
        }

        var saved = {};
        try {
          var raw = localStorage.getItem(COL_RESIZE_STORAGE_PREFIX + tableId);
          if (raw) saved = JSON.parse(raw) || {};
        } catch (e) {}
        for (var i = 0; i < colCount; i++) {
          var w = saved[i] != null ? Math.max(COL_RESIZE_MIN, Number(saved[i])) : COL_RESIZE_DEFAULT_PX;
          var maxW = Math.floor(window.innerWidth * COL_RESIZE_MAX_RATIO);
          cols[i].style.width = Math.min(maxW, w) + "px";
        }

        function saveWidths() {
          var o = {};
          for (var i = 0; i < colCount; i++) {
            var w = cols[i].style.width;
            if (w) o[i] = parseInt(w, 10) || COL_RESIZE_DEFAULT_PX;
          }
          try { localStorage.setItem(COL_RESIZE_STORAGE_PREFIX + tableId, JSON.stringify(o)); } catch (e) {}
        }

        for (var i = 0; i < ths.length; i++) {
          (function (colIndex) {
            var th = ths[colIndex];
            var handle = document.createElement("div");
            handle.className = "col-resize-handle";
            handle.setAttribute("aria-label", "调整列宽");
            th.appendChild(handle);
            handle.addEventListener("mousedown", function (e) {
              e.preventDefault();
              e.stopPropagation();
              var startX = e.clientX;
              var startW = parseInt(cols[colIndex].style.width, 10) || COL_RESIZE_DEFAULT_PX;
              var maxW = Math.floor(window.innerWidth * COL_RESIZE_MAX_RATIO);

              function onMove(e) {
                var dx = e.clientX - startX;
                var newW = Math.max(COL_RESIZE_MIN, Math.min(maxW, startW + dx));
                cols[colIndex].style.width = newW + "px";
              }
              function onUp() {
                document.body.classList.remove("col-resizing");
                document.removeEventListener("mousemove", onMove);
                document.removeEventListener("mouseup", onUp);
                saveWidths();
              }
              document.body.classList.add("col-resizing");
              document.addEventListener("mousemove", onMove);
              document.addEventListener("mouseup", onUp);
            });
          })(i);
        }
      }

      function initAllResizableTables() {
        document.querySelectorAll("table.resizable-cols").forEach(initResizableColumns);
      }

      const loginWrap = document.getElementById("login-wrap");
      const adminLayout = document.getElementById("admin-layout");
      const logoutBtn = document.getElementById("btn-logout");

      async function checkAdmin() {
        const res = await fetch("/api/auth/me", { headers: authHeaders() });
        if (!res.ok) {
          loginWrap.style.display = "flex";
          return false;
        }
        const me = await res.json();
        const userNameEl = document.getElementById("user-name");
        if (userNameEl) {
          userNameEl.textContent = me.real_name || me.wx_userid || me.username || "管理员";
        }
        if (me.role !== "device_admin" && me.role !== "sys_admin") {
          document.getElementById("login-prompt").innerHTML = "<h1>后台管理</h1><p>需要管理员权限，请使用管理员账号或企业微信登录。</p><div class=\"login-form\"><div class=\"form-row\"><label>用户名</label><input type=\"text\" id=\"login-username\" placeholder=\"管理员用户名\" /></div><div class=\"form-row\"><label>密码</label><input type=\"password\" id=\"login-password\" placeholder=\"密码\" /></div><div class=\"msg\" id=\"login-msg\"></div><button type=\"button\" id=\"btn-login\">管理员账号登录</button></div><p class=\"login-divider\">或</p><p><a href=\"/api/auth/wecom/login?next_path=/admin\">企业微信登录</a></p>";
          loginWrap.style.display = "flex";
          bindLoginForm();
          return false;
        }
        adminLayout.style.display = "flex";
        return true;
      }

      // 菜单切换
      document.querySelectorAll(".admin-menu").forEach(function (a) {
        a.addEventListener("click", function (e) {
          e.preventDefault();
          var panelId = this.getAttribute("data-panel");
          document.querySelectorAll(".admin-menu").forEach(function (m) { m.classList.remove("active"); });
          document.querySelectorAll(".admin-panel").forEach(function (p) { p.classList.remove("active"); });
          this.classList.add("active");
          var panel = document.getElementById("panel-" + panelId);
          if (panel) panel.classList.add("active");
          if (panelId === "dashboard") loadDashboardStats();
          if (panelId === "devices") { devicePage = 0; loadDevices(); }
          if (panelId === "users") { userPage = 0; loadUsers(); }
          if (panelId === "usage") { usagePage = 0; loadUsageSuggest(); loadUsage(); }
          if (panelId === "dict") loadDict();
          if (panelId === "audit") loadAudit();
        });
      });
      document.querySelectorAll(".stat-card-clickable").forEach(function (card) {
        card.addEventListener("click", function () {
          var panelId = this.getAttribute("data-panel");
          var filterKind = (this.getAttribute("data-device-filter") || "").trim() || null;
          goToPanelWithDeviceFilter(panelId, filterKind);
        });
      });

      async function loadDashboardStats() {
        try {
          const [devTotalRes, devActiveRes, devInactiveRes, devDeletedRes, userCountRes, usageCountRes] = await Promise.all([
            fetch("/api/devices/count?include_inactive=1", { headers: authHeaders() }),
            fetch("/api/devices/count?include_inactive=0", { headers: authHeaders() }),
            fetch("/api/devices/count?inactive_only=1", { headers: authHeaders() }),
            fetch("/api/devices/count?deleted_only=1", { headers: authHeaders() }),
            fetch("/api/users/count", { headers: authHeaders() }),
            fetch("/api/usage/count", { headers: authHeaders() })
          ]);
          var devTotal = devTotalRes.ok ? (await devTotalRes.json()).total : 0;
          var devActive = devActiveRes.ok ? (await devActiveRes.json()).total : 0;
          var devInactive = devInactiveRes.ok ? (await devInactiveRes.json()).total : 0;
          var devDeleted = devDeletedRes.ok ? (await devDeletedRes.json()).total : 0;
          var userTotal = userCountRes.ok ? (await userCountRes.json()).total : 0;
          var usageTotal = usageCountRes.ok ? (await usageCountRes.json()).total : 0;
          document.getElementById("stat-device-count").textContent = devTotal;
          document.getElementById("stat-active-count").textContent = devActive;
          document.getElementById("stat-inactive-count").textContent = devInactive;
          document.getElementById("stat-deleted-count").textContent = devDeleted;
          document.getElementById("stat-user-count").textContent = userTotal;
          document.getElementById("stat-usage-count").textContent = usageTotal;
        } catch (e) {
          document.getElementById("stat-device-count").textContent = "—";
          document.getElementById("stat-active-count").textContent = "—";
          document.getElementById("stat-inactive-count").textContent = "—";
          document.getElementById("stat-deleted-count").textContent = "—";
          document.getElementById("stat-user-count").textContent = "—";
          document.getElementById("stat-usage-count").textContent = "—";
        }
      }

      function goToPanelWithDeviceFilter(panelId, filterKind) {
        document.querySelectorAll(".admin-panel").forEach(function (p) { p.classList.remove("active"); });
        document.querySelectorAll(".admin-menu").forEach(function (m) { m.classList.remove("active"); });
        var panel = document.getElementById("panel-" + panelId);
        var menu = document.querySelector(".admin-menu[data-panel=\"" + panelId + "\"]");
        if (panel) panel.classList.add("active");
        if (menu) menu.classList.add("active");
        // 先清空目标面板表格并显示加载中，再发起请求，避免第二次打开时仍显示旧数据
        var deviceListEl = document.getElementById("device-list");
        var userListEl = document.getElementById("user-list");
        var usageListEl = document.getElementById("usage-list");
        if (panelId === "devices" && deviceListEl) { deviceListEl.innerHTML = "<tr><td colspan=\"7\" class=\"loading-cell\">加载中...</td></tr>"; }
        if (panelId === "users" && userListEl) { userListEl.innerHTML = "<tr><td colspan=\"6\" class=\"loading-cell\">加载中...</td></tr>"; }
        if (panelId === "usage" && usageListEl) { usageListEl.innerHTML = "<tr><td colspan=\"5\" class=\"loading-cell\">加载中...</td></tr>"; }
        if (panelId === "devices") {
          var deletedCb = document.getElementById("device-deleted-only");
          var inactiveCb = document.getElementById("device-inactive-only");
          if (filterKind === "deleted_only") {
            if (deletedCb) deletedCb.checked = true;
            if (inactiveCb) inactiveCb.checked = false;
          } else if (filterKind === "inactive_only") {
            if (inactiveCb) inactiveCb.checked = true;
            if (deletedCb) deletedCb.checked = false;
          } else {
            if (deletedCb) deletedCb.checked = false;
            if (inactiveCb) inactiveCb.checked = false;
          }
          devicePage = 0;
          loadDevices();
        }
        if (panelId === "usage") { usagePage = 0; if (typeof loadUsageSuggest === "function") loadUsageSuggest(); if (typeof loadUsage === "function") loadUsage(); }
        if (panelId === "users") { userPage = 0; if (typeof loadUsers === "function") loadUsers(); }
      }

      var devicePage = 0;
      var devicePageSize = 100;
      var deviceTotal = 0;
      async function loadDevices() {
        var tbodyEl = document.getElementById("device-list");
        if (tbodyEl) tbodyEl.innerHTML = "<tr><td colspan=\"7\" class=\"loading-cell\">加载中...</td></tr>";
        const deletedOnly = document.getElementById("device-deleted-only") && document.getElementById("device-deleted-only").checked;
        const inactiveOnly = document.getElementById("device-inactive-only") && document.getElementById("device-inactive-only").checked;
        const qEl = document.getElementById("device-filter-q");
        const deptEl = document.getElementById("device-filter-dept");
        const q = (qEl && qEl.value || "").trim();
        const dept = (deptEl && deptEl.value || "").trim();
        const offset = devicePage * devicePageSize;
        let listUrl = "/api/devices?include_inactive=1&limit=" + devicePageSize + "&offset=" + offset;
        let countUrl = "/api/devices/count?include_inactive=1";
        if (deletedOnly) { listUrl += "&deleted_only=1"; countUrl += "&deleted_only=1"; }
        else if (inactiveOnly) { listUrl += "&inactive_only=1"; countUrl += "&inactive_only=1"; }
        if (q) { listUrl += "&q=" + encodeURIComponent(q); countUrl += "&q=" + encodeURIComponent(q); }
        if (dept) { listUrl += "&dept=" + encodeURIComponent(dept); countUrl += "&dept=" + encodeURIComponent(dept); }
        const [listRes, countRes] = await Promise.all([fetch(listUrl, { headers: authHeaders() }), fetch(countUrl, { headers: authHeaders() })]);
        if (!listRes.ok) return [];
        const list = await listRes.json();
        deviceTotal = countRes.ok ? (await countRes.json()).total : list.length;
        var statusMap = {};
        try {
          var statusOpts = await getDeviceStatusOptions();
          statusOpts.forEach(function (o) { statusMap[o.code] = o.label || String(o.code); });
        } catch (e) {}
        var statusLabel = function (code) { return statusMap[code] != null ? statusMap[code] : String(code); };
        const tbody = document.getElementById("device-list");
        const deviceOptions = document.getElementById("device-options");
        const deptOptions = document.getElementById("dept-options");
        deviceOptions.innerHTML = "";
        deptOptions.innerHTML = "";
        tbody.innerHTML = "";
        const seenDepts = new Set();
        const deviceDeptOptionsEl = document.getElementById("device-dept-options");
        if (deviceDeptOptionsEl) deviceDeptOptionsEl.innerHTML = "";
        list.forEach(d => {
          const tr = document.createElement("tr");
          tr.dataset.deviceId = d.id;
          if (d.is_deleted) tr.classList.add("device-row-deleted");
          const activeText = d.is_active ? "启用" : "停用";
          const activeClass = d.is_active ? "" : " inactive-row";
          const qrLink = (d.is_active && !d.is_deleted)
            ? "<a href=\"/api/devices/" + d.id + "/qrcode\" target=\"_blank\">查看</a>"
            : "—";
          var actionParts = [];
          if (!d.is_deleted) {
            actionParts.push(d.is_active
              ? "<button type=\"button\" class=\"btn-disable\" data-id=\"" + d.id + "\">停用</button>"
              : "<button type=\"button\" class=\"btn-enable\" data-id=\"" + d.id + "\">启用</button>");
            actionParts.push("<button type=\"button\" class=\"btn-edit-device\" data-id=\"" + d.id + "\" data-device-code=\"" + escapeHtml(d.device_code || "") + "\" data-name=\"" + escapeHtml(d.name || "") + "\" data-dept=\"" + escapeHtml(d.dept || "") + "\" data-status=\"" + (d.status != null ? d.status : "1") + "\">编辑</button>");
            actionParts.push("<button type=\"button\" class=\"btn-delete-device\" data-id=\"" + d.id + "\">删除</button>");
          } else {
            actionParts.push("<button type=\"button\" class=\"btn-restore-device\" data-id=\"" + d.id + "\">恢复</button>");
          }
          tr.innerHTML = "<td class=\"device-code-cell\">" + escapeHtml(d.device_code) + "</td><td class=\"device-name-cell\">" + escapeHtml(d.name || "") + "</td><td class=\"device-dept-cell\">" + escapeHtml(d.dept || "") + "</td><td class=\"device-status-cell\">" + escapeHtml(String(statusLabel(d.status))) + "</td><td>" + activeText + "</td><td>" + qrLink + "</td><td>" + actionParts.join(" ") + "</td>";
          tr.className = activeClass;
          tbody.appendChild(tr);
          if (!d.is_deleted) {
            const opt = document.createElement("option");
            opt.value = d.name + " (" + d.device_code + ")" + (d.is_active ? "" : " [已停用]");
            deviceOptions.appendChild(opt);
          }
          if (d.dept && !seenDepts.has(d.dept)) {
            seenDepts.add(d.dept);
            const deptOpt = document.createElement("option");
            deptOpt.value = d.dept;
            deptOptions.appendChild(deptOpt);
            if (deviceDeptOptionsEl) {
              const opt = document.createElement("option");
              opt.value = d.dept;
              deviceDeptOptionsEl.appendChild(opt);
            }
          }
        });
        var start = offset + 1;
        var end = offset + list.length;
        document.getElementById("device-page-info").textContent = "共 " + deviceTotal + " 条，当前第 " + (deviceTotal ? start : 0) + "–" + end + " 条";
        document.getElementById("device-prev").disabled = devicePage === 0;
        document.getElementById("device-next").disabled = end >= deviceTotal;
        tbody.querySelectorAll(".btn-disable").forEach(btn => {
          btn.onclick = () => setDeviceActive(parseInt(btn.dataset.id, 10), false);
        });
        tbody.querySelectorAll(".btn-enable").forEach(btn => {
          btn.onclick = () => setDeviceActive(parseInt(btn.dataset.id, 10), true);
        });
        tbody.querySelectorAll(".btn-edit-device").forEach(btn => {
          btn.onclick = function () {
            var tr = trFromBtn(btn);
            openDeviceEdit(parseInt(btn.dataset.id, 10), btn.dataset.deviceCode || "", btn.dataset.name || "", btn.dataset.dept || "", btn.dataset.status || "1", tr);
          };
        });
        tbody.querySelectorAll(".btn-delete-device").forEach(btn => {
          btn.onclick = () => deviceSoftDelete(parseInt(btn.dataset.id, 10));
        });
        tbody.querySelectorAll(".btn-restore-device").forEach(btn => {
          btn.onclick = () => deviceRestore(parseInt(btn.dataset.id, 10));
        });
        return list;
      }
      document.getElementById("device-prev").onclick = function () { if (devicePage > 0) { devicePage--; loadDevices(); } };
      document.getElementById("device-next").onclick = function () { if ((devicePage + 1) * devicePageSize < deviceTotal) { devicePage++; loadDevices(); } };
      var btnDeviceQuery = document.getElementById("btn-device-query");
      if (btnDeviceQuery) btnDeviceQuery.onclick = function () { devicePage = 0; loadDevices(); };
      var btnDeviceReset = document.getElementById("btn-device-reset");
      if (btnDeviceReset) btnDeviceReset.onclick = function () {
        var qEl = document.getElementById("device-filter-q");
        var deptEl = document.getElementById("device-filter-dept");
        if (qEl) qEl.value = "";
        if (deptEl) deptEl.value = "";
        devicePage = 0;
        loadDevices();
      };
      var deviceFilterQEl = document.getElementById("device-filter-q");
      if (deviceFilterQEl) deviceFilterQEl.addEventListener("keydown", function (e) { if (e.key === "Enter") { e.preventDefault(); devicePage = 0; loadDevices(); } });

      async function doDeviceExport(format) {
        var btnCsv = document.getElementById("btn-device-export-csv");
        var btnXlsx = document.getElementById("btn-device-export-xlsx");
        if (btnCsv) { btnCsv.disabled = true; btnCsv.textContent = "导出中..."; }
        if (btnXlsx) { btnXlsx.disabled = true; btnXlsx.textContent = "导出中..."; }
        try {
          var deletedOnly = document.getElementById("device-deleted-only") && document.getElementById("device-deleted-only").checked;
          var inactiveOnly = document.getElementById("device-inactive-only") && document.getElementById("device-inactive-only").checked;
          var qEl = document.getElementById("device-filter-q");
          var deptEl = document.getElementById("device-filter-dept");
          var q = (qEl && qEl.value || "").trim();
          var dept = (deptEl && deptEl.value || "").trim();
          var url = "/api/devices/export?format=" + encodeURIComponent(format) + "&include_inactive=1";
          if (deletedOnly) url += "&deleted_only=1";
          else if (inactiveOnly) url += "&inactive_only=1";
          if (q) url += "&q=" + encodeURIComponent(q);
          if (dept) url += "&dept=" + encodeURIComponent(dept);
          var msgEl = document.getElementById("device-msg");
          var res = await fetch(url, { headers: authHeaders() });
          if (!res.ok) {
            var err = await res.json().catch(function () { return {}; });
            msgEl.textContent = err.detail || "导出失败（需管理员权限）";
            msgEl.className = "msg err";
            return;
          }
          var blob = await res.blob();
          var a = document.createElement("a");
          a.href = URL.createObjectURL(blob);
          a.download = format === "xlsx" ? "devices.xlsx" : "devices.csv";
          a.click();
          URL.revokeObjectURL(a.href);
          msgEl.textContent = "已导出";
          msgEl.className = "msg ok";
        } finally {
          if (btnCsv) { btnCsv.disabled = false; btnCsv.textContent = "导出 CSV"; }
          if (btnXlsx) { btnXlsx.disabled = false; btnXlsx.textContent = "导出 Excel"; }
        }
      }
      document.getElementById("btn-device-export-csv").onclick = function () { doDeviceExport("csv"); };
      document.getElementById("btn-device-export-xlsx").onclick = function () { doDeviceExport("xlsx"); };

      function trFromBtn(btn) {
        let el = btn;
        while (el && el.tagName !== "TR") el = el.parentElement;
        return el;
      }
      var deviceStatusOptions = null;
      async function getDeviceStatusOptions() {
        if (deviceStatusOptions) return deviceStatusOptions;
        const res = await fetch("/api/dict?dict_type=device_status", { headers: authHeaders() });
        if (!res.ok) return [];
        deviceStatusOptions = await res.json();
        return deviceStatusOptions;
      }
      async function openDeviceEdit(deviceId, deviceCode, name, dept, statusCode, tr) {
        const opts = await getDeviceStatusOptions();
        let selectHtml = "<select class=\"device-edit-select\" data-field=\"status\">";
        var statusVal = typeof statusCode === "string" ? parseInt(statusCode, 10) : statusCode;
        opts.forEach(function (o) {
          var c = o.code;
          selectHtml += "<option value=\"" + c + "\"" + (c === statusVal || c === statusCode ? " selected" : "") + ">" + (o.label || c) + "</option>";
        });
        selectHtml += "</select>";
        const codeCell = tr.querySelector(".device-code-cell");
        const nameCell = tr.querySelector(".device-name-cell");
        const deptCell = tr.querySelector(".device-dept-cell");
        const statusCell = tr.querySelector(".device-status-cell");
        const oldCode = codeCell ? codeCell.innerHTML : "";
        const oldName = nameCell.innerHTML;
        const oldDept = deptCell.innerHTML;
        const oldStatus = statusCell.innerHTML;
        if (codeCell) codeCell.innerHTML = "<input class=\"device-edit-input\" data-field=\"device_code\" value=\"" + escapeHtml(deviceCode || "") + "\" placeholder=\"设备编号\" />";
        nameCell.innerHTML = "<input class=\"device-edit-input\" data-field=\"name\" value=\"" + escapeHtml(name || "") + "\" />";
        deptCell.innerHTML = "<input class=\"device-edit-input\" data-field=\"dept\" value=\"" + escapeHtml(dept || "") + "\" />";
        statusCell.innerHTML = selectHtml + " <button type=\"button\" class=\"device-edit-save\">保存</button> <button type=\"button\" class=\"device-edit-cancel\">取消</button>";
        tr.querySelector(".device-edit-save").onclick = async function () {
          var newCode = codeCell ? tr.querySelector("input[data-field=device_code]").value.trim() : (deviceCode || "");
          const newName = tr.querySelector("input[data-field=name]").value.trim();
          const newDept = tr.querySelector("input[data-field=dept]").value.trim();
          const newStatus = parseInt(tr.querySelector("select[data-field=status]").value, 10);
          var body = { name: newName, dept: newDept || null, status: newStatus };
          if (codeCell) body.device_code = newCode;
          const res = await fetch("/api/devices/" + deviceId, {
            method: "PATCH",
            headers: { "Content-Type": "application/json", ...authHeaders() },
            body: JSON.stringify(body)
          });
          if (res.ok) { loadDevices(); loadDashboardStats(); if (typeof loadAudit === "function") loadAudit(); document.getElementById("device-msg").textContent = "已保存"; document.getElementById("device-msg").className = "msg ok"; }
          else { var e = await res.json().catch(function(){return{};}); alert(e.detail || "保存失败"); }
        };
        tr.querySelector(".device-edit-cancel").onclick = function () {
          if (codeCell) codeCell.innerHTML = oldCode;
          nameCell.innerHTML = oldName;
          deptCell.innerHTML = oldDept;
          statusCell.innerHTML = oldStatus;
        };
      }
      async function deviceSoftDelete(deviceId) {
        if (!confirm("确定删除？仅打标识不物理删除，可勾选「只显示已删除」后恢复。")) return;
        const res = await fetch("/api/devices/" + deviceId, {
          method: "PATCH",
          headers: { "Content-Type": "application/json", ...authHeaders() },
          body: JSON.stringify({ is_deleted: true })
        });
        if (res.ok) { loadDevices(); loadDashboardStats(); if (typeof loadAudit === "function") loadAudit(); document.getElementById("device-msg").textContent = "已删除"; document.getElementById("device-msg").className = "msg ok"; }
        else { var e = await res.json().catch(function(){return{};}); document.getElementById("device-msg").textContent = e.detail || "删除失败"; document.getElementById("device-msg").className = "msg err"; }
      }
      async function deviceRestore(deviceId) {
        const res = await fetch("/api/devices/" + deviceId, {
          method: "PATCH",
          headers: { "Content-Type": "application/json", ...authHeaders() },
          body: JSON.stringify({ is_deleted: false })
        });
        if (res.ok) { loadDevices(); loadDashboardStats(); if (typeof loadAudit === "function") loadAudit(); document.getElementById("device-msg").textContent = "已恢复"; document.getElementById("device-msg").className = "msg ok"; }
        else { var e = await res.json().catch(function(){return{};}); document.getElementById("device-msg").textContent = e.detail || "恢复失败"; document.getElementById("device-msg").className = "msg err"; }
      }

      async function setDeviceActive(deviceId, isActive) {
        const msg = document.getElementById("device-msg");
        msg.textContent = isActive ? "启用中..." : "停用中...";
        msg.className = "msg";
        const res = await fetch("/api/devices/" + deviceId, {
          method: "PATCH",
          headers: { "Content-Type": "application/json", ...authHeaders() },
          body: JSON.stringify({ is_active: isActive })
        });
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          msg.textContent = err.detail || (isActive ? "启用失败" : "停用失败");
          msg.className = "msg err";
          return;
        }
        msg.textContent = isActive ? "已启用" : "已停用";
        msg.className = "msg ok";
        loadDevices();
        loadDashboardStats();
        if (typeof loadAudit === "function") loadAudit();
      }

      document.getElementById("btn-add").onclick = async function () {
        const code = document.getElementById("new-code").value.trim();
        const name = document.getElementById("new-name").value.trim();
        const dept = document.getElementById("new-dept").value.trim();
        const msg = document.getElementById("device-msg");
        if (!code || !name || !dept) { msg.textContent = "请填写设备编号、设备名称和科室"; msg.className = "msg err"; return; }
        msg.textContent = "提交中...";
        msg.className = "msg";
        const res = await fetch("/api/devices", {
          method: "POST",
          headers: { "Content-Type": "application/json", ...authHeaders() },
          body: JSON.stringify({ device_code: code, name: name, dept: dept, status: 1, is_active: true })
        });
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          msg.textContent = err.detail || "新增失败";
          msg.className = "msg err";
          return;
        }
        msg.textContent = "已添加";
        msg.className = "msg ok";
        document.getElementById("new-code").value = "";
        document.getElementById("new-name").value = "";
        document.getElementById("new-dept").value = "";
        devicePage = 0;
        loadDevices();
        loadDashboardStats();
        if (typeof loadAudit === "function") loadAudit();
      };

      var userPage = 0;
      var userPageSize = 100;
      var userTotal = 0;
      async function loadUsers() {
        var tbody = document.getElementById("user-list");
        if (tbody) tbody.innerHTML = "<tr><td colspan=\"6\" class=\"loading-cell\">加载中...</td></tr>";
        var offset = userPage * userPageSize;
        var listUrl = "/api/users?limit=" + userPageSize + "&offset=" + offset;
        try {
          var listRes = await fetch(listUrl, { headers: authHeaders() });
          var countRes = await fetch("/api/users/count", { headers: authHeaders() });
          if (!listRes.ok) return;
          var list = await listRes.json();
          userTotal = countRes.ok ? (await countRes.json()).total : list.length;
          tbody = document.getElementById("user-list");
          if (!tbody) return;
          tbody.innerHTML = "";
          var roleLabels = { user: "普通用户", device_admin: "设备管理员", sys_admin: "系统管理员" };
          (list || []).forEach(function (u) {
            var tr = document.createElement("tr");
            var createdAt = u.created_at ? new Date(u.created_at).toLocaleString("zh-CN") : "";
            tr.innerHTML = "<td>" + (u.id || "") + "</td><td>" + escapeHtml(u.username || "—") + "</td><td>" + escapeHtml(u.real_name || "—") + "</td><td>" + escapeHtml(roleLabels[u.role] || u.role) + "</td><td>" + escapeHtml(u.dept || "—") + "</td><td>" + escapeHtml(createdAt) + "</td>";
            tbody.appendChild(tr);
          });
          var start = offset + 1;
          var end = offset + list.length;
          var pageInfo = document.getElementById("user-page-info");
          var btnPrev = document.getElementById("user-prev");
          var btnNext = document.getElementById("user-next");
          if (pageInfo) pageInfo.textContent = "共 " + userTotal + " 条，当前第 " + (userTotal ? start : 0) + "–" + end + " 条";
          if (btnPrev) btnPrev.disabled = userPage === 0;
          if (btnNext) btnNext.disabled = end >= userTotal;
        } catch (e) {}
      }
      var userPrevEl = document.getElementById("user-prev");
      var userNextEl = document.getElementById("user-next");
      if (userPrevEl) userPrevEl.onclick = function () { if (userPage > 0) { userPage--; loadUsers(); } };
      if (userNextEl) userNextEl.onclick = function () { if ((userPage + 1) * userPageSize < userTotal) { userPage++; loadUsers(); } };

      var usagePage = 0;
      var usagePageSize = 100;
      var usageTotal = 0;
      function buildUsageQueryParams(prefix) {
        var deviceInput = (document.getElementById("filter-device") && document.getElementById("filter-device").value || "").trim();
        var deviceCode = "";
        var codeMatch = deviceInput.match(/\(([^)]+)\)/);
        if (codeMatch && codeMatch[1]) deviceCode = codeMatch[1].replace(/\s*\[已停用\]\s*$/, "").trim();
        else deviceCode = deviceInput;
        var dept = (document.getElementById("filter-dept") && document.getElementById("filter-dept").value || "").trim();
        var regFrom = (document.getElementById("filter-reg-from") && document.getElementById("filter-reg-from").value) || "";
        var regTo = (document.getElementById("filter-reg-to") && document.getElementById("filter-reg-to").value) || "";
        var bed = (document.getElementById("filter-bed") && document.getElementById("filter-bed").value || "").trim();
        var from = (document.getElementById("filter-from") && document.getElementById("filter-from").value) || "";
        var to = (document.getElementById("filter-to") && document.getElementById("filter-to").value) || "";
        var s = prefix || "";
        if (deviceCode) s += "device_code=" + encodeURIComponent(deviceCode) + "&";
        if (dept) s += "dept=" + encodeURIComponent(dept) + "&";
        if (regFrom) s += "registration_date_from=" + encodeURIComponent(regFrom) + "&";
        if (regTo) s += "registration_date_to=" + encodeURIComponent(regTo) + "&";
        if (bed) s += "bed_number=" + encodeURIComponent(bed) + "&";
        if (from) s += "from_time=" + encodeURIComponent(from + "T00:00:00") + "&";
        if (to) s += "to_time=" + encodeURIComponent(to + "T23:59:59") + "&";
        return s;
      }
      async function loadUsageSuggest() {
        var res = await fetch("/api/devices/suggest?limit=50", { headers: authHeaders() });
        if (!res.ok) return;
        var list = await res.json();
        var deviceOptions = document.getElementById("device-options");
        var deptOptions = document.getElementById("dept-options");
        if (deviceOptions) { deviceOptions.innerHTML = ""; list.forEach(function (d) { var o = document.createElement("option"); o.textContent = (d.name || "") + " (" + (d.device_code || "") + ")"; o.value = (d.name || "") + " (" + (d.device_code || "") + ")"; deviceOptions.appendChild(o); }); }
        if (deptOptions) { var seen = {}; list.forEach(function (d) { if (d.dept && !seen[d.dept]) { seen[d.dept] = true; var o = document.createElement("option"); o.value = d.dept; deptOptions.appendChild(o); } }); }
      }
      async function loadUsage() {
        var usageListEl = document.getElementById("usage-list");
        if (usageListEl) usageListEl.innerHTML = "<tr><td colspan=\"14\" class=\"loading-cell\">加载中...</td></tr>";
        var offset = usagePage * usagePageSize;
        var queryParams = buildUsageQueryParams("limit=" + usagePageSize + "&offset=" + offset + "&");
        var countParams = buildUsageQueryParams("");
        var listUrl = "/api/usage?" + queryParams;
        var countUrl = "/api/usage/count?" + countParams;
        const [res, countRes] = await Promise.all([fetch(listUrl, { headers: authHeaders() }), fetch(countUrl, { headers: authHeaders() })]);
        const msg = document.getElementById("usage-msg");
        if (!res.ok) {
          msg.textContent = "加载失败";
          msg.className = "msg err";
          return;
        }
        const data = await res.json();
        usageTotal = countRes.ok ? (await countRes.json()).total : data.length;
        var usageTypeMap = {};
        try {
          var usageTypeRes = await fetch("/api/dict?dict_type=usage_type", { headers: authHeaders() });
          if (usageTypeRes.ok) {
            var usageTypeList = await usageTypeRes.json();
            usageTypeList.forEach(function (o) { usageTypeMap[o.code] = o.label || String(o.code); });
          }
        } catch (e) {}
        var usageTypeLabel = function (code) { return usageTypeMap[code] != null ? usageTypeMap[code] : (code != null ? String(code) : ""); };
        const tbody = document.getElementById("usage-list");
        tbody.innerHTML = "";
        function regDateStr(r) { return r.registration_date ? (typeof r.registration_date === "string" ? r.registration_date : new Date(r.registration_date).toISOString().slice(0, 10)) : ""; }
        function timeOnlyStr(iso) { return iso ? new Date(iso).toLocaleTimeString("zh-CN", { hour: "2-digit", minute: "2-digit" }) : ""; }
        function eqCondStr(v) { return v === "abnormal" ? "异常" : (v === "normal" ? "正常" : ""); }
        function dailyStr(v) { return v === "disinfect" ? "消毒" : (v === "clean" ? "清洁" : ""); }
        data.forEach(r => {
          const tr = document.createElement("tr");
          const deviceCol = (r.device_name ? r.device_name + "（" + (r.device_code ?? "") + "）" : (r.device_code ?? ""));
          const createdStr = r.created_at ? new Date(r.created_at).toLocaleString() : "";
          tr.innerHTML =
            "<td>" + escapeHtml(regDateStr(r)) + "</td>" +
            "<td>" + escapeHtml(createdStr) + "</td>" +
            "<td>" + escapeHtml(deviceCol) + "</td>" +
            "<td>" + escapeHtml(r.bed_number ?? "") + "</td>" +
            "<td>" + escapeHtml(r.id_number ?? "") + "</td>" +
            "<td>" + escapeHtml(r.patient_name ?? "") + "</td>" +
            "<td>" + escapeHtml(timeOnlyStr(r.start_time)) + "</td>" +
            "<td>" + escapeHtml(timeOnlyStr(r.end_time)) + "</td>" +
            "<td>" + escapeHtml(r.user_name ?? r.user_id ?? "") + "</td>" +
            "<td>" + escapeHtml(usageTypeLabel(r.usage_type)) + "</td>" +
            "<td>" + escapeHtml(eqCondStr(r.equipment_condition)) + "</td>" +
            "<td>" + escapeHtml(dailyStr(r.daily_maintenance)) + "</td>" +
            "<td>" + escapeHtml((r.terminal_disinfection ?? "").slice(0, 30)) + "</td>" +
            "<td>" + escapeHtml((r.note ?? "").slice(0, 40)) + "</td>";
          tbody.appendChild(tr);
        });
        var start = offset + 1;
        var end = offset + data.length;
        document.getElementById("usage-page-info").textContent = "共 " + usageTotal + " 条，当前第 " + (usageTotal ? start : 0) + "–" + end + " 条";
        document.getElementById("usage-prev").disabled = usagePage === 0;
        document.getElementById("usage-next").disabled = end >= usageTotal;
        msg.textContent = "";
        msg.className = "msg";
      }
      document.getElementById("usage-prev").onclick = function () { if (usagePage > 0) { usagePage--; loadUsage(); } };
      document.getElementById("usage-next").onclick = function () { if ((usagePage + 1) * usagePageSize < usageTotal) { usagePage++; loadUsage(); } };

      document.getElementById("btn-query").onclick = function () { usagePage = 0; loadUsage(); };

      function buildExportUrl(format) {
        var deviceInput = (document.getElementById("filter-device") && document.getElementById("filter-device").value || "").trim();
        var deviceCode = "";
        var codeMatch = deviceInput.match(/\(([^)]+)\)/);
        if (codeMatch && codeMatch[1]) deviceCode = codeMatch[1].replace(/\s*\[已停用\]\s*$/, "").trim();
        else deviceCode = deviceInput;
        var dept = (document.getElementById("filter-dept") && document.getElementById("filter-dept").value || "").trim();
        var regFrom = (document.getElementById("filter-reg-from") && document.getElementById("filter-reg-from").value) || "";
        var regTo = (document.getElementById("filter-reg-to") && document.getElementById("filter-reg-to").value) || "";
        var bed = (document.getElementById("filter-bed") && document.getElementById("filter-bed").value || "").trim();
        var from = (document.getElementById("filter-from") && document.getElementById("filter-from").value) || "";
        var to = (document.getElementById("filter-to") && document.getElementById("filter-to").value) || "";
        var url = "/api/usage/export?format=" + encodeURIComponent(format);
        if (deviceCode) url += "&device_code=" + encodeURIComponent(deviceCode);
        if (dept) url += "&dept=" + encodeURIComponent(dept);
        if (regFrom) url += "&registration_date_from=" + encodeURIComponent(regFrom);
        if (regTo) url += "&registration_date_to=" + encodeURIComponent(regTo);
        if (bed) url += "&bed_number=" + encodeURIComponent(bed);
        if (from) url += "&from_time=" + encodeURIComponent(from + "T00:00:00");
        if (to) url += "&to_time=" + encodeURIComponent(to + "T23:59:59");
        return url;
      }
      async function doExport(format) {
        var btnCsv = document.getElementById("btn-export");
        var btnXlsx = document.getElementById("btn-export-xlsx");
        var btnPdf = document.getElementById("btn-export-pdf");
        if (btnCsv) { btnCsv.disabled = true; btnCsv.textContent = "导出中..."; }
        if (btnXlsx) { btnXlsx.disabled = true; btnXlsx.textContent = "导出中..."; }
        if (btnPdf) { btnPdf.disabled = true; btnPdf.textContent = "导出中..."; }
        try {
          var msgEl = document.getElementById("usage-msg");
          var res = await fetch(buildExportUrl(format), { headers: authHeaders() });
          if (!res.ok) {
            var errBody = await res.json().catch(function () { return {}; });
            msgEl.textContent = errBody.detail || "导出失败（需管理员权限或条件范围内记录超过 5 万条）";
            msgEl.className = "msg err";
            return;
          }
          var blob = await res.blob();
          var names = { csv: "usage_records.csv", xlsx: "usage_records.xlsx", pdf: "usage_records.pdf" };
          var a = document.createElement("a");
          a.href = URL.createObjectURL(blob);
          a.download = names[format] || "usage_records.csv";
          a.click();
          URL.revokeObjectURL(a.href);
          msgEl.textContent = "已导出";
          msgEl.className = "msg ok";
        } finally {
          if (btnCsv) { btnCsv.disabled = false; btnCsv.textContent = "导出 CSV"; }
          if (btnXlsx) { btnXlsx.disabled = false; btnXlsx.textContent = "导出 Excel"; }
          if (btnPdf) { btnPdf.disabled = false; btnPdf.textContent = "导出 PDF"; }
        }
      }
      document.getElementById("btn-export").onclick = function () { doExport("csv"); };
      document.getElementById("btn-export-xlsx").onclick = function () { doExport("xlsx"); };
      document.getElementById("btn-export-pdf").onclick = function () { doExport("pdf"); };

      function parseDeviceCodeFromDetails(details) {
        if (!details || details.indexOf("device_code=") !== 0) return { code: "", rest: details };
        var s = details.slice("device_code=".length);
        var comma = s.indexOf(",");
        if (comma >= 0) return { code: s.slice(0, comma), rest: s.slice(comma + 1).trim() };
        return { code: s, rest: "" };
      }
      function deviceLabelFromAuditRow(r, parsed) {
        var code = (parsed && parsed.code) ? parsed.code : (r.target_code != null && r.target_code !== "" ? String(r.target_code) : "");
        return code ? "设备" + code : (r.target_id != null ? "设备 ID " + r.target_id : "");
      }
      function formatAuditRow(r) {
        var action = r.action || "";
        var details = (r.details != null && r.details !== "") ? String(r.details) : "";
        var targetId = r.target_id != null ? r.target_id : "";
        var summary = "";
        var note = "";
        if (action === "device.create") {
          summary = "新增设备";
          var parsedCreate = parseDeviceCodeFromDetails(details);
          note = deviceLabelFromAuditRow(r, parsedCreate.code ? { code: parsedCreate.code } : null);
          if (!note && details) note = details;
        } else if (action === "device.update") {
          summary = "修改设备信息";
          var parsed = parseDeviceCodeFromDetails(details);
          note = deviceLabelFromAuditRow(r, parsed);
          if (parsed.rest) {
            var labels = { name: "名称", dept: "科室", location: "位置", status: "状态", is_active: "启用状态" };
            var parts = parsed.rest.split(",").map(function (k) { return labels[k.trim()] || k.trim(); });
            note = (note ? note + "；" : "") + "修改项：" + parts.join("、");
          }
        } else if (action === "device.delete") {
          summary = "删除设备（可勾选「只显示已删除」后恢复）";
          var parsed = parseDeviceCodeFromDetails(details);
          note = deviceLabelFromAuditRow(r, parsed);
        } else if (action === "device.restore") {
          summary = "恢复已删除的设备";
          var parsed = parseDeviceCodeFromDetails(details);
          note = deviceLabelFromAuditRow(r, parsed);
        } else if (action === "usage.export") {
          var m = details.match(/format=(\w+),count=(\d+)/);
          if (m) {
            var fmtName = { csv: "CSV", xlsx: "Excel", pdf: "PDF" }[m[1]] || m[1];
            summary = "导出使用记录（" + fmtName + "，共 " + m[2] + " 条）";
          } else {
            summary = "导出使用记录";
            if (details) note = details;
          }
        } else if (action === "auth.login") {
          if (details === "wecom") {
            summary = "登录系统（企业微信）";
          } else if (details === "password") {
            summary = "登录系统（账号密码）";
          } else {
            summary = "登录系统";
            if (details) note = details;
          }
        } else {
          summary = action || "—";
          if (details || targetId) note = [details, targetId ? "ID " + targetId : ""].filter(Boolean).join(" ");
        }
        return { summary: summary, note: note || "—" };
      }
      async function loadAudit() {
        const action = (document.getElementById("audit-filter-action") && document.getElementById("audit-filter-action").value) || "";
        const fromVal = (document.getElementById("audit-filter-from") && document.getElementById("audit-filter-from").value) || "";
        const toVal = (document.getElementById("audit-filter-to") && document.getElementById("audit-filter-to").value) || "";
        let url = "/api/audit-logs?limit=200";
        if (action) url += "&action=" + encodeURIComponent(action);
        if (fromVal) url += "&from_time=" + encodeURIComponent(fromVal + ":00");
        if (toVal) url += "&to_time=" + encodeURIComponent(toVal + ":59");
        const res = await fetch(url, { headers: authHeaders() });
        const msgEl = document.getElementById("audit-msg");
        const tbody = document.getElementById("audit-list");
        if (!tbody) return;
        tbody.innerHTML = "";
        if (!res.ok) {
          if (msgEl) { msgEl.textContent = "加载失败（需管理员权限）"; msgEl.className = "msg err"; }
          return;
        }
        const data = await res.json().catch(function () { return []; });
        data.forEach(function (r) {
          const tr = document.createElement("tr");
          const timeStr = r.created_at ? new Date(r.created_at).toLocaleString() : "";
          const actor = (r.actor_name != null && r.actor_name !== "") ? r.actor_name : ("#" + (r.actor_id || ""));
          var formatted = formatAuditRow(r);
          tr.innerHTML = "<td>" + escapeHtml(timeStr) + "</td><td>" + escapeHtml(actor || "—") + "</td><td>" + escapeHtml(formatted.summary) + "</td><td>" + escapeHtml(formatted.note) + "</td>";
          tbody.appendChild(tr);
        });
        if (msgEl) { msgEl.textContent = "共 " + data.length + " 条"; msgEl.className = "msg"; }
      }
      if (document.getElementById("btn-audit-query")) {
        document.getElementById("btn-audit-query").onclick = loadAudit;
      }

      async function loadDict() {
        const url = "/api/dict?include_inactive=1&include_deleted=1";
        const res = await fetch(url, { headers: authHeaders() });
        if (!res.ok) {
          var msgEl = document.getElementById("dict-usage-msg");
          if (msgEl) { msgEl.textContent = "加载失败（" + res.status + "），请确认已登录"; msgEl.className = "msg err"; }
          renderDictTbody("dict-usage-tbody", []);
          renderDictTbody("dict-status-tbody", []);
          return;
        }
        const all = await res.json().catch(function () { return []; });
        const usage = all.filter(function (d) { return d.dict_type === "usage_type"; });
        const status = all.filter(function (d) { return d.dict_type === "device_status"; });
        document.getElementById("dict-usage-msg").textContent = "";
        document.getElementById("dict-usage-msg").className = "msg";
        renderDictTbody("dict-usage-tbody", usage);
        renderDictTbody("dict-status-tbody", status);
      }
      function renderDictTbody(tbodyId, list) {
        const tbody = document.getElementById(tbodyId);
        tbody.innerHTML = "";
        list.forEach(function (d) {
          const tr = document.createElement("tr");
          if (d.is_deleted) tr.classList.add("dict-row-deleted");
          const statusText = d.is_deleted ? "—" : (d.is_active ? "启用" : "停用");
          const deletedText = d.is_deleted ? "是" : "否";
          const actions = [];
          if (d.is_deleted) {
            actions.push("<button type=\"button\" class=\"dict-restore\" data-id=\"" + d.id + "\">恢复</button>");
          } else {
            actions.push("<button type=\"button\" class=\"dict-edit\" data-id=\"" + d.id + "\" data-label=\"" + escapeHtml(d.label || "") + "\">编辑</button>");
            actions.push("<button type=\"button\" class=\"dict-delete\" data-id=\"" + d.id + "\">删除</button>");
            actions.push(d.is_active
              ? "<button type=\"button\" class=\"dict-disable\" data-id=\"" + d.id + "\">停用</button>"
              : "<button type=\"button\" class=\"dict-enable\" data-id=\"" + d.id + "\">启用</button>");
          }
          tr.innerHTML = "<td>" + (d.code != null ? escapeHtml(String(d.code)) : "") + "</td><td class=\"dict-label-cell\">" + escapeHtml(d.label || "") + "</td><td>" + escapeHtml(statusText) + "</td><td>" + escapeHtml(deletedText) + "</td><td>" + actions.join(" ") + "</td>";
          tr.dataset.id = d.id;
          tbody.appendChild(tr);
        });
        tbody.querySelectorAll(".dict-edit").forEach(function (btn) {
          btn.onclick = function () { dictEdit(btn.dataset.id, btn.dataset.label, tbody); };
        });
        tbody.querySelectorAll(".dict-delete").forEach(function (btn) {
          btn.onclick = function () { dictSoftDelete(parseInt(btn.dataset.id, 10)); };
        });
        tbody.querySelectorAll(".dict-restore").forEach(function (btn) {
          btn.onclick = function () { dictRestore(parseInt(btn.dataset.id, 10)); };
        });
        tbody.querySelectorAll(".dict-enable").forEach(function (btn) {
          btn.onclick = function () { dictSetActive(parseInt(btn.dataset.id, 10), true); };
        });
        tbody.querySelectorAll(".dict-disable").forEach(function (btn) {
          btn.onclick = function () { dictSetActive(parseInt(btn.dataset.id, 10), false); };
        });
      }
      function dictEdit(id, label, tbody) {
        const tr = tbody.querySelector("tr[data-id=\"" + id + "\"]");
        if (!tr) return;
        const cell = tr.querySelector(".dict-label-cell");
        const oldHtml = cell.innerHTML;
        cell.innerHTML = "<input type=\"text\" class=\"dict-edit-input\" value=\"" + escapeHtml(label || "") + "\" /> <button type=\"button\" class=\"dict-save\">保存</button> <button type=\"button\" class=\"dict-cancel\">取消</button>";
        const input = cell.querySelector(".dict-edit-input");
        cell.querySelector(".dict-save").onclick = async function () {
          const newLabel = input.value.trim();
          const res = await fetch("/api/dict/" + id, {
            method: "PATCH",
            headers: { "Content-Type": "application/json", ...authHeaders() },
            body: JSON.stringify({ label: newLabel })
          });
          if (res.ok) loadDict(); else alert((await res.json().catch(function(){return{};})).detail || "保存失败");
        };
        cell.querySelector(".dict-cancel").onclick = function () { cell.innerHTML = oldHtml; };
      }
      async function dictSoftDelete(id) {
        if (!confirm("确定删除？仅打标识，不物理删除。")) return;
        const res = await fetch("/api/dict/" + id, { method: "DELETE", headers: authHeaders() });
        if (res.ok) loadDict(); else alert((await res.json().catch(function(){return{};})).detail || "删除失败");
      }
      async function dictRestore(id) {
        const res = await fetch("/api/dict/" + id + "/restore", { method: "POST", headers: authHeaders() });
        if (res.ok) loadDict(); else alert((await res.json().catch(function(){return{};})).detail || "恢复失败");
      }
      async function dictSetActive(id, active) {
        const res = await fetch("/api/dict/" + id, {
          method: "PATCH",
          headers: { "Content-Type": "application/json", ...authHeaders() },
          body: JSON.stringify({ is_active: active })
        });
        if (res.ok) loadDict(); else alert((await res.json().catch(function(){return{};})).detail || "操作失败");
      }
      document.getElementById("dict-usage-add").onclick = async function () {
        const codeVal = document.getElementById("dict-usage-code").value;
        const code = codeVal === "" ? NaN : parseInt(codeVal, 10);
        const label = document.getElementById("dict-usage-label").value.trim();
        const msg = document.getElementById("dict-usage-msg");
        if (!label || isNaN(code) || code < 1) { msg.textContent = "请填写有效数字编码（≥1）和显示名称"; msg.className = "msg err"; return; }
        msg.textContent = "提交中..."; msg.className = "msg";
        const res = await fetch("/api/dict", {
          method: "POST",
          headers: { "Content-Type": "application/json", ...authHeaders() },
          body: JSON.stringify({ dict_type: "usage_type", code: code, label: label })
        });
        if (!res.ok) {
          const err = await res.json().catch(function(){return{};});
          msg.textContent = err.detail || "新增失败"; msg.className = "msg err";
          return;
        }
        msg.textContent = "已添加"; msg.className = "msg ok";
        document.getElementById("dict-usage-code").value = ""; document.getElementById("dict-usage-label").value = "";
        loadDict();
      };
      document.getElementById("dict-status-add").onclick = async function () {
        const codeVal = document.getElementById("dict-status-code").value;
        const code = codeVal === "" ? NaN : parseInt(codeVal, 10);
        const label = document.getElementById("dict-status-label").value.trim();
        const msg = document.getElementById("dict-status-msg");
        if (!label || isNaN(code) || code < 1) { msg.textContent = "请填写有效数字编码（≥1）和显示名称"; msg.className = "msg err"; return; }
        msg.textContent = "提交中..."; msg.className = "msg";
        const res = await fetch("/api/dict", {
          method: "POST",
          headers: { "Content-Type": "application/json", ...authHeaders() },
          body: JSON.stringify({ dict_type: "device_status", code: code, label: label })
        });
        if (!res.ok) {
          const err = await res.json().catch(function(){return{};});
          msg.textContent = err.detail || "新增失败"; msg.className = "msg err";
          return;
        }
        msg.textContent = "已添加"; msg.className = "msg ok";
        document.getElementById("dict-status-code").value = ""; document.getElementById("dict-status-label").value = "";
        loadDict();
      };

      function bindLoginForm() {
        const btn = document.getElementById("btn-login");
        const msg = document.getElementById("login-msg");
        if (!btn) return;
        btn.onclick = async function () {
          const username = document.getElementById("login-username").value.trim();
          const password = document.getElementById("login-password").value;
          if (!username) { msg.textContent = "请输入用户名"; msg.className = "msg err"; return; }
          msg.textContent = "登录中...";
          msg.className = "msg";
          const res = await fetch("/api/auth/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username: username, password: password || "" })
          });
          const data = await res.json().catch(() => ({}));
          if (!res.ok) {
            msg.textContent = data.detail || "登录失败";
            msg.className = "msg err";
            return;
          }
          try { localStorage.setItem("device_scan_token", data.access_token); } catch (e) {}
          msg.textContent = "登录成功，正在加载...";
          msg.className = "msg ok";
          location.reload();
        };
      }

      if (logoutBtn) {
        logoutBtn.onclick = function () {
          try { localStorage.removeItem("device_scan_token"); } catch (e) {}
          location.reload();
        };
      }

      (async function () {
        if (!await checkAdmin()) {
          bindLoginForm();
          return;
        }
        loadDashboardStats();
        loadDevices();
        loadUsage();
        initAllResizableTables();
        var deviceDeletedOnlyEl = document.getElementById("device-deleted-only");
        var deviceInactiveOnlyEl = document.getElementById("device-inactive-only");
        if (deviceDeletedOnlyEl) deviceDeletedOnlyEl.addEventListener("change", function () { if (deviceDeletedOnlyEl.checked && deviceInactiveOnlyEl) deviceInactiveOnlyEl.checked = false; devicePage = 0; loadDevices(); });
        if (deviceInactiveOnlyEl) deviceInactiveOnlyEl.addEventListener("change", function () { if (deviceInactiveOnlyEl.checked && deviceDeletedOnlyEl) deviceDeletedOnlyEl.checked = false; devicePage = 0; loadDevices(); });
      })();
    </script>
  </body>
</html>
