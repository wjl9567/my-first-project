<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>åå°ç®¡ç† - è®¾å¤‡æ‰«ç ç™»è®°</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      /* ç»Ÿä¸€è®¾è®¡è¯­è¨€ï¼šé’ç»¿ä¸»è‰²ã€ç•™ç™½ã€åœ†è§’ 12pxã€è½»é˜´å½± */
      :root {
        --primary: #0d9488;
        --primary-dark: #0f766e;
        --primary-darker: #134e4a;
        --primary-tint: #ccfbf1;
        --primary-bg: #f0fdfa;
        --surface: #ffffff;
        --card-bg: #ffffff;
        --bg-page: #f8fafc;
        --border: #e2e8f0;
        --text: #334155;
        --text-muted: #64748b;
        --radius: 12px;
        --radius-sm: 10px;
        --shadow: 0 2px 8px rgba(13, 148, 136, 0.06);
        --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.06);
      }
      * { box-sizing: border-box; }
      body {
        font-family: "PingFang SC", "Microsoft YaHei", -apple-system, BlinkMacSystemFont, sans-serif;
        margin: 0;
        min-height: 100vh;
        background: var(--bg-page);
        color: var(--text);
      }

      /* ç™»å½•é¡µï¼šä¸ H5 åŒæ¬¾èƒŒæ™¯ï¼Œå¡ç‰‡ç»Ÿä¸€é£æ ¼ */
      .login-wrap {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 24px;
        background: linear-gradient(160deg, #f0fdfa 0%, #e0f2fe 35%, #f0f9ff 100%);
      }
      .login-prompt {
        background: var(--surface);
        border-radius: 16px;
        box-shadow: var(--shadow);
        padding: 40px;
        max-width: 400px;
        width: 100%;
        text-align: center;
        border: 1px solid var(--border);
      }
      .login-prompt h1 { margin: 0 0 8px; font-size: 22px; color: var(--primary-dark); font-weight: 600; }
      .login-prompt .login-sub { color: var(--text-muted); margin: 0 0 24px; font-size: 14px; }
      .login-form { text-align: left; margin-top: 20px; }
      .login-form .form-row { margin-bottom: 16px; }
      .login-form label { display: block; margin-bottom: 6px; color: var(--text); font-weight: 500; font-size: 14px; }
      .login-form input {
        width: 100%;
        padding: 12px 14px;
        border-radius: var(--radius-sm);
        border: 1px solid var(--border);
        font-size: 15px;
      }
      .login-form input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.12); }
      .login-form button {
        width: 100%;
        margin-top: 8px;
        padding: 12px 16px;
        border-radius: var(--radius-sm);
        border: none;
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: #fff;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
      }
      .login-form button:hover { opacity: 0.95; }
      .login-divider { margin: 24px 0 16px; color: var(--text-muted); font-size: 13px; }
      .msg { font-size: 14px; margin-top: 10px; min-height: 22px; }
      .msg.err { color: #dc2626; font-weight: 500; }
      .msg.ok { color: #059669; font-weight: 500; }
      .login-prompt a { color: var(--primary); font-weight: 600; text-decoration: none; }
      .login-prompt a:hover { text-decoration: underline; }

      /* ç®¡ç†å¸ƒå±€ï¼šä¾§æ  + ä¸»åŒº */
      .admin-layout { display: flex; min-height: 100vh; height: 100vh; }
      .admin-sidebar {
        width: 220px;
        background: linear-gradient(180deg, var(--primary-dark) 0%, var(--primary-darker) 100%);
        color: #fff;
        flex-shrink: 0;
        display: flex;
        flex-direction: column;
      }
      .admin-sidebar .logo {
        padding: 20px 16px;
        font-size: 17px;
        font-weight: 600;
        letter-spacing: 0.02em;
        border-bottom: 1px solid rgba(255,255,255,0.12);
      }
      .admin-nav { padding: 12px 0; }
      .admin-nav a {
        display: block;
        padding: 12px 20px;
        color: rgba(255,255,255,0.88);
        text-decoration: none;
        font-size: 14px;
        transition: background 0.2s, color 0.2s;
      }
      .admin-nav a:hover { background: rgba(255,255,255,0.1); color: #fff; }
      .admin-nav a.active { background: rgba(255,255,255,0.18); color: #fff; font-weight: 600; }
      .sidebar-version {
        margin-top: auto;
        padding: 16px 20px 20px;
        font-size: 12px;
        color: rgba(255,255,255,0.55);
      }

      /* ä¸»å†…å®¹åŒºï¼šé¡¶æ ä¸å†…å®¹ç»Ÿä¸€èƒŒæ™¯ */
      .admin-main {
        flex: 1;
        overflow: auto;
        height: 100vh;
        padding: 24px;
        background: var(--bg-page);
      }
      .admin-topbar {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: 16px;
        padding: 14px 20px;
        margin-bottom: 20px;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow-sm);
      }
      .admin-topbar .user-name {
        font-size: 14px;
        color: var(--primary-dark);
        font-weight: 600;
      }
      .admin-topbar .logout-btn {
        padding: 8px 16px;
        border-radius: var(--radius-sm);
        border: none;
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: #fff;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
      }
      .admin-topbar .logout-btn:hover { opacity: 0.92; }

      .admin-main h2 {
        margin: 0 0 20px;
        font-size: 20px;
        font-weight: 600;
        color: var(--primary-dark);
        padding-bottom: 12px;
        border-bottom: 2px solid var(--primary-tint);
      }
      .admin-panel { display: none; }
      .admin-panel.active { display: block; }

      .card {
        background: var(--surface);
        border-radius: var(--radius);
        box-shadow: var(--shadow-sm);
        padding: 24px;
        margin-bottom: 20px;
        border: 1px solid var(--border);
      }
      .card h3 { margin: 0 0 16px; font-size: 16px; font-weight: 600; color: var(--text); }
      table { width: 100%; border-collapse: collapse; font-size: 14px; }
      th, td { padding: 12px 16px; border-bottom: 1px solid var(--border); text-align: left; }
      th {
        background: var(--primary-bg);
        color: var(--primary-dark);
        font-weight: 600;
        font-size: 13px;
      }
      tbody tr:hover { background: #f5f7fa; }
      tbody tr.inactive-row { background: #f1f5f9; color: var(--text-muted); }
      .btn-disable { background: #b91c1c !important; color: #fff !important; padding: 6px 12px !important; font-size: 13px !important; border-radius: var(--radius-sm) !important; }
      .btn-enable { background: #059669 !important; color: #fff !important; padding: 6px 12px !important; font-size: 13px !important; border-radius: var(--radius-sm) !important; }
      input, select {
        padding: 10px 14px;
        border-radius: var(--radius-sm);
        border: 1px solid var(--border);
        font-size: 14px;
      }
      input:focus, select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.1); }
      button {
        padding: 10px 18px;
        border-radius: var(--radius-sm);
        border: none;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
      }
      button:not(.secondary) {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: #fff;
      }
      button.secondary { background: var(--text-muted); color: #fff; }
      .pagination-wrap { margin-top: 12px; display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
      .pagination-wrap button { padding: 8px 14px; }
      button:disabled { opacity: 0.6; cursor: not-allowed; }
      .form-row { margin-bottom: 12px; }
      .form-row label { display: inline-block; width: 90px; color: var(--text); font-weight: 500; }
      .flex { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
      .mb { margin-bottom: 16px; }
      a { color: var(--primary); font-weight: 500; text-decoration: none; }
      a:hover { text-decoration: underline; }

      .stat-cards { display: flex; gap: 16px; flex-wrap: wrap; margin-bottom: 24px; }
      .stat-card {
        background: var(--surface);
        border-radius: var(--radius);
        padding: 20px 24px;
        min-width: 160px;
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--border);
        border-left: 4px solid var(--primary);
      }
      .stat-card .label { font-size: 13px; color: var(--text-muted); margin-bottom: 4px; }
      .stat-card .value { font-size: 24px; font-weight: 600; color: var(--primary-dark); }
      .stat-card-clickable { cursor: pointer; transition: box-shadow 0.2s, background 0.2s; }
      .stat-card-clickable:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); background: var(--bg-elevated); }
      .dict-table { min-width: 520px; border-collapse: collapse; width: 100%; }
      .dict-table td:first-child { font-weight: 500; color: var(--text); }
      .dict-table th, .dict-table td { padding: 10px 14px; font-size: 13px; border-bottom: 1px solid #e5e7eb; }
      .dict-table tbody tr:nth-child(odd) { background: #fff; }
      .dict-table tbody tr:nth-child(even) { background: #f8fafc; }
      .dict-table tbody tr:hover td { background: #f5f7fa !important; }
      .dict-table .dict-row-deleted { background: #f8fafc; color: var(--text-muted); }
      .dict-table button { padding: 6px 10px; font-size: 12px; margin-right: 4px; }
      .dict-table .dict-edit-input { width: 120px; padding: 4px 8px; margin-right: 6px; }
      .dict-desc { color: var(--text-muted); margin: 4px 0 14px; font-size: 14px; }
      .dict-pill-status {
        display: inline-block;
        padding: 2px 10px;
        border-radius: 999px;
        font-size: 12px;
        line-height: 1.4;
        font-weight: 500;
      }
      .dict-pill-status-on { background: #22c55e; color: #fff; }
      .dict-pill-status-off { background: #94a3b8; color: #fff; }
      .dict-pill-deleted {
        display: inline-block;
        padding: 2px 10px;
        border-radius: 999px;
        font-size: 12px;
        line-height: 1.4;
        font-weight: 500;
        background: #e5e7eb;
        color: #4b5563;
      }
      .device-filter-row { flex-wrap: wrap; gap: 10px 16px; align-items: center; }
      .device-filter-row .device-actions-group { margin-left: auto; display: flex; gap: 8px; flex-wrap: wrap; }
      .device-flag-filters {
        display: inline-flex;
        align-items: center;
        gap: 12px;
        padding: 4px 12px;
        border-radius: 999px;
        background: #f1f5f9;
      }
      .device-show-deleted-wrap,
      .device-show-inactive-wrap {
        font-weight: 500;
        color: var(--text);
        margin: 0;
      }
      .device-show-deleted-wrap input,
      .device-show-inactive-wrap input { margin-right: 6px; }
      #table-devices tbody tr:nth-child(odd) { background: #fff; }
      #table-devices tbody tr:nth-child(even) { background: #f8fafc; }
      #table-devices th:first-child,
      #table-devices td.device-code-cell { text-align: center; }
      tbody tr.device-row-deleted { background: #f1f5f9 !important; color: var(--text-muted); }
      #table-devices tbody tr.inactive-row { background: #f1f5f9 !important; }
      .device-edit-input { width: 90px; padding: 4px 8px; margin-right: 4px; }
      .device-edit-select { min-width: 80px; padding: 4px 8px; margin-right: 4px; }
      #table-devices tbody tr:hover { background: #f5f7fa; }
      #table-devices td button { margin-right: 6px; }
      .device-status-pill {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 12px;
        line-height: 1.4;
        font-weight: 500;
      }
      .device-status-pill-ok { background: #ecfdf5; color: #16a34a; }
      .device-status-pill-warn { background: #fef3c7; color: #92400e; }
      .device-status-pill-bad { background: #fee2e2; color: #b91c1c; }
      .device-active-pill {
        display: inline-block;
        padding: 2px 10px;
        border-radius: 999px;
        font-size: 12px;
        line-height: 1.4;
        font-weight: 500;
      }
      .device-active-pill-on { background: #22c55e; color: #fff; font-weight: 600; }
      .device-active-pill-off { background: #94a3b8; color: #fff; font-weight: 500; }
      .device-qrcode-link {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        font-size: 13px;
        background: none;
        border: none;
        cursor: pointer;
        color: var(--link-color, #2563eb);
        padding: 0;
      }
      .device-qrcode-link:hover { text-decoration: underline; }
      .device-qrcode-link .qr-icon {
        width: 14px;
        height: 14px;
        border: 2px solid currentColor;
        border-radius: 2px;
        box-sizing: border-box;
      }
      .device-qrcode-disabled {
        font-size: 12px;
        color: #9ca3af;
        background: #f3f4f6;
        border-radius: 999px;
        padding: 2px 10px;
        display: inline-block;
      }
      .device-qr-modal {
        position: fixed;
        inset: 0;
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 16px;
      }
      .device-qr-modal-backdrop {
        position: absolute;
        inset: 0;
        background: rgba(0,0,0,0.5);
      }
      .device-qr-modal-box {
        position: relative;
        background: var(--card-bg);
        border-radius: 8px;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      }
      .device-qr-modal-box img { max-width: 280px; max-height: 280px; display: block; }
      .device-qr-modal-box button { align-self: center; }

      /* ç”¨æˆ·ç®¡ç†ï¼šä¿®æ”¹å¯†ç å¼¹çª—ï¼ˆä¸äºŒç»´ç å¼¹çª—åŒé£æ ¼ï¼‰ */
      .user-pw-modal {
        position: fixed;
        inset: 0;
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 16px;
      }
      .user-pw-modal-backdrop {
        position: absolute;
        inset: 0;
        background: rgba(0,0,0,0.5);
      }
      .user-pw-modal-box {
        position: relative;
        z-index: 1;
        background: #fff;
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 20px;
        width: min(520px, calc(100vw - 32px));
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      }
      .user-row-actions { display: flex; gap: 8px; flex-wrap: wrap; }

      /* è®¾å¤‡ç®¡ç†è¡¨æ ¼ï¼šç‹¬ç«‹æ¨ªå‘æ»šåŠ¨ã€åº•éƒ¨å›ºå®šæ»šåŠ¨æ¡ï¼ˆä¸ä½¿ç”¨è®°å½•æŸ¥è¯¢ä¸€è‡´ï¼‰ */
      .device-table-scroll-outer { position: relative; margin: 0 -4px 12px; }
      .device-table-wrap {
        overflow-x: auto;
        overflow-y: hidden;
        -webkit-overflow-scrolling: touch;
        border: 1px solid var(--border);
        border-bottom: none;
        border-radius: var(--radius-sm) var(--radius-sm) 0 0;
        background: var(--surface);
        max-width: 100%;
        scrollbar-width: none;
        -ms-overflow-style: none;
      }
      .device-table-wrap::-webkit-scrollbar { display: none; }
      .device-table-h-scroll {
        position: sticky;
        bottom: 0;
        left: 0;
        right: 0;
        overflow-x: auto;
        overflow-y: hidden;
        height: 14px;
        background: var(--surface);
        border: 1px solid var(--border);
        border-top: 1px solid #e2e8f0;
        border-radius: 0 0 var(--radius-sm) var(--radius-sm);
        z-index: 4;
        -webkit-overflow-scrolling: touch;
      }
      .device-table-h-scroll-inner { height: 1px; pointer-events: none; }
      .device-table-h-scroll::-webkit-scrollbar { height: 10px; }
      .device-table-h-scroll::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 5px; }
      .device-table-h-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 5px; }
      .device-table-h-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
      .device-table-h-scroll { scrollbar-width: thin; scrollbar-color: #cbd5e1 #f1f5f9; }
      #table-devices { margin-bottom: 0; }

      /* è¡¨å¤´åˆ—å®½æ‹–æ‹½ï¼šå›ºå®šè¡¨å¤´ã€ä¸æ¢è¡Œï¼Œåˆ—å®½è°ƒæ•´åå¯å®Œæ•´å±•ç¤ºå†…å®¹ */
      .resizable-cols { table-layout: fixed; }
      .resizable-cols th, .resizable-cols td {
        white-space: nowrap;
        overflow-x: auto;
        box-sizing: border-box;
      }
      .resizable-cols th { position: relative; }
      .resizable-cols .col-resize-handle {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        width: 8px;
        cursor: col-resize;
        user-select: none;
        -webkit-user-select: none;
        z-index: 1;
      }
      .resizable-cols .col-resize-handle:hover { background: rgba(13, 148, 136, 0.15); }
      .resizable-cols .col-resize-handle:active { background: rgba(13, 148, 136, 0.25); }
      body.col-resizing { cursor: col-resize; user-select: none; }
      .loading-cell { text-align: center; color: var(--text-muted); padding: 24px !important; }

      /* ä½¿ç”¨è®°å½•æŸ¥è¯¢ï¼šè¡¨æ ¼ç‹¬ç«‹æ¨ªå‘æ»šåŠ¨ã€å›ºå®šå·¦ä¾§å¿…é€‰åˆ—ã€æ–‘é©¬çº¹ã€è¡Œé«˜ä¸æ‚¬åœ */
      .usage-table-scroll-outer { position: relative; margin: 0 -4px 12px; }
      .usage-table-wrap {
        overflow-x: auto;
        overflow-y: hidden;
        -webkit-overflow-scrolling: touch;
        margin: 0 0 0 0;
        border: 1px solid var(--border);
        border-bottom: none;
        border-radius: var(--radius-sm) var(--radius-sm) 0 0;
        background: var(--surface);
        max-width: 100%;
        scrollbar-width: none;
        -ms-overflow-style: none;
      }
      .usage-table-wrap::-webkit-scrollbar { display: none; }
      .usage-table-h-scroll {
        position: sticky;
        bottom: 0;
        left: 0;
        right: 0;
        overflow-x: auto;
        overflow-y: hidden;
        height: 14px;
        background: var(--surface);
        border: 1px solid var(--border);
        border-top: 1px solid #e2e8f0;
        border-radius: 0 0 var(--radius-sm) var(--radius-sm);
        z-index: 4;
        -webkit-overflow-scrolling: touch;
      }
      .usage-table-h-scroll-inner { height: 1px; pointer-events: none; }
      .usage-table-h-scroll::-webkit-scrollbar { height: 10px; }
      .usage-table-h-scroll::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 5px; }
      .usage-table-h-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 5px; }
      .usage-table-h-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
      .usage-table-h-scroll { scrollbar-width: thin; scrollbar-color: #cbd5e1 #f1f5f9; }
      /* å®¡è®¡æ—¥å¿—è¡¨æ ¼ï¼šå¤ç”¨ä¸ä½¿ç”¨è®°å½•ç±»ä¼¼çš„è¡¨æ ¼è§†è§‰ */
      .audit-filters {
        display: flex;
        flex-wrap: wrap;
        gap: 10px 16px;
        align-items: center;
      }
      .audit-filters .filter-group,
      .audit-filters .filter-group-block {
        margin-bottom: 4px;
      }
      .audit-actions {
        margin-bottom: 10px;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }
      .audit-table-scroll-outer { position: relative; margin: 0 -4px 12px; }
      .audit-table-wrap {
        border: 1px solid var(--border);
        border-bottom: none;
        border-radius: var(--radius-sm) var(--radius-sm) 0 0;
        background: var(--surface);
        overflow-x: auto;
        overflow-y: hidden;
        -webkit-overflow-scrolling: touch;
      }
      .audit-table-h-scroll {
        position: sticky;
        bottom: 0;
        left: 0;
        right: 0;
        overflow-x: auto;
        overflow-y: hidden;
        height: 14px;
        background: var(--surface);
        border: 1px solid var(--border);
        border-top: 1px solid #e2e8f0;
        border-radius: 0 0 var(--radius-sm) var(--radius-sm);
        z-index: 4;
        -webkit-overflow-scrolling: touch;
      }
      .audit-table-h-scroll-inner { height: 1px; pointer-events: none; }
      .audit-table-h-scroll::-webkit-scrollbar { height: 10px; }
      .audit-table-h-scroll::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 5px; }
      .audit-table-h-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 5px; }
      .audit-table-h-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
      .audit-table-h-scroll { scrollbar-width: thin; scrollbar-color: #cbd5e1 #f1f5f9; }
      #table-audit {
        min-width: 720px;
        width: max-content;
        border-collapse: collapse;
        margin-bottom: 0;
      }
      #table-audit th,
      #table-audit td {
        padding: 10px 14px;
        font-size: 13px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        vertical-align: middle;
        border-bottom: 1px solid #e5e7eb;
      }
      #table-audit th:nth-child(1) { width: 170px; }
      #table-audit th:nth-child(2) { width: 90px; }
      #table-audit th:nth-child(3),
      #table-audit td:nth-child(3),
      #table-audit th:nth-child(4),
      #table-audit td:nth-child(4) {
        white-space: nowrap;
        word-break: break-word;
      }
      #table-audit tbody tr:nth-child(odd) { background: #fff; }
      #table-audit tbody tr:nth-child(even) { background: #f8fafc; }
      #table-audit tbody tr:hover td { background: #f5f7fa !important; }
      .audit-tag-create {
        display: inline-block;
        padding: 1px 8px;
        border-radius: 999px;
        font-size: 11px;
        background: #dcfce7;
        color: #166534;
        margin-right: 6px;
      }
      .audit-tag-export {
        display: inline-block;
        padding: 1px 8px;
        border-radius: 999px;
        font-size: 11px;
        background: #dbeafe;
        color: #1d4ed8;
        margin-right: 6px;
      }
      .audit-note-empty { color: #9ca3af; }
      .audit-highlight {
        background: #fef08a;
        padding: 0 1px;
      }
      #table-usage { min-width: 1100px; width: max-content; margin-bottom: 0; border-collapse: collapse; }
      #table-usage th, #table-usage td { min-width: 60px; max-width: 180px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; box-sizing: border-box; height: 48px; padding: 12px 16px; vertical-align: middle; }
      #table-usage th:nth-child(1), #table-usage td:nth-child(1) { min-width: 90px; }
      #table-usage th:nth-child(2), #table-usage td:nth-child(2) { min-width: 140px; }
      #table-usage th:nth-child(3), #table-usage td:nth-child(3) { min-width: 100px; }
      #table-usage th:nth-child(4), #table-usage td:nth-child(4) { min-width: 80px; }
      #table-usage th:last-child, #table-usage td:last-child { max-width: 200px; white-space: normal; word-break: break-all; }
      /* ç©ºå€¼æ˜¾ç¤ºä¸ºæµ…ç°è‰²ã€Œæ— æ•°æ®ã€ */
      #table-usage td.cell-empty { color: #999999; }
      /* è¡Œè¾¹æ¡†ä¸æ‚¬åœé«˜äº® */
      #table-usage tbody tr { border-bottom: 1px solid #EEEEEE; }
      #table-usage tbody tr:hover td { background: #F5F7FA !important; }
      /* å›ºå®šå·¦ä¾§å››åˆ—ï¼šç™»è®°æ—¥æœŸã€å®é™…ç™»è®°æ—¶é—´ã€è®¾å¤‡ã€ç±»å‹ */
      #table-usage th:nth-child(1), #table-usage th:nth-child(2), #table-usage th:nth-child(3), #table-usage th:nth-child(4) { position: sticky; z-index: 3; background: var(--primary-bg); box-shadow: 2px 0 4px rgba(0,0,0,0.04); }
      #table-usage th:nth-child(1) { left: 0; }
      #table-usage th:nth-child(2) { left: 90px; }
      #table-usage th:nth-child(3) { left: 230px; }
      #table-usage th:nth-child(4) { left: 330px; }
      #table-usage td:nth-child(1), #table-usage td:nth-child(2), #table-usage td:nth-child(3), #table-usage td:nth-child(4) { position: sticky; z-index: 2; box-shadow: 2px 0 4px rgba(0,0,0,0.04); }
      #table-usage td:nth-child(1) { left: 0; }
      #table-usage td:nth-child(2) { left: 90px; }
      #table-usage td:nth-child(3) { left: 230px; }
      #table-usage td:nth-child(4) { left: 330px; }
      #table-usage tbody tr:nth-child(odd) td:nth-child(1),
      #table-usage tbody tr:nth-child(odd) td:nth-child(2),
      #table-usage tbody tr:nth-child(odd) td:nth-child(3),
      #table-usage tbody tr:nth-child(odd) td:nth-child(4) { background: var(--surface); }
      #table-usage tbody tr:nth-child(even) td { background: #f8fafc; }
      #table-usage tbody tr:nth-child(even) td:nth-child(1),
      #table-usage tbody tr:nth-child(even) td:nth-child(2),
      #table-usage tbody tr:nth-child(even) td:nth-child(3),
      #table-usage tbody tr:nth-child(even) td:nth-child(4) { background: #e8f5f3; }
      #table-usage tbody tr:hover td:nth-child(1),
      #table-usage tbody tr:hover td:nth-child(2),
      #table-usage tbody tr:hover td:nth-child(3),
      #table-usage tbody tr:hover td:nth-child(4) { background: #F5F7FA !important; }
      .usage-filters { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
      .usage-filters label { white-space: nowrap; color: var(--text); font-weight: 500; font-size: 13px; }
      .usage-filters input, .usage-filters select { min-width: 0; }
      .usage-filters .filter-group { display: inline-flex; align-items: center; gap: 6px; }
      .usage-filters .filter-group-block { display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }
      .usage-filters .filter-group-block label { margin-right: 4px; }
      .usage-more-toggle { color: var(--primary); cursor: pointer; font-size: 13px; user-select: none; }
      .usage-more-toggle:hover { text-decoration: underline; }
      .usage-more-filters { display: none; align-items: center; gap: 12px; flex-wrap: wrap; }
      .usage-more-filters.visible { display: flex; }
      .usage-actions { display: flex; flex-wrap: wrap; align-items: center; gap: 12px; margin-top: 8px; }
      .usage-actions .btn-query-primary { background: #1890FF; color: #fff; border: none; padding: 12px 24px; font-size: 15px; font-weight: 600; border-radius: var(--radius-sm); cursor: pointer; }
      .usage-actions .btn-query-primary:hover { background: #40a9ff; }
      .usage-actions .btn-export-secondary { background: #fff; color: var(--text); border: 1px solid var(--border); padding: 10px 20px; font-size: 14px; border-radius: var(--radius-sm); cursor: pointer; }
      .usage-actions .btn-export-secondary:hover { border-color: #1890FF; color: #1890FF; }
      .usage-pagination-row { display: flex; flex-wrap: wrap; align-items: center; gap: 12px; margin-top: 12px; }
      .usage-pagination-row .usage-page-size { min-width: 100px; }
      @media (max-width: 900px) {
        .admin-main { padding: 12px; }
        .usage-filters .filter-group { flex: 1 1 140px; min-width: 120px; }
        .usage-filters input[type="date"], .usage-filters input[type="text"] { width: 100%; max-width: 160px; }
        .usage-actions { margin-top: 12px; }
        .usage-actions button { flex: 1; min-width: 80px; }
      }
      @media (max-width: 600px) {
        .usage-filters .filter-group { flex: 1 1 100%; }
        .usage-filters input[type="date"], .usage-filters input[type="text"] { max-width: none; }
      }
    </style>
  </head>
  <body>
    <div id="login-wrap" class="login-wrap" style="display:none;">
      <div id="login-prompt" class="login-prompt">
        <h1>åå°ç®¡ç†</h1>
        <p class="login-sub">è¯·ç™»å½•ï¼ˆéœ€ç®¡ç†å‘˜æƒé™ï¼‰</p>
        <div class="login-form">
          <div class="form-row">
            <label>ç”¨æˆ·å</label>
            <input type="text" id="login-username" placeholder="ç®¡ç†å‘˜ç”¨æˆ·å" autocomplete="username" />
          </div>
          <div class="form-row">
            <label>å¯†ç </label>
            <input type="password" id="login-password" placeholder="å¯†ç " autocomplete="current-password" />
          </div>
          <div class="msg" id="login-msg"></div>
          <button type="button" id="btn-login">ç®¡ç†å‘˜è´¦å·ç™»å½•</button>
        </div>
        <p class="login-divider">æˆ–</p>
        <p><a href="/api/auth/wecom/login?next_path=/admin">ä¼ä¸šå¾®ä¿¡ç™»å½•</a></p>
      </div>
    </div>

    <div id="admin-layout" class="admin-layout" style="display:none;">
      <aside class="admin-sidebar">
        <div class="logo">è®¾å¤‡ç™»è®°ç®¡ç†</div>
        <nav class="admin-nav">
          <a href="#" class="admin-menu active" data-panel="dashboard">å·¥ä½œå°</a>
          <a href="#" class="admin-menu" data-panel="devices">è®¾å¤‡ç®¡ç†</a>
          <a href="#" class="admin-menu" data-panel="users">ç”¨æˆ·ç®¡ç†</a>
          <a href="#" class="admin-menu" data-panel="usage">ä½¿ç”¨è®°å½•æŸ¥è¯¢</a>
          <a href="#" class="admin-menu" data-panel="dict">å­—å…¸ç®¡ç†</a>
          <a href="#" class="admin-menu" data-panel="audit">å®¡è®¡æ—¥å¿—</a>
        </nav>
        <div class="sidebar-version">ç‰ˆæœ¬ v{{ app_version }}</div>
      </aside>
      <main class="admin-main">
        <div class="admin-topbar">
          <span class="user-name" id="user-name">ç®¡ç†å‘˜</span>
          <button type="button" id="btn-logout" class="logout-btn">é€€å‡ºç™»å½•</button>
        </div>
        <div id="panel-dashboard" class="admin-panel active">
          <h2>å·¥ä½œå°</h2>
          <div class="stat-cards">
            <div class="stat-card stat-card-clickable" data-panel="devices" data-device-filter="">
              <div class="label">è®¾å¤‡æ€»æ•°</div>
              <div class="value" id="stat-device-count">â€”</div>
            </div>
            <div class="stat-card stat-card-clickable" data-panel="devices" data-device-filter="">
              <div class="label">å¯ç”¨è®¾å¤‡</div>
              <div class="value" id="stat-active-count">â€”</div>
            </div>
            <div class="stat-card stat-card-clickable" data-panel="devices" data-device-filter="inactive_only">
              <div class="label">å·²åœç”¨è®¾å¤‡</div>
              <div class="value" id="stat-inactive-count">â€”</div>
            </div>
            <div class="stat-card stat-card-clickable" data-panel="devices" data-device-filter="deleted_only">
              <div class="label">å·²åˆ é™¤è®¾å¤‡</div>
              <div class="value" id="stat-deleted-count">â€”</div>
            </div>
            <div class="stat-card stat-card-clickable" data-panel="users" data-device-filter="">
              <div class="label">ç”¨æˆ·æ•°</div>
              <div class="value" id="stat-user-count">â€”</div>
            </div>
            <div class="stat-card stat-card-clickable" data-panel="usage" data-device-filter="">
              <div class="label">ä½¿ç”¨è®°å½•æ¡æ•°</div>
              <div class="value" id="stat-usage-count">â€”</div>
            </div>
            <div class="stat-card stat-card-clickable" data-panel="usage" data-device-filter="">
              <div class="label">ä»Šæ—¥ç™»è®°</div>
              <div class="value" id="stat-usage-today">â€”</div>
            </div>
            <div class="stat-card stat-card-clickable" data-panel="usage" data-device-filter="">
              <div class="label">æœ¬å‘¨ç™»è®°</div>
              <div class="value" id="stat-usage-week">â€”</div>
            </div>
            <div class="stat-card stat-card-clickable" data-panel="usage" data-device-filter="">
              <div class="label">æœ¬æœˆç™»è®°</div>
              <div class="value" id="stat-usage-month">â€”</div>
            </div>
          </div>
          <div class="card">
            <h3>å¿«æ·æ“ä½œ</h3>
            <p style="margin:0;color:#64748b;">ä»å·¦ä¾§èœå•è¿›å…¥ <strong>è®¾å¤‡ç®¡ç†</strong> ç»´æŠ¤è®¾å¤‡ä¿¡æ¯ï¼Œè¿›å…¥ <strong>ä½¿ç”¨è®°å½•æŸ¥è¯¢</strong> æŒ‰æ¡ä»¶æŸ¥è¯¢å¹¶å¯¼å‡ºç™»è®°è®°å½•ã€‚</p>
          </div>
        </div>

        <div id="panel-devices" class="admin-panel">
          <h2>è®¾å¤‡ç®¡ç†</h2>
          <div class="card">
            <p class="mb device-tip" style="color:var(--text-muted); font-size:13px;">
              ğŸ’¡ çŠ¶æ€è¡¨ç¤ºè®¾å¤‡è¿è¡ŒçŠ¶æ€ï¼ˆå¦‚å¯ç”¨/æ•…éšœï¼‰ï¼Œå¯ç”¨è¡¨ç¤ºæ˜¯å¦å…è®¸ç™»è®°ä½¿ç”¨ï¼›åœç”¨æˆ–å·²åˆ é™¤çš„è®¾å¤‡å…¶äºŒç»´ç åˆ—å°†æ˜¾ç¤ºâ€œæ— æƒé™æŸ¥çœ‹â€ã€‚
            </p>
            <div class="device-filter-row flex mb">
              <label>ç¼–å·</label><input id="new-code" placeholder="è¾“å…¥è®¾å¤‡ç¼–å·" />
              <label>åç§°</label><input id="new-name" placeholder="è¾“å…¥è®¾å¤‡åç§°" />
              <label>ç§‘å®¤</label><input id="new-dept" placeholder="è¾“å…¥ç§‘å®¤ç­›é€‰" list="device-dept-options" />
              <datalist id="device-dept-options"></datalist>
              <div class="device-flag-filters">
                <label class="device-show-deleted-wrap"><input type="checkbox" id="device-deleted-only" /> åªæ˜¾ç¤ºå·²åˆ é™¤</label>
                <label class="device-show-inactive-wrap"><input type="checkbox" id="device-inactive-only" /> åªæ˜¾ç¤ºå·²åœç”¨</label>
              </div>
              <button type="button" id="btn-device-query">æŸ¥è¯¢</button>
              <button type="button" id="btn-device-reset" class="secondary">æ¸…ç©ºç­›é€‰</button>
              <span class="device-actions-group">
                <button id="btn-add">æ–°å¢è®¾å¤‡</button>
                <button type="button" id="btn-device-import" class="secondary">æ‰¹é‡å¯¼å…¥</button>
                <button type="button" id="btn-device-export-csv" class="secondary">å¯¼å‡º CSV</button>
                <button type="button" id="btn-device-export-xlsx" class="secondary">å¯¼å‡º Excel</button>
              </span>
            </div>
            <div class="msg" id="device-msg"></div>
            <div class="device-table-scroll-outer">
              <div class="device-table-wrap" id="device-table-wrap" role="region" aria-label="è®¾å¤‡è¡¨æ ¼ï¼Œå¯å·¦å³æ»‘åŠ¨æŸ¥çœ‹å…¨éƒ¨åˆ—">
                <table id="table-devices" class="resizable-cols">
                  <thead>
                    <tr><th>ç¼–å·</th><th>åç§°</th><th>ç§‘å®¤</th><th>çŠ¶æ€</th><th>å¯ç”¨</th><th>äºŒç»´ç </th><th>æ“ä½œ</th></tr>
                  </thead>
                  <tbody id="device-list"></tbody>
                </table>
              </div>
              <div class="device-table-h-scroll" id="device-table-h-scroll" role="scrollbar" aria-label="è¡¨æ ¼æ¨ªå‘æ»šåŠ¨æ¡">
                <div class="device-table-h-scroll-inner" id="device-table-h-scroll-inner"></div>
              </div>
            </div>
            <div class="pagination-wrap" id="device-pagination">
              <span id="device-page-info">å…± 0 æ¡</span>
              <span class="filter-group" style="margin-left:8px;">
                <label for="device-page-size">æ¯é¡µ</label>
                <select id="device-page-size" aria-label="æ¯é¡µæ˜¾ç¤ºæ¡æ•°">
                  <option value="20" selected>20 æ¡</option>
                  <option value="50">50 æ¡</option>
                  <option value="100">100 æ¡</option>
                </select>
              </span>
              <button type="button" id="device-prev" class="secondary">ä¸Šä¸€é¡µ</button>
              <button type="button" id="device-next" class="secondary">ä¸‹ä¸€é¡µ</button>
            </div>
            <div id="device-qr-modal" class="device-qr-modal" role="dialog" aria-modal="true" aria-label="äºŒç»´ç é¢„è§ˆ" style="display:none;">
              <div class="device-qr-modal-backdrop"></div>
              <div class="device-qr-modal-box">
                <img id="device-qr-modal-img" src="" alt="è®¾å¤‡äºŒç»´ç " />
                <button type="button" id="device-qr-modal-close" class="secondary">å…³é—­</button>
              </div>
            </div>
            <div id="device-import-modal" class="user-pw-modal" role="dialog" aria-modal="true" aria-label="æ‰¹é‡å¯¼å…¥" style="display:none;">
              <div class="user-pw-modal-backdrop"></div>
              <div class="user-pw-modal-box">
                <h3 style="margin:0;">æ‰¹é‡å¯¼å…¥è®¾å¤‡</h3>
                <p class="mb" style="margin:8px 0 16px; color:var(--text-muted); font-size:14px;">è¯·å…ˆä¸‹è½½æ¨¡æ¿ï¼ŒæŒ‰è¡¨å¤´å¡«å†™åä¸Šä¼  .xlsx æ–‡ä»¶ã€‚è®¾å¤‡ç¼–å·é‡å¤å°†è‡ªåŠ¨è·³è¿‡ã€‚</p>
                <div class="form-row mb">
                  <button type="button" id="device-import-download-tpl" class="secondary">ä¸‹è½½æ¨¡æ¿</button>
                </div>
                <div class="form-row mb">
                  <label style="width:80px;">é€‰æ‹©æ–‡ä»¶</label>
                  <input type="file" id="device-import-file" accept=".xlsx,.xls" />
                </div>
                <div class="msg" id="device-import-msg"></div>
                <div class="flex" style="gap:12px; margin-top:16px;">
                  <button type="button" id="device-import-submit">ä¸Šä¼ å¹¶å¯¼å…¥</button>
                  <button type="button" id="device-import-cancel" class="secondary">å–æ¶ˆ</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div id="panel-users" class="admin-panel">
          <h2>ç”¨æˆ·ç®¡ç†</h2>
          <div class="card">
            <p class="mb" style="color:var(--text-muted);">ç³»ç»Ÿç”¨æˆ·åˆ—è¡¨ï¼ˆä¼ä¸šå¾®ä¿¡ç™»å½•æˆ–ç®¡ç†å‘˜è´¦å·ï¼‰ã€‚æ”¯æŒæ–°å¢æœ¬åœ°ç”¨æˆ·ã€ä¿®æ”¹å¯†ç ã€åœç”¨/å¯ç”¨ï¼›ä»…ç³»ç»Ÿç®¡ç†å‘˜å¯ä¿®æ”¹å¯†ç ä¸åˆ›å»ºç®¡ç†å‘˜è§’è‰²ã€‚</p>
            <div class="mb">
              <button type="button" id="btn-user-add" class="primary">æ–°å¢ç”¨æˆ·</button>
            </div>
            <table id="table-users" class="resizable-cols">
              <thead>
                <tr><th>ID</th><th>ç”¨æˆ·å</th><th>å§“å</th><th>è§’è‰²</th><th>ç§‘å®¤</th><th>åˆ›å»ºæ—¶é—´</th><th>æ“ä½œ</th></tr>
              </thead>
              <tbody id="user-list"></tbody>
            </table>
            <div class="pagination-wrap" id="user-pagination">
              <span id="user-page-info">å…± 0 æ¡</span>
              <button type="button" id="user-prev" class="secondary">ä¸Šä¸€é¡µ</button>
              <button type="button" id="user-next" class="secondary">ä¸‹ä¸€é¡µ</button>
            </div>
            <div id="user-pw-modal" class="user-pw-modal" role="dialog" aria-modal="true" aria-label="ä¿®æ”¹å¯†ç " style="display:none;">
              <div class="user-pw-modal-backdrop"></div>
              <div class="user-pw-modal-box">
                <h3 style="margin:0;">ä¿®æ”¹å¯†ç </h3>
                <p class="mb" id="user-pw-sub" style="margin:0;color:var(--text-muted);"></p>
                <div class="form-row">
                  <label>æ–°å¯†ç </label>
                  <input type="password" id="user-pw-new" placeholder="è‡³å°‘ 6 ä½" autocomplete="new-password" />
                </div>
                <div class="form-row">
                  <label>ç¡®è®¤å¯†ç </label>
                  <input type="password" id="user-pw-confirm" placeholder="å†æ¬¡è¾“å…¥æ–°å¯†ç " autocomplete="new-password" />
                </div>
                <div class="msg" id="user-pw-msg"></div>
                <div style="display:flex;gap:10px;justify-content:flex-end;">
                  <button type="button" id="user-pw-cancel" class="secondary">å–æ¶ˆ</button>
                  <button type="button" id="user-pw-save">ä¿å­˜</button>
                </div>
              </div>
            </div>
            <div id="user-add-modal" class="user-pw-modal" role="dialog" aria-modal="true" aria-label="æ–°å¢ç”¨æˆ·" style="display:none;">
              <div class="user-pw-modal-backdrop"></div>
              <div class="user-pw-modal-box">
                <h3 style="margin:0;">æ–°å¢ç”¨æˆ·</h3>
                <p class="mb" style="margin:0;color:var(--text-muted);font-size:13px;">åˆ›å»ºæœ¬åœ°è´¦å·ï¼Œå¯ä½¿ç”¨ç”¨æˆ·å+å¯†ç ç™»å½•åå°ã€‚</p>
                <div class="form-row">
                  <label>ç”¨æˆ·å <span style="color:#dc2626;">*</span></label>
                  <input type="text" id="user-add-username" placeholder="ç™»å½•ç”¨ï¼Œå”¯ä¸€" maxlength="64" autocomplete="off" />
                </div>
                <div class="form-row">
                  <label>å¯†ç  <span style="color:#dc2626;">*</span></label>
                  <input type="password" id="user-add-password" placeholder="è‡³å°‘ 6 ä½" autocomplete="new-password" />
                </div>
                <div class="form-row">
                  <label>å§“å <span style="color:#dc2626;">*</span></label>
                  <input type="text" id="user-add-realname" placeholder="æ˜¾ç¤ºå§“å" maxlength="64" />
                </div>
                <div class="form-row">
                  <label>è§’è‰²</label>
                  <select id="user-add-role" aria-label="è§’è‰²">
                    <option value="user">æ™®é€šç”¨æˆ·</option>
                    <option value="device_admin">è®¾å¤‡ç®¡ç†å‘˜</option>
                    <option value="sys_admin">ç³»ç»Ÿç®¡ç†å‘˜</option>
                  </select>
                </div>
                <div class="form-row">
                  <label>ç§‘å®¤</label>
                  <input type="text" id="user-add-dept" placeholder="é€‰å¡«" maxlength="128" />
                </div>
                <div class="msg" id="user-add-msg"></div>
                <div style="display:flex;gap:10px;justify-content:flex-end;">
                  <button type="button" id="user-add-cancel" class="secondary">å–æ¶ˆ</button>
                  <button type="button" id="user-add-submit">ç¡®å®š</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div id="panel-usage" class="admin-panel">
          <h2>ä½¿ç”¨è®°å½•æŸ¥è¯¢</h2>
          <div class="card">
            <div class="usage-filters mb">
              <span class="filter-group"><label>è®¾å¤‡</label><input id="filter-device" list="device-options" placeholder="åç§°æˆ–ç¼–å·" /></span>
              <datalist id="device-options"></datalist>
              <span class="filter-group-block">
                <label>ç™»è®°æ—¥æœŸèŒƒå›´</label>
                <input type="date" id="filter-reg-from" aria-label="ç™»è®°æ—¥æœŸèµ·" />
                <span style="color:var(--text-muted);">è‡³</span>
                <input type="date" id="filter-reg-to" aria-label="ç™»è®°æ—¥æœŸæ­¢" />
              </span>
              <span class="filter-group-block">
                <label>ä½¿ç”¨æ—¥æœŸèŒƒå›´</label>
                <input type="date" id="filter-from" aria-label="ä½¿ç”¨å¼€å§‹æ—¥æœŸ" />
                <span style="color:var(--text-muted);">è‡³</span>
                <input type="date" id="filter-to" aria-label="ä½¿ç”¨ç»“æŸæ—¥æœŸ" />
              </span>
              <span class="usage-more-toggle" id="usage-more-toggle" role="button" tabindex="0">â–¼ å±•å¼€æ›´å¤šç­›é€‰</span>
              <span class="usage-more-filters" id="usage-more-filters">
                <span class="filter-group"><label>ç§‘å®¤</label><input id="filter-dept" list="dept-options" placeholder="ç§‘å®¤" /></span>
                <datalist id="dept-options"></datalist>
                <span class="filter-group"><label>åºŠå·</label><input id="filter-bed" placeholder="åºŠå·" /></span>
              </span>
            </div>
            <div class="usage-actions">
              <button type="button" id="btn-query" class="btn-query-primary">æŸ¥è¯¢</button>
              <button type="button" id="btn-export" class="btn-export-secondary">å¯¼å‡º CSV</button>
              <button type="button" id="btn-export-xlsx" class="btn-export-secondary">å¯¼å‡º Excel</button>
              <button type="button" id="btn-export-pdf" class="btn-export-secondary">å¯¼å‡º PDF</button>
            </div>
            <div class="msg" id="usage-msg"></div>
            <div class="usage-table-scroll-outer">
              <div class="usage-table-wrap" id="usage-table-wrap" role="region" aria-label="ä½¿ç”¨è®°å½•è¡¨æ ¼ï¼Œå¯å·¦å³æ»‘åŠ¨æŸ¥çœ‹å…¨éƒ¨åˆ—">
                <table id="table-usage" class="resizable-cols">
                  <thead>
                    <tr id="usage-thead-row"><th>ç™»è®°æ—¥æœŸ</th><th>å®é™…ç™»è®°æ—¶é—´</th><th>è®¾å¤‡</th><th>åºŠå·</th><th>IDå·</th><th>å§“å</th><th>å¼€æœº</th><th>å…³æœº</th><th>ç»´æŠ¤äºº</th><th>ç±»å‹</th><th>è®¾å¤‡çŠ¶å†µ</th><th>æ—¥å¸¸ä¿å…»</th><th>ç»ˆæœ«æ¶ˆæ¯’</th><th>å¤‡æ³¨</th></tr>
                  </thead>
                  <tbody id="usage-list"></tbody>
                </table>
              </div>
              <div class="usage-table-h-scroll" id="usage-table-h-scroll" role="scrollbar" aria-label="è¡¨æ ¼æ¨ªå‘æ»šåŠ¨æ¡">
                <div class="usage-table-h-scroll-inner" id="usage-table-h-scroll-inner"></div>
              </div>
            </div>
            <div class="usage-pagination-row" id="usage-pagination">
              <span id="usage-page-info">å…± 0 æ¡</span>
              <span class="filter-group">
                <label for="usage-page-size">æ¯é¡µ</label>
                <select id="usage-page-size" class="usage-page-size" aria-label="æ¯é¡µæ˜¾ç¤ºæ¡æ•°">
                  <option value="20" selected>20 æ¡</option>
                  <option value="50">50 æ¡</option>
                  <option value="100">100 æ¡</option>
                  <option value="200">200 æ¡</option>
                </select>
              </span>
              <button type="button" id="usage-prev" class="secondary">ä¸Šä¸€é¡µ</button>
              <button type="button" id="usage-next" class="secondary">ä¸‹ä¸€é¡µ</button>
            </div>
          </div>
        </div>

        <div id="panel-dict" class="admin-panel">
          <h2>å­—å…¸ç®¡ç†</h2>
          <div class="card">
            <h3>ä½¿ç”¨ç±»å‹</h3>
            <p class="dict-desc">ç™»è®°æ—¶å¯é€‰çš„ä½¿ç”¨ç±»å‹ï¼Œå¯å¢åˆ æ”¹ã€å¯ç”¨/åœç”¨ï¼›åˆ é™¤ä»…æ‰“æ ‡è¯†ä¸ç‰©ç†åˆ é™¤ã€‚</p>
            <div class="form-row flex mb">
              <label>ç¼–ç </label><input type="number" id="dict-usage-code" placeholder="å¦‚ 1" min="1" />
              <label>æ˜¾ç¤ºåç§°</label><input id="dict-usage-label" placeholder="å¦‚ å…¶ä»–" />
              <button type="button" id="dict-usage-add">æ–°å¢</button>
            </div>
            <div class="msg" id="dict-usage-msg"></div>
            <table id="table-dict-usage" class="dict-table resizable-cols">
              <thead>
                <tr><th>ç¼–ç </th><th>æ˜¾ç¤ºåç§°</th><th>çŠ¶æ€</th><th>å·²åˆ é™¤</th><th>æ“ä½œ</th></tr>
              </thead>
              <tbody id="dict-usage-tbody"></tbody>
            </table>
          </div>
          <div class="card">
            <h3>è®¾å¤‡çŠ¶æ€</h3>
            <p class="dict-desc">è®¾å¤‡è¿è¡ŒçŠ¶æ€ï¼Œç”¨äºè®¾å¤‡ç®¡ç†ä¸­çš„çŠ¶æ€å­—æ®µã€‚</p>
            <div class="form-row flex mb">
              <label>ç¼–ç </label><input type="number" id="dict-status-code" placeholder="å¦‚ 1" min="1" />
              <label>æ˜¾ç¤ºåç§°</label><input id="dict-status-label" placeholder="å¦‚ å¯ç”¨" />
              <button type="button" id="dict-status-add">æ–°å¢</button>
            </div>
            <div class="msg" id="dict-status-msg"></div>
            <table id="table-dict-status" class="dict-table resizable-cols">
              <thead>
                <tr><th>ç¼–ç </th><th>æ˜¾ç¤ºåç§°</th><th>çŠ¶æ€</th><th>å·²åˆ é™¤</th><th>æ“ä½œ</th></tr>
              </thead>
              <tbody id="dict-status-tbody"></tbody>
            </table>
          </div>
        </div>

        <div id="panel-audit" class="admin-panel">
          <h2>å®¡è®¡æ—¥å¿—</h2>
          <div class="card">
            <div class="audit-filters mb">
              <span class="filter-group">
                <label>æ“ä½œç±»å‹</label>
                <select id="audit-filter-action">
                  <option value="">å…¨éƒ¨ç±»å‹</option>
                  <option value="device.create">è®¾å¤‡-æ–°å¢</option>
                  <option value="device.update">è®¾å¤‡-æ›´æ–°</option>
                  <option value="device.delete">è®¾å¤‡-åˆ é™¤</option>
                  <option value="device.restore">è®¾å¤‡-æ¢å¤</option>
                  <option value="usage.export">ä½¿ç”¨è®°å½•-å¯¼å‡º</option>
                  <option value="auth.login">ç™»å½•</option>
                </select>
              </span>
              <span class="filter-group">
                <label>ç±»å‹æœç´¢</label>
                <input id="audit-action-search" placeholder="è¾“å…¥å…³é”®å­—ç­›é€‰ç±»å‹" />
              </span>
              <span class="filter-group-block">
                <label>æ—¶é—´èŒƒå›´</label>
                <input type="datetime-local" id="audit-filter-from" aria-label="å¼€å§‹æ—¶é—´" />
                <span style="color:var(--text-muted);">è‡³</span>
                <input type="datetime-local" id="audit-filter-to" aria-label="ç»“æŸæ—¶é—´" />
              </span>
              <span class="filter-group">
                <label>å¿«æ·æ—¥æœŸ</label>
                <button type="button" id="audit-quick-today" class="secondary">ä»Šæ—¥</button>
                <button type="button" id="audit-quick-week" class="secondary">æœ¬å‘¨</button>
                <button type="button" id="audit-quick-month" class="secondary">æœ¬æœˆ</button>
              </span>
              <span class="filter-group">
                <label>å…³é”®è¯</label>
                <input id="audit-keyword" placeholder="æŒ‰æ“ä½œäºº / å†…å®¹ / å¤‡æ³¨æœç´¢" />
              </span>
            </div>
            <div class="usage-actions audit-actions">
              <button type="button" id="btn-audit-query" class="btn-query-primary">æŸ¥è¯¢</button>
              <button type="button" id="btn-audit-export-csv" class="btn-export-secondary">å¯¼å‡º CSV</button>
              <button type="button" id="btn-audit-export-xlsx" class="btn-export-secondary">å¯¼å‡º Excel</button>
            </div>
            <div class="msg" id="audit-msg"></div>
            <div class="audit-table-scroll-outer">
              <div class="audit-table-wrap" id="audit-table-wrap" role="region" aria-label="å®¡è®¡æ—¥å¿—è¡¨æ ¼ï¼Œå¯å·¦å³æ»‘åŠ¨æŸ¥çœ‹å…¨éƒ¨åˆ—">
                <table id="table-audit" class="resizable-cols">
                  <thead>
                    <tr><th>æ—¶é—´</th><th>æ“ä½œäºº</th><th>æ“ä½œè¯´æ˜</th><th>å¤‡æ³¨</th></tr>
                  </thead>
                  <tbody id="audit-list"></tbody>
                </table>
              </div>
              <div class="audit-table-h-scroll" id="audit-table-h-scroll" role="scrollbar" aria-label="è¡¨æ ¼æ¨ªå‘æ»šåŠ¨æ¡">
                <div class="audit-table-h-scroll-inner" id="audit-table-h-scroll-inner"></div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <script>
      function escapeHtml(s) {
        if (s == null || s === undefined) return "";
        return String(s).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#39;");
      }
      (function () {
        const hash = location.hash.slice(1);
        const q = new URLSearchParams(location.search);
        const token = new URLSearchParams(hash).get("token") || q.get("token");
        if (token) {
          try { localStorage.setItem("device_scan_token", token); } catch (e) {}
        }
      })();
      function authHeaders() {
        try {
          const t = localStorage.getItem("device_scan_token");
          return t ? { "Authorization": "Bearer " + t } : {};
        } catch (e) { return {}; }
      }
      var _auth401Handled = false;
      function handle401Unauth(url) {
        try { localStorage.removeItem("device_scan_token"); } catch (e) {}
        if (url && typeof url === "string" && url.indexOf("/api/auth/me") !== -1) {
          return;
        }
        if (_auth401Handled) return;
        _auth401Handled = true;
        var wrap = document.getElementById("login-wrap");
        var layout = document.getElementById("admin-layout");
        if (wrap && layout) {
          layout.style.display = "none";
          wrap.style.display = "flex";
          if (typeof bindLoginForm === "function") bindLoginForm();
        } else {
          setTimeout(function () { location.reload(); }, 50);
        }
      }
      function ensureAuth(res) {
        if (res && res.status === 401) {
          handle401Unauth("");
          return false;
        }
        return true;
      }
      var _origFetch = window.fetch;
      window.fetch = function (url, opts) {
        return _origFetch.apply(this, arguments).then(function (res) {
          if (url && typeof url === "string" && url.indexOf("/api/") !== -1 && res.status === 401) {
            handle401Unauth(url);
          }
          return res;
        });
      };

      var COL_RESIZE_MIN = 80;
      var COL_RESIZE_MAX_RATIO = 0.5;
      var COL_RESIZE_STORAGE_PREFIX = "device_scan_cols_";
      var COL_RESIZE_DEFAULT_PX = 120;

      function initResizableColumns(tableEl) {
        if (!tableEl || !tableEl.classList.contains("resizable-cols")) return;
        var tableId = tableEl.id || ("table-" + Math.random().toString(36).slice(2, 8));
        tableEl.id = tableId;
        var thead = tableEl.querySelector("thead");
        var tr = thead && thead.querySelector("tr");
        if (!tr) return;
        var ths = tr.querySelectorAll("th");
        var colCount = ths.length;
        if (colCount === 0) return;

        var colgroup = tableEl.querySelector("colgroup");
        if (!colgroup) {
          colgroup = document.createElement("colgroup");
          tableEl.insertBefore(colgroup, tableEl.firstChild);
        }
        colgroup.innerHTML = "";
        var cols = [];
        for (var i = 0; i < colCount; i++) {
          var col = document.createElement("col");
          colgroup.appendChild(col);
          cols.push(col);
        }

        var saved = {};
        try {
          var raw = localStorage.getItem(COL_RESIZE_STORAGE_PREFIX + tableId);
          if (raw) saved = JSON.parse(raw) || {};
        } catch (e) {}
        for (var i = 0; i < colCount; i++) {
          var w = saved[i] != null ? Math.max(COL_RESIZE_MIN, Number(saved[i])) : COL_RESIZE_DEFAULT_PX;
          var maxW = Math.floor(window.innerWidth * COL_RESIZE_MAX_RATIO);
          cols[i].style.width = Math.min(maxW, w) + "px";
        }

        function saveWidths() {
          var o = {};
          for (var i = 0; i < colCount; i++) {
            var w = cols[i].style.width;
            if (w) o[i] = parseInt(w, 10) || COL_RESIZE_DEFAULT_PX;
          }
          try { localStorage.setItem(COL_RESIZE_STORAGE_PREFIX + tableId, JSON.stringify(o)); } catch (e) {}
        }

        for (var i = 0; i < ths.length; i++) {
          (function (colIndex) {
            var th = ths[colIndex];
            var existing = th.querySelector(".col-resize-handle");
            if (existing) existing.remove();
            var handle = document.createElement("div");
            handle.className = "col-resize-handle";
            handle.setAttribute("aria-label", "è°ƒæ•´åˆ—å®½");
            th.appendChild(handle);
            handle.addEventListener("mousedown", function (e) {
              e.preventDefault();
              e.stopPropagation();
              var startX = e.clientX;
              var startW = parseInt(cols[colIndex].style.width, 10) || COL_RESIZE_DEFAULT_PX;
              var maxW = Math.floor(window.innerWidth * COL_RESIZE_MAX_RATIO);

              function onMove(e) {
                var dx = e.clientX - startX;
                var newW = Math.max(COL_RESIZE_MIN, Math.min(maxW, startW + dx));
                cols[colIndex].style.width = newW + "px";
              }
              function onUp() {
                document.body.classList.remove("col-resizing");
                document.removeEventListener("mousemove", onMove);
                document.removeEventListener("mouseup", onUp);
                saveWidths();
              }
              document.body.classList.add("col-resizing");
              document.addEventListener("mousemove", onMove);
              document.addEventListener("mouseup", onUp);
            });
          })(i);
        }
      }

      function initAllResizableTables() {
        document.querySelectorAll("table.resizable-cols").forEach(initResizableColumns);
      }

      const loginWrap = document.getElementById("login-wrap");
      const adminLayout = document.getElementById("admin-layout");
      const logoutBtn = document.getElementById("btn-logout");
      var currentUserRole = null;
      var currentUserId = null;

      async function checkAdmin() {
        const res = await fetch("/api/auth/me", { headers: authHeaders() });
        if (!res.ok) {
          loginWrap.style.display = "flex";
          return false;
        }
        const me = await res.json();
        currentUserRole = me && me.role ? me.role : null;
        currentUserId = me && me.id != null ? me.id : null;
        const userNameEl = document.getElementById("user-name");
        if (userNameEl) {
          userNameEl.textContent = me.real_name || me.wx_userid || me.username || "ç®¡ç†å‘˜";
        }
        if (me.role !== "device_admin" && me.role !== "sys_admin") {
          document.getElementById("login-prompt").innerHTML = "<h1>åå°ç®¡ç†</h1><p>éœ€è¦ç®¡ç†å‘˜æƒé™ï¼Œè¯·ä½¿ç”¨ç®¡ç†å‘˜è´¦å·æˆ–ä¼ä¸šå¾®ä¿¡ç™»å½•ã€‚</p><div class=\"login-form\"><div class=\"form-row\"><label>ç”¨æˆ·å</label><input type=\"text\" id=\"login-username\" placeholder=\"ç®¡ç†å‘˜ç”¨æˆ·å\" /></div><div class=\"form-row\"><label>å¯†ç </label><input type=\"password\" id=\"login-password\" placeholder=\"å¯†ç \" /></div><div class=\"msg\" id=\"login-msg\"></div><button type=\"button\" id=\"btn-login\">ç®¡ç†å‘˜è´¦å·ç™»å½•</button></div><p class=\"login-divider\">æˆ–</p><p><a href=\"/api/auth/wecom/login?next_path=/admin\">ä¼ä¸šå¾®ä¿¡ç™»å½•</a></p>";
          loginWrap.style.display = "flex";
          bindLoginForm();
          return false;
        }
        adminLayout.style.display = "flex";
        return true;
      }

      // èœå•åˆ‡æ¢
      document.querySelectorAll(".admin-menu").forEach(function (a) {
        a.addEventListener("click", function (e) {
          e.preventDefault();
          var panelId = this.getAttribute("data-panel");
          document.querySelectorAll(".admin-menu").forEach(function (m) { m.classList.remove("active"); });
          document.querySelectorAll(".admin-panel").forEach(function (p) { p.classList.remove("active"); });
          this.classList.add("active");
          var panel = document.getElementById("panel-" + panelId);
          if (panel) panel.classList.add("active");
          if (panelId === "dashboard") loadDashboardStats();
          if (panelId === "devices") { devicePage = 0; loadDevices(); }
          if (panelId === "users") { userPage = 0; loadUsers(); }
          if (panelId === "usage") { usagePage = 0; loadUsageSuggest(); loadUsage(); }
          if (panelId === "dict") loadDict();
          if (panelId === "audit") loadAudit();
        });
      });
      document.querySelectorAll(".stat-card-clickable").forEach(function (card) {
        card.addEventListener("click", function () {
          var panelId = this.getAttribute("data-panel");
          var filterKind = (this.getAttribute("data-device-filter") || "").trim() || null;
          goToPanelWithDeviceFilter(panelId, filterKind);
        });
      });

      async function loadDashboardStats() {
        try {
          var res = await fetch("/api/dashboard/stats", { headers: authHeaders() });
          if (!res.ok) throw new Error("åŠ è½½å¤±è´¥");
          var s = await res.json();
          document.getElementById("stat-device-count").textContent = s.devices_total != null ? s.devices_total : "â€”";
          document.getElementById("stat-active-count").textContent = s.devices_active != null ? s.devices_active : "â€”";
          document.getElementById("stat-inactive-count").textContent = s.devices_inactive != null ? s.devices_inactive : "â€”";
          document.getElementById("stat-deleted-count").textContent = s.devices_deleted != null ? s.devices_deleted : "â€”";
          document.getElementById("stat-user-count").textContent = s.users_total != null ? s.users_total : "â€”";
          document.getElementById("stat-usage-count").textContent = s.usage_total != null ? s.usage_total : "â€”";
          document.getElementById("stat-usage-today").textContent = s.usage_today != null ? s.usage_today : "â€”";
          document.getElementById("stat-usage-week").textContent = s.usage_week != null ? s.usage_week : "â€”";
          document.getElementById("stat-usage-month").textContent = s.usage_month != null ? s.usage_month : "â€”";
        } catch (e) {
          ["stat-device-count","stat-active-count","stat-inactive-count","stat-deleted-count","stat-user-count","stat-usage-count","stat-usage-today","stat-usage-week","stat-usage-month"].forEach(function(id){ var el = document.getElementById(id); if(el) el.textContent = "â€”"; });
        }
      }

      function goToPanelWithDeviceFilter(panelId, filterKind) {
        document.querySelectorAll(".admin-panel").forEach(function (p) { p.classList.remove("active"); });
        document.querySelectorAll(".admin-menu").forEach(function (m) { m.classList.remove("active"); });
        var panel = document.getElementById("panel-" + panelId);
        var menu = document.querySelector(".admin-menu[data-panel=\"" + panelId + "\"]");
        if (panel) panel.classList.add("active");
        if (menu) menu.classList.add("active");
        // å…ˆæ¸…ç©ºç›®æ ‡é¢æ¿è¡¨æ ¼å¹¶æ˜¾ç¤ºåŠ è½½ä¸­ï¼Œå†å‘èµ·è¯·æ±‚ï¼Œé¿å…ç¬¬äºŒæ¬¡æ‰“å¼€æ—¶ä»æ˜¾ç¤ºæ—§æ•°æ®
        var deviceListEl = document.getElementById("device-list");
        var userListEl = document.getElementById("user-list");
        var usageListEl = document.getElementById("usage-list");
        if (panelId === "devices" && deviceListEl) { deviceListEl.innerHTML = "<tr><td colspan=\"7\" class=\"loading-cell\">åŠ è½½ä¸­...</td></tr>"; }
        if (panelId === "users" && userListEl) { userListEl.innerHTML = "<tr><td colspan=\"6\" class=\"loading-cell\">åŠ è½½ä¸­...</td></tr>"; }
        if (panelId === "usage" && usageListEl) { usageListEl.innerHTML = "<tr><td colspan=\"5\" class=\"loading-cell\">åŠ è½½ä¸­...</td></tr>"; }
        if (panelId === "devices") {
          var deletedCb = document.getElementById("device-deleted-only");
          var inactiveCb = document.getElementById("device-inactive-only");
          if (filterKind === "deleted_only") {
            if (deletedCb) deletedCb.checked = true;
            if (inactiveCb) inactiveCb.checked = false;
          } else if (filterKind === "inactive_only") {
            if (inactiveCb) inactiveCb.checked = true;
            if (deletedCb) deletedCb.checked = false;
          } else {
            if (deletedCb) deletedCb.checked = false;
            if (inactiveCb) inactiveCb.checked = false;
          }
          devicePage = 0;
          loadDevices();
        }
        if (panelId === "usage") { usagePage = 0; if (typeof loadUsageSuggest === "function") loadUsageSuggest(); if (typeof loadUsage === "function") loadUsage(); }
        if (panelId === "users") { userPage = 0; if (typeof loadUsers === "function") loadUsers(); }
      }

      var devicePage = 0;
      var devicePageSize = 20;
      var deviceTotal = 0;
      async function loadDevices() {
        var tbodyEl = document.getElementById("device-list");
        if (tbodyEl) tbodyEl.innerHTML = "<tr><td colspan=\"7\" class=\"loading-cell\">åŠ è½½ä¸­...</td></tr>";
        devicePageSize = parseInt(document.getElementById("device-page-size") && document.getElementById("device-page-size").value, 10) || devicePageSize;
        const deletedOnly = document.getElementById("device-deleted-only") && document.getElementById("device-deleted-only").checked;
        const inactiveOnly = document.getElementById("device-inactive-only") && document.getElementById("device-inactive-only").checked;
        const newCodeEl = document.getElementById("new-code");
        const newNameEl = document.getElementById("new-name");
        const newDeptEl = document.getElementById("new-dept");
        const q = (newCodeEl && newCodeEl.value || "").trim() || (newNameEl && newNameEl.value || "").trim();
        const dept = (newDeptEl && newDeptEl.value || "").trim();
        const offset = devicePage * devicePageSize;
        let listUrl = "/api/devices?include_inactive=1&limit=" + devicePageSize + "&offset=" + offset;
        let countUrl = "/api/devices/count?include_inactive=1";
        if (deletedOnly) { listUrl += "&deleted_only=1"; countUrl += "&deleted_only=1"; }
        else if (inactiveOnly) { listUrl += "&inactive_only=1"; countUrl += "&inactive_only=1"; }
        if (q) { listUrl += "&q=" + encodeURIComponent(q); countUrl += "&q=" + encodeURIComponent(q); }
        if (dept) { listUrl += "&dept=" + encodeURIComponent(dept); countUrl += "&dept=" + encodeURIComponent(dept); }
        const [listRes, countRes] = await Promise.all([fetch(listUrl, { headers: authHeaders() }), fetch(countUrl, { headers: authHeaders() })]);
        if (!listRes.ok) return [];
        const list = await listRes.json();
        deviceTotal = countRes.ok ? (await countRes.json()).total : list.length;
        var statusMap = {};
        try {
          var statusOpts = await getDeviceStatusOptions();
          statusOpts.forEach(function (o) { statusMap[o.code] = o.label || String(o.code); });
        } catch (e) {}
        var statusLabel = function (code) { return statusMap[code] != null ? statusMap[code] : String(code); };
        const tbody = document.getElementById("device-list");
        const deviceOptions = document.getElementById("device-options");
        const deptOptions = document.getElementById("dept-options");
        deviceOptions.innerHTML = "";
        deptOptions.innerHTML = "";
        tbody.innerHTML = "";
        const seenDepts = new Set();
        const deviceDeptOptionsEl = document.getElementById("device-dept-options");
        if (deviceDeptOptionsEl) deviceDeptOptionsEl.innerHTML = "";
        list.forEach(d => {
          const tr = document.createElement("tr");
          tr.dataset.deviceId = d.id;
          if (d.is_deleted) tr.classList.add("device-row-deleted");
          const activeText = d.is_active ? "å¯ç”¨" : "åœç”¨";
          const activeClass = d.is_active ? "" : " inactive-row";
          var statusText = String(statusLabel(d.status));
          var statusClass = "device-status-pill";
          if (/å¯ç”¨|æ­£å¸¸/.test(statusText)) statusClass += " device-status-pill-ok";
          else if (/æ•…éšœ|ç»´ä¿®/.test(statusText)) statusClass += " device-status-pill-bad";
          else statusClass += " device-status-pill-warn";
          const activePill = d.is_active
            ? "<span class=\"device-active-pill device-active-pill-on\">å¯ç”¨</span>"
            : "<span class=\"device-active-pill device-active-pill-off\">åœç”¨</span>";
          const qrLink = (d.is_active && !d.is_deleted)
            ? "<button type=\"button\" class=\"device-qrcode-link\" data-id=\"" + d.id + "\" title=\"ç‚¹å‡»æŸ¥çœ‹äºŒç»´ç \"><span class=\"qr-icon\" aria-hidden=\"true\"></span><span class=\"qr-text\">äºŒç»´ç </span></button>"
            : "<span class=\"device-qrcode-disabled\">æ— æƒé™æŸ¥çœ‹</span>";
          var actionParts = [];
          if (!d.is_deleted) {
            actionParts.push(d.is_active
              ? "<button type=\"button\" class=\"btn-disable\" data-id=\"" + d.id + "\">åœç”¨</button>"
              : "<button type=\"button\" class=\"btn-enable\" data-id=\"" + d.id + "\">å¯ç”¨</button>");
            actionParts.push("<button type=\"button\" class=\"btn-edit-device\" data-id=\"" + d.id + "\" data-device-code=\"" + escapeHtml(d.device_code || "") + "\" data-name=\"" + escapeHtml(d.name || "") + "\" data-dept=\"" + escapeHtml(d.dept || "") + "\" data-status=\"" + (d.status != null ? d.status : "1") + "\">ç¼–è¾‘</button>");
            actionParts.push("<button type=\"button\" class=\"btn-delete-device\" data-id=\"" + d.id + "\">åˆ é™¤</button>");
          } else {
            actionParts.push("<button type=\"button\" class=\"btn-restore-device\" data-id=\"" + d.id + "\">æ¢å¤</button>");
          }
          tr.innerHTML =
            "<td class=\"device-code-cell\">" + escapeHtml(d.device_code) + "</td>" +
            "<td class=\"device-name-cell\">" + escapeHtml(d.name || "") + "</td>" +
            "<td class=\"device-dept-cell\">" + escapeHtml(d.dept || "") + "</td>" +
            "<td class=\"device-status-cell\"><span class=\"" + statusClass + "\">" + escapeHtml(statusText) + "</span></td>" +
            "<td>" + activePill + "</td>" +
            "<td>" + qrLink + "</td>" +
            "<td>" + actionParts.join(" ") + "</td>";
          tr.className = activeClass;
          tbody.appendChild(tr);
          if (!d.is_deleted) {
            const opt = document.createElement("option");
            opt.value = d.name + " (" + d.device_code + ")" + (d.is_active ? "" : " [å·²åœç”¨]");
            deviceOptions.appendChild(opt);
          }
          if (d.dept && !seenDepts.has(d.dept)) {
            seenDepts.add(d.dept);
            const deptOpt = document.createElement("option");
            deptOpt.value = d.dept;
            deptOptions.appendChild(deptOpt);
            if (deviceDeptOptionsEl) {
              const opt = document.createElement("option");
              opt.value = d.dept;
              deviceDeptOptionsEl.appendChild(opt);
            }
          }
        });
        var start = offset + 1;
        var end = offset + list.length;
        document.getElementById("device-page-info").textContent = "å…± " + deviceTotal + " æ¡ï¼Œå½“å‰ç¬¬ " + (deviceTotal ? start : 0) + "â€“" + end + " æ¡";
        document.getElementById("device-prev").disabled = devicePage === 0;
        document.getElementById("device-next").disabled = end >= deviceTotal;
        var deviceTableEl = document.getElementById("table-devices");
        if (deviceTableEl && typeof initResizableColumns === "function") initResizableColumns(deviceTableEl);
        if (typeof initDeviceHScrollSync === "function") initDeviceHScrollSync();
        tbody.querySelectorAll(".btn-disable").forEach(btn => {
          btn.onclick = () => setDeviceActive(parseInt(btn.dataset.id, 10), false);
        });
        tbody.querySelectorAll(".btn-enable").forEach(btn => {
          btn.onclick = () => setDeviceActive(parseInt(btn.dataset.id, 10), true);
        });
        tbody.querySelectorAll(".btn-edit-device").forEach(btn => {
          btn.onclick = function () {
            var tr = trFromBtn(btn);
            openDeviceEdit(parseInt(btn.dataset.id, 10), btn.dataset.deviceCode || "", btn.dataset.name || "", btn.dataset.dept || "", btn.dataset.status || "1", tr);
          };
        });
        tbody.querySelectorAll(".btn-delete-device").forEach(btn => {
          btn.onclick = () => {
            var id = parseInt(btn.dataset.id, 10);
            if (!id) return;
            var ok = confirm("ç¡®å®šè¦åˆ é™¤è¯¥è®¾å¤‡å—ï¼Ÿåˆ é™¤åå¯åœ¨ã€Œåªæ˜¾ç¤ºå·²åˆ é™¤ã€ä¸­æ¢å¤ã€‚");
            if (!ok) return;
            deviceSoftDelete(id);
          };
        });
        tbody.querySelectorAll(".btn-restore-device").forEach(btn => {
          btn.onclick = () => deviceRestore(parseInt(btn.dataset.id, 10));
        });
        tbody.querySelectorAll(".device-qrcode-link").forEach(btn => {
          btn.onclick = function () { openDeviceQrModal(parseInt(btn.dataset.id, 10)); };
        });
        return list;
      }
      var deviceQrModalCurrentUrl = null;
      function closeDeviceQrModal() {
        var modal = document.getElementById("device-qr-modal");
        var img = document.getElementById("device-qr-modal-img");
        if (deviceQrModalCurrentUrl) { URL.revokeObjectURL(deviceQrModalCurrentUrl); deviceQrModalCurrentUrl = null; }
        if (img) img.removeAttribute("src");
        if (modal) modal.style.display = "none";
      }
      async function openDeviceQrModal(deviceId) {
        if (!deviceId) return;
        closeDeviceQrModal();
        var modal = document.getElementById("device-qr-modal");
        var img = document.getElementById("device-qr-modal-img");
        if (!modal || !img) return;
        modal.style.display = "flex";
        try {
          var res = await fetch("/api/devices/" + deviceId + "/qrcode", { headers: authHeaders() });
          if (!res.ok) { img.alt = "åŠ è½½å¤±è´¥"; return; }
          var blob = await res.blob();
          deviceQrModalCurrentUrl = URL.createObjectURL(blob);
          img.src = deviceQrModalCurrentUrl;
          img.alt = "è®¾å¤‡äºŒç»´ç ";
        } catch (e) {
          img.alt = "åŠ è½½å¤±è´¥";
        }
      }
      document.getElementById("device-prev").onclick = function () { if (devicePage > 0) { devicePage--; loadDevices(); } };
      document.getElementById("device-next").onclick = function () { if ((devicePage + 1) * devicePageSize < deviceTotal) { devicePage++; loadDevices(); } };
      var devicePageSizeEl = document.getElementById("device-page-size");
      if (devicePageSizeEl) devicePageSizeEl.onchange = function () { devicePageSize = parseInt(devicePageSizeEl.value, 10) || 20; devicePage = 0; loadDevices(); };
      var btnDeviceQuery = document.getElementById("btn-device-query");
      if (btnDeviceQuery) btnDeviceQuery.onclick = function () { devicePage = 0; loadDevices(); };
      var btnDeviceReset = document.getElementById("btn-device-reset");
      if (btnDeviceReset) btnDeviceReset.onclick = function () {
        var newCodeEl = document.getElementById("new-code");
        var newNameEl = document.getElementById("new-name");
        var newDeptEl = document.getElementById("new-dept");
        if (newCodeEl) newCodeEl.value = "";
        if (newNameEl) newNameEl.value = "";
        if (newDeptEl) newDeptEl.value = "";
        devicePage = 0;
        loadDevices();
      };
      function bindDeviceFilterEnter() {
        var run = function (e) { if (e.key === "Enter") { e.preventDefault(); devicePage = 0; loadDevices(); } };
        ["new-code", "new-name", "new-dept"].forEach(function (id) {
          var el = document.getElementById(id);
          if (el) el.addEventListener("keydown", run);
        });
      }
      bindDeviceFilterEnter();

      async function doDeviceExport(format) {
        var btnCsv = document.getElementById("btn-device-export-csv");
        var btnXlsx = document.getElementById("btn-device-export-xlsx");
        if (btnCsv) { btnCsv.disabled = true; btnCsv.textContent = "å¯¼å‡ºä¸­..."; }
        if (btnXlsx) { btnXlsx.disabled = true; btnXlsx.textContent = "å¯¼å‡ºä¸­..."; }
        try {
          var deletedOnly = document.getElementById("device-deleted-only") && document.getElementById("device-deleted-only").checked;
          var inactiveOnly = document.getElementById("device-inactive-only") && document.getElementById("device-inactive-only").checked;
          var newCodeEl = document.getElementById("new-code");
          var newNameEl = document.getElementById("new-name");
          var newDeptEl = document.getElementById("new-dept");
          var q = (newCodeEl && newCodeEl.value || "").trim() || (newNameEl && newNameEl.value || "").trim();
          var dept = (newDeptEl && newDeptEl.value || "").trim();
          var url = "/api/devices/export?format=" + encodeURIComponent(format) + "&include_inactive=1";
          if (deletedOnly) url += "&deleted_only=1";
          else if (inactiveOnly) url += "&inactive_only=1";
          if (q) url += "&q=" + encodeURIComponent(q);
          if (dept) url += "&dept=" + encodeURIComponent(dept);
          var msgEl = document.getElementById("device-msg");
          var res = await fetch(url, { headers: authHeaders() });
          if (!res.ok) {
            var err = await res.json().catch(function () { return {}; });
            msgEl.textContent = err.detail || "å¯¼å‡ºå¤±è´¥ï¼ˆéœ€ç®¡ç†å‘˜æƒé™ï¼‰";
            msgEl.className = "msg err";
            return;
          }
          var blob = await res.blob();
          var a = document.createElement("a");
          a.href = URL.createObjectURL(blob);
          a.download = format === "xlsx" ? "devices.xlsx" : "devices.csv";
          a.click();
          URL.revokeObjectURL(a.href);
          msgEl.textContent = "å·²å¯¼å‡º";
          msgEl.className = "msg ok";
        } finally {
          if (btnCsv) { btnCsv.disabled = false; btnCsv.textContent = "å¯¼å‡º CSV"; }
          if (btnXlsx) { btnXlsx.disabled = false; btnXlsx.textContent = "å¯¼å‡º Excel"; }
        }
      }
      document.getElementById("btn-device-export-csv").onclick = function () { doDeviceExport("csv"); };
      document.getElementById("btn-device-export-xlsx").onclick = function () { doDeviceExport("xlsx"); };
      (function () {
        var importModal = document.getElementById("device-import-modal");
        var importFile = document.getElementById("device-import-file");
        var importMsg = document.getElementById("device-import-msg");
        var btnImport = document.getElementById("btn-device-import");
        var btnImportCancel = document.getElementById("device-import-cancel");
        var btnImportSubmit = document.getElementById("device-import-submit");
        var btnDownloadTpl = document.getElementById("device-import-download-tpl");
        if (btnImport) btnImport.onclick = function () {
          if (importModal) importModal.style.display = "flex";
          if (importMsg) { importMsg.textContent = ""; importMsg.className = "msg"; }
          if (importFile) importFile.value = "";
        };
        if (btnImportCancel) btnImportCancel.onclick = function () { if (importModal) importModal.style.display = "none"; };
        var importBackdrop = importModal ? importModal.querySelector(".user-pw-modal-backdrop") : null;
        if (importBackdrop) importBackdrop.onclick = function () { if (importModal) importModal.style.display = "none"; };
        if (btnDownloadTpl) btnDownloadTpl.onclick = function () {
          fetch("/api/devices/import-template", { headers: authHeaders() })
            .then(function (r) { return r.ok ? r.blob() : Promise.reject(new Error("ä¸‹è½½å¤±è´¥")); })
            .then(function (blob) {
              var a = document.createElement("a");
              a.href = URL.createObjectURL(blob);
              a.download = "devices_import_template.xlsx";
              a.click();
              URL.revokeObjectURL(a.href);
            })
            .catch(function () { alert("ä¸‹è½½æ¨¡æ¿å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç™»å½•çŠ¶æ€"); });
        };
        if (btnImportSubmit) btnImportSubmit.onclick = function () {
          if (!importFile || !importFile.files || !importFile.files[0]) { alert("è¯·é€‰æ‹©è¦ä¸Šä¼ çš„ Excel æ–‡ä»¶"); return; }
          var fd = new FormData();
          fd.append("file", importFile.files[0]);
          btnImportSubmit.disabled = true;
          if (importMsg) { importMsg.textContent = "å¯¼å…¥ä¸­..."; importMsg.className = "msg"; }
          fetch("/api/devices/import", { method: "POST", headers: authHeaders(), body: fd })
            .then(function (r) { return r.json().then(function (data) { return { ok: r.ok, data: data }; }); })
            .then(function (res) {
              btnImportSubmit.disabled = false;
              if (!res.ok) {
                if (importMsg) { importMsg.textContent = res.data.detail || "å¯¼å…¥å¤±è´¥"; importMsg.className = "msg err"; }
                return;
              }
              var d = res.data;
              var lines = ["æˆåŠŸå¯¼å…¥ " + (d.created || 0) + " æ¡ï¼Œè·³è¿‡ " + (d.skipped || 0) + " æ¡."];
              if (d.errors && d.errors.length) lines.push(d.errors.slice(0, 5).join(" "));
              if (d.errors && d.errors.length > 5) lines.push("â€¦ å…± " + d.errors.length + " æ¡æç¤º");
              if (importMsg) { importMsg.innerHTML = lines.join("<br>"); importMsg.className = "msg ok"; }
              loadDevices(); if (typeof loadDashboardStats === "function") loadDashboardStats();
            })
            .catch(function () { btnImportSubmit.disabled = false; if (importMsg) { importMsg.textContent = "ç½‘ç»œå¼‚å¸¸"; importMsg.className = "msg err"; } });
        };
      })();

      function trFromBtn(btn) {
        let el = btn;
        while (el && el.tagName !== "TR") el = el.parentElement;
        return el;
      }
      var deviceStatusOptions = null;
      async function getDeviceStatusOptions() {
        if (deviceStatusOptions) return deviceStatusOptions;
        const res = await fetch("/api/dict?dict_type=device_status", { headers: authHeaders() });
        if (!res.ok) return [];
        deviceStatusOptions = await res.json();
        return deviceStatusOptions;
      }
      async function openDeviceEdit(deviceId, deviceCode, name, dept, statusCode, tr) {
        const opts = await getDeviceStatusOptions();
        let selectHtml = "<select class=\"device-edit-select\" data-field=\"status\">";
        var statusVal = typeof statusCode === "string" ? parseInt(statusCode, 10) : statusCode;
        opts.forEach(function (o) {
          var c = o.code;
          selectHtml += "<option value=\"" + c + "\"" + (c === statusVal || c === statusCode ? " selected" : "") + ">" + (o.label || c) + "</option>";
        });
        selectHtml += "</select>";
        const codeCell = tr.querySelector(".device-code-cell");
        const nameCell = tr.querySelector(".device-name-cell");
        const deptCell = tr.querySelector(".device-dept-cell");
        const statusCell = tr.querySelector(".device-status-cell");
        const oldCode = codeCell ? codeCell.innerHTML : "";
        const oldName = nameCell.innerHTML;
        const oldDept = deptCell.innerHTML;
        const oldStatus = statusCell.innerHTML;
        if (codeCell) codeCell.innerHTML = "<input class=\"device-edit-input\" data-field=\"device_code\" value=\"" + escapeHtml(deviceCode || "") + "\" placeholder=\"è®¾å¤‡ç¼–å·\" />";
        nameCell.innerHTML = "<input class=\"device-edit-input\" data-field=\"name\" value=\"" + escapeHtml(name || "") + "\" />";
        deptCell.innerHTML = "<input class=\"device-edit-input\" data-field=\"dept\" value=\"" + escapeHtml(dept || "") + "\" />";
        statusCell.innerHTML = selectHtml + " <button type=\"button\" class=\"device-edit-save\">ä¿å­˜</button> <button type=\"button\" class=\"device-edit-cancel\">å–æ¶ˆ</button>";
        tr.querySelector(".device-edit-save").onclick = async function () {
          var newCode = codeCell ? tr.querySelector("input[data-field=device_code]").value.trim() : (deviceCode || "");
          const newName = tr.querySelector("input[data-field=name]").value.trim();
          const newDept = tr.querySelector("input[data-field=dept]").value.trim();
          const newStatus = parseInt(tr.querySelector("select[data-field=status]").value, 10);
          var body = { name: newName, dept: newDept || null, status: newStatus };
          if (codeCell) body.device_code = newCode;
          const res = await fetch("/api/devices/" + deviceId, {
            method: "PATCH",
            headers: { "Content-Type": "application/json", ...authHeaders() },
            body: JSON.stringify(body)
          });
          if (res.ok) { loadDevices(); loadDashboardStats(); if (typeof loadAudit === "function") loadAudit(); document.getElementById("device-msg").textContent = "å·²ä¿å­˜"; document.getElementById("device-msg").className = "msg ok"; }
          else { var e = await res.json().catch(function(){return{};}); alert(e.detail || "ä¿å­˜å¤±è´¥"); }
        };
        tr.querySelector(".device-edit-cancel").onclick = function () {
          if (codeCell) codeCell.innerHTML = oldCode;
          nameCell.innerHTML = oldName;
          deptCell.innerHTML = oldDept;
          statusCell.innerHTML = oldStatus;
        };
      }
      async function deviceSoftDelete(deviceId) {
        if (!confirm("ç¡®å®šåˆ é™¤ï¼Ÿä»…æ‰“æ ‡è¯†ä¸ç‰©ç†åˆ é™¤ï¼Œå¯å‹¾é€‰ã€Œåªæ˜¾ç¤ºå·²åˆ é™¤ã€åæ¢å¤ã€‚")) return;
        const res = await fetch("/api/devices/" + deviceId, {
          method: "PATCH",
          headers: { "Content-Type": "application/json", ...authHeaders() },
          body: JSON.stringify({ is_deleted: true })
        });
        if (res.ok) { loadDevices(); loadDashboardStats(); if (typeof loadAudit === "function") loadAudit(); document.getElementById("device-msg").textContent = "å·²åˆ é™¤"; document.getElementById("device-msg").className = "msg ok"; }
        else { var e = await res.json().catch(function(){return{};}); document.getElementById("device-msg").textContent = e.detail || "åˆ é™¤å¤±è´¥"; document.getElementById("device-msg").className = "msg err"; }
      }
      async function deviceRestore(deviceId) {
        const res = await fetch("/api/devices/" + deviceId, {
          method: "PATCH",
          headers: { "Content-Type": "application/json", ...authHeaders() },
          body: JSON.stringify({ is_deleted: false })
        });
        if (res.ok) { loadDevices(); loadDashboardStats(); if (typeof loadAudit === "function") loadAudit(); document.getElementById("device-msg").textContent = "å·²æ¢å¤"; document.getElementById("device-msg").className = "msg ok"; }
        else { var e = await res.json().catch(function(){return{};}); document.getElementById("device-msg").textContent = e.detail || "æ¢å¤å¤±è´¥"; document.getElementById("device-msg").className = "msg err"; }
      }

      async function setDeviceActive(deviceId, isActive) {
        const msg = document.getElementById("device-msg");
        msg.textContent = isActive ? "å¯ç”¨ä¸­..." : "åœç”¨ä¸­...";
        msg.className = "msg";
        const res = await fetch("/api/devices/" + deviceId, {
          method: "PATCH",
          headers: { "Content-Type": "application/json", ...authHeaders() },
          body: JSON.stringify({ is_active: isActive })
        });
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          msg.textContent = err.detail || (isActive ? "å¯ç”¨å¤±è´¥" : "åœç”¨å¤±è´¥");
          msg.className = "msg err";
          return;
        }
        msg.textContent = isActive ? "å·²å¯ç”¨" : "å·²åœç”¨";
        msg.className = "msg ok";
        loadDevices();
        loadDashboardStats();
        if (typeof loadAudit === "function") loadAudit();
      }

      document.getElementById("btn-add").onclick = async function () {
        const code = document.getElementById("new-code").value.trim();
        const name = document.getElementById("new-name").value.trim();
        const dept = document.getElementById("new-dept").value.trim();
        const msg = document.getElementById("device-msg");
        if (!code || !name || !dept) { msg.textContent = "è¯·å¡«å†™è®¾å¤‡ç¼–å·ã€è®¾å¤‡åç§°å’Œç§‘å®¤"; msg.className = "msg err"; return; }
        msg.textContent = "æäº¤ä¸­...";
        msg.className = "msg";
        const res = await fetch("/api/devices", {
          method: "POST",
          headers: { "Content-Type": "application/json", ...authHeaders() },
          body: JSON.stringify({ device_code: code, name: name, dept: dept, status: 1, is_active: true })
        });
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          msg.textContent = err.detail || "æ–°å¢å¤±è´¥";
          msg.className = "msg err";
          return;
        }
        msg.textContent = "å·²æ·»åŠ ";
        msg.className = "msg ok";
        document.getElementById("new-code").value = "";
        document.getElementById("new-name").value = "";
        document.getElementById("new-dept").value = "";
        devicePage = 0;
        loadDevices();
        loadDashboardStats();
        if (typeof loadAudit === "function") loadAudit();
      };

      var userPage = 0;
      var userPageSize = 100;
      var userTotal = 0;

      var userPwModal = document.getElementById("user-pw-modal");
      var userPwBackdrop = document.querySelector("#user-pw-modal .user-pw-modal-backdrop");
      var userPwSub = document.getElementById("user-pw-sub");
      var userPwNew = document.getElementById("user-pw-new");
      var userPwConfirm = document.getElementById("user-pw-confirm");
      var userPwMsg = document.getElementById("user-pw-msg");
      var userPwCancel = document.getElementById("user-pw-cancel");
      var userPwSave = document.getElementById("user-pw-save");
      var userPwTarget = null; // {id, username, real_name}
      var userAddModal = document.getElementById("user-add-modal");
      var userAddBackdrop = document.querySelector("#user-add-modal .user-pw-modal-backdrop");
      var userAddUsername = document.getElementById("user-add-username");
      var userAddPassword = document.getElementById("user-add-password");
      var userAddRealname = document.getElementById("user-add-realname");
      var userAddRole = document.getElementById("user-add-role");
      var userAddDept = document.getElementById("user-add-dept");
      var userAddMsg = document.getElementById("user-add-msg");
      var userAddCancel = document.getElementById("user-add-cancel");
      var userAddSubmit = document.getElementById("user-add-submit");

      function openUserAddModal() {
        if (!userAddModal) return;
        if (userAddUsername) userAddUsername.value = "";
        if (userAddPassword) userAddPassword.value = "";
        if (userAddRealname) userAddRealname.value = "";
        if (userAddDept) userAddDept.value = "";
        if (userAddMsg) { userAddMsg.textContent = ""; userAddMsg.className = "msg"; }
        if (userAddRole) {
          userAddRole.innerHTML = "";
          var opts = [{ v: "user", l: "æ™®é€šç”¨æˆ·" }];
          if (currentUserRole === "sys_admin") {
            opts.push({ v: "device_admin", l: "è®¾å¤‡ç®¡ç†å‘˜" }, { v: "sys_admin", l: "ç³»ç»Ÿç®¡ç†å‘˜" });
          }
          opts.forEach(function (o) {
            var opt = document.createElement("option");
            opt.value = o.v;
            opt.textContent = o.l;
            userAddRole.appendChild(opt);
          });
        }
        if (userAddSubmit) { userAddSubmit.disabled = false; userAddSubmit.textContent = "ç¡®å®š"; }
        userAddModal.style.display = "flex";
        try { if (userAddUsername) userAddUsername.focus(); } catch (e) {}
      }

      function closeUserAddModal() {
        if (!userAddModal) return;
        userAddModal.style.display = "none";
      }

      async function submitUserAdd() {
        if (!userAddUsername || !userAddPassword || !userAddRealname || !userAddRole || !userAddMsg || !userAddSubmit) return;
        var username = (userAddUsername.value || "").trim();
        var password = (userAddPassword.value || "");
        var realName = (userAddRealname.value || "").trim();
        var role = (userAddRole.value || "user");
        var dept = (userAddDept && userAddDept.value) ? userAddDept.value.trim() : "";
        if (!username) { userAddMsg.textContent = "è¯·è¾“å…¥ç”¨æˆ·å"; userAddMsg.className = "msg err"; return; }
        if (!password || password.length < 6) { userAddMsg.textContent = "å¯†ç è‡³å°‘ 6 ä½"; userAddMsg.className = "msg err"; return; }
        if (!realName) { userAddMsg.textContent = "è¯·è¾“å…¥å§“å"; userAddMsg.className = "msg err"; return; }
        userAddSubmit.disabled = true;
        userAddSubmit.textContent = "æäº¤ä¸­...";
        userAddMsg.textContent = "æäº¤ä¸­...";
        userAddMsg.className = "msg";
        try {
          var res = await fetch("/api/users", {
            method: "POST",
            headers: { "Content-Type": "application/json", ...authHeaders() },
            body: JSON.stringify({ username: username, password: password, real_name: realName, role: role, dept: dept || null })
          });
          var data = await res.json().catch(function () { return {}; });
          if (!res.ok) {
            userAddMsg.textContent = data.detail || ("åˆ›å»ºå¤±è´¥ï¼ˆ" + res.status + "ï¼‰");
            userAddMsg.className = "msg err";
            userAddSubmit.disabled = false;
            userAddSubmit.textContent = "ç¡®å®š";
            return;
          }
          userAddMsg.textContent = "å·²åˆ›å»º";
          userAddMsg.className = "msg ok";
          userAddSubmit.textContent = "å·²åˆ›å»º";
          loadUsers();
          if (typeof loadDashboardStats === "function") loadDashboardStats();
          setTimeout(closeUserAddModal, 500);
        } catch (e) {
          userAddMsg.textContent = "ç½‘ç»œå¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•";
          userAddMsg.className = "msg err";
          userAddSubmit.disabled = false;
          userAddSubmit.textContent = "ç¡®å®š";
        }
      }

      async function setUserActive(u, active) {
        if (!u || u.id == null) return;
        var title = active ? "å¯ç”¨è´¦å·" : "åœç”¨è´¦å·";
        var who = (u.real_name || u.username || u.wx_userid || ("ID " + u.id));
        if (!confirm("ç¡®è®¤" + title + "ï¼š" + who + "ï¼Ÿ")) return;
        try {
          var res = await fetch("/api/users/" + encodeURIComponent(u.id) + "/active", {
            method: "PATCH",
            headers: { "Content-Type": "application/json", ...authHeaders() },
            body: JSON.stringify({ is_active: !!active })
          });
          var data = await res.json().catch(function () { return {}; });
          if (!res.ok) {
            alert(data.detail || (title + "å¤±è´¥ï¼ˆ" + res.status + "ï¼‰"));
            return;
          }
          loadUsers();
        } catch (e) {
          alert("ç½‘ç»œå¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•");
        }
      }

      function openUserPwModal(u) {
        if (!userPwModal) return;
        userPwTarget = u ? { id: u.id, username: u.username || "", real_name: u.real_name || "" } : null;
        if (userPwSub) {
          var who = (u && (u.real_name || u.username)) ? ((u.real_name || u.username) + (u.username ? ("ï¼ˆ" + u.username + "ï¼‰") : "")) : "";
          userPwSub.textContent = who ? ("ä¸ºç”¨æˆ· " + who + " è®¾ç½®æ–°å¯†ç ") : "è®¾ç½®æ–°å¯†ç ";
        }
        if (userPwNew) userPwNew.value = "";
        if (userPwConfirm) userPwConfirm.value = "";
        if (userPwMsg) { userPwMsg.textContent = ""; userPwMsg.className = "msg"; }
        if (userPwSave) { userPwSave.disabled = false; userPwSave.textContent = "ä¿å­˜"; }
        userPwModal.style.display = "flex";
        try { if (userPwNew) userPwNew.focus(); } catch (e) {}
      }

      function closeUserPwModal() {
        if (!userPwModal) return;
        userPwModal.style.display = "none";
        userPwTarget = null;
      }

      async function submitUserPw() {
        if (!userPwTarget) return;
        if (!userPwNew || !userPwConfirm || !userPwMsg || !userPwSave) return;
        var p1 = (userPwNew.value || "");
        var p2 = (userPwConfirm.value || "");
        if (!p1 || p1.length < 6) { userPwMsg.textContent = "æ–°å¯†ç è‡³å°‘ 6 ä½"; userPwMsg.className = "msg err"; return; }
        if (p1 !== p2) { userPwMsg.textContent = "ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´"; userPwMsg.className = "msg err"; return; }
        userPwSave.disabled = true;
        userPwSave.textContent = "ä¿å­˜ä¸­...";
        userPwMsg.textContent = "ä¿å­˜ä¸­...";
        userPwMsg.className = "msg";
        try {
          var res = await fetch("/api/users/" + encodeURIComponent(userPwTarget.id) + "/password", {
            method: "PATCH",
            headers: { "Content-Type": "application/json", ...authHeaders() },
            body: JSON.stringify({ password: p1 })
          });
          var data = await res.json().catch(function () { return {}; });
          if (!res.ok) {
            userPwMsg.textContent = data.detail || ("ä¿å­˜å¤±è´¥ï¼ˆ" + res.status + "ï¼‰");
            userPwMsg.className = "msg err";
            userPwSave.disabled = false;
            userPwSave.textContent = "ä¿å­˜";
            return;
          }
          userPwMsg.textContent = "å·²ä¿å­˜";
          userPwMsg.className = "msg ok";
          userPwSave.textContent = "å·²ä¿å­˜";
          setTimeout(closeUserPwModal, 400);
        } catch (e) {
          userPwMsg.textContent = "ç½‘ç»œå¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•";
          userPwMsg.className = "msg err";
          userPwSave.disabled = false;
          userPwSave.textContent = "ä¿å­˜";
        }
      }

      async function loadUsers() {
        var tbody = document.getElementById("user-list");
        if (tbody) tbody.innerHTML = "<tr><td colspan=\"7\" class=\"loading-cell\">åŠ è½½ä¸­...</td></tr>";
        var offset = userPage * userPageSize;
        var listUrl = "/api/users?limit=" + userPageSize + "&offset=" + offset;
        try {
          var listRes = await fetch(listUrl, { headers: authHeaders() });
          var countRes = await fetch("/api/users/count", { headers: authHeaders() });
          if (!listRes.ok) return;
          var list = await listRes.json();
          userTotal = countRes.ok ? (await countRes.json()).total : list.length;
          tbody = document.getElementById("user-list");
          if (!tbody) return;
          tbody.innerHTML = "";
          var roleLabels = { user: "æ™®é€šç”¨æˆ·", device_admin: "è®¾å¤‡ç®¡ç†å‘˜", sys_admin: "ç³»ç»Ÿç®¡ç†å‘˜" };
          function appendTd(tr, text) { var td = document.createElement("td"); td.textContent = text; tr.appendChild(td); return td; }
          (list || []).forEach(function (u) {
            var tr = document.createElement("tr");
            var createdAt = u.created_at ? new Date(u.created_at).toLocaleString("zh-CN") : "";
            appendTd(tr, (u && u.id != null) ? String(u.id) : "");
            appendTd(tr, (u && u.username) ? String(u.username) : "â€”");
            appendTd(tr, (u && u.real_name) ? String(u.real_name) : "â€”");
            appendTd(tr, roleLabels[u.role] || (u && u.role ? String(u.role) : "â€”"));
            appendTd(tr, (u && u.dept) ? String(u.dept) : "â€”");
            appendTd(tr, createdAt);
            var actionTd = document.createElement("td");
            var wrap = document.createElement("div");
            wrap.className = "user-row-actions";
            var role = (u && u.role) ? String(u.role) : "user";
            var isAdminTarget = (role === "device_admin" || role === "sys_admin");
            var isSelf = u && (currentUserId != null && u.id === currentUserId);

            // ä¿®æ”¹å¯†ç ï¼šä»…ç³»ç»Ÿç®¡ç†å‘˜ã€ä¸”ç›®æ ‡æœ‰æœ¬åœ°ç”¨æˆ·åæ—¶å¯æ“ä½œ
            if (currentUserRole === "sys_admin" && u && u.username) {
              var btnPw = document.createElement("button");
              btnPw.type = "button";
              btnPw.className = "secondary";
              btnPw.textContent = "ä¿®æ”¹å¯†ç ";
              btnPw.onclick = function () { openUserPwModal(u); };
              wrap.appendChild(btnPw);
            }

            // åœç”¨/å¯ç”¨ï¼šè®¾å¤‡ç®¡ç†å‘˜ä¸ç³»ç»Ÿç®¡ç†å‘˜å‡å¯æ“ä½œæ™®é€šç”¨æˆ·ï¼›ç®¡ç†å‘˜è´¦å·ä¸å¯åœç”¨ï¼›ä¸å¯æ“ä½œè‡ªå·±
            if (currentUserRole !== "device_admin" && currentUserRole !== "sys_admin") {
              if (!wrap.childNodes.length) wrap.appendChild(document.createTextNode("â€”"));
            } else if (u && u.id == null) {
              if (!wrap.childNodes.length) wrap.appendChild(document.createTextNode("â€”"));
            } else if (isSelf) {
              if (!wrap.childNodes.length) wrap.appendChild(document.createTextNode("â€”"));
            } else if (isAdminTarget) {
              var adminTxt = document.createElement("span");
              adminTxt.textContent = "ç®¡ç†å‘˜ä¸å¯åœç”¨";
              adminTxt.style.color = "var(--text-muted)";
              wrap.appendChild(adminTxt);
            } else {
              const active = (u && u.is_active !== undefined) ? !!u.is_active : true;
              var btnActive = document.createElement("button");
              btnActive.type = "button";
              btnActive.className = "secondary";
              btnActive.textContent = active ? "åœç”¨" : "å¯ç”¨";
              btnActive.onclick = function () { setUserActive(u, !active); };
              wrap.appendChild(btnActive);
            }
            if (!wrap.childNodes.length) actionTd.textContent = "â€”";
            else actionTd.appendChild(wrap);
            tr.appendChild(actionTd);
            tbody.appendChild(tr);
          });
          var start = offset + 1;
          var end = offset + list.length;
          var pageInfo = document.getElementById("user-page-info");
          var btnPrev = document.getElementById("user-prev");
          var btnNext = document.getElementById("user-next");
          if (pageInfo) pageInfo.textContent = "å…± " + userTotal + " æ¡ï¼Œå½“å‰ç¬¬ " + (userTotal ? start : 0) + "â€“" + end + " æ¡";
          if (btnPrev) btnPrev.disabled = userPage === 0;
          if (btnNext) btnNext.disabled = end >= userTotal;
        } catch (e) {}
      }
      var userPrevEl = document.getElementById("user-prev");
      var userNextEl = document.getElementById("user-next");
      if (userPrevEl) userPrevEl.onclick = function () { if (userPage > 0) { userPage--; loadUsers(); } };
      if (userNextEl) userNextEl.onclick = function () { if ((userPage + 1) * userPageSize < userTotal) { userPage++; loadUsers(); } };
      if (userPwCancel) userPwCancel.onclick = closeUserPwModal;
      if (userPwBackdrop) userPwBackdrop.onclick = closeUserPwModal;
      if (userPwSave) userPwSave.onclick = submitUserPw;
      var btnUserAdd = document.getElementById("btn-user-add");
      if (btnUserAdd) btnUserAdd.onclick = openUserAddModal;
      if (userAddCancel) userAddCancel.onclick = closeUserAddModal;
      if (userAddBackdrop) userAddBackdrop.onclick = closeUserAddModal;
      if (userAddSubmit) userAddSubmit.onclick = submitUserAdd;
      function userAddKeyHandler(e) {
        if (e.key === "Escape") { e.preventDefault(); closeUserAddModal(); }
        if (e.key === "Enter") { e.preventDefault(); submitUserAdd(); }
      }
      [userAddUsername, userAddPassword, userAddRealname, userAddRole, userAddDept].forEach(function (el) {
        if (el) el.addEventListener("keydown", userAddKeyHandler);
      });
      function userPwKeyHandler(e) {
        if (e.key === "Escape") { e.preventDefault(); closeUserPwModal(); }
        if (e.key === "Enter") { e.preventDefault(); submitUserPw(); }
      }
      if (userPwNew) userPwNew.addEventListener("keydown", userPwKeyHandler);
      if (userPwConfirm) userPwConfirm.addEventListener("keydown", userPwKeyHandler);

      var usagePage = 0;
      var usagePageSize = 20;
      var usageTotal = 0;
      function buildUsageQueryParams(prefix) {
        var deviceInput = (document.getElementById("filter-device") && document.getElementById("filter-device").value || "").trim();
        var deviceCode = "";
        var codeMatch = deviceInput.match(/\(([^)]+)\)/);
        if (codeMatch && codeMatch[1]) deviceCode = codeMatch[1].replace(/\s*\[å·²åœç”¨\]\s*$/, "").trim();
        else deviceCode = deviceInput;
        var dept = (document.getElementById("filter-dept") && document.getElementById("filter-dept").value || "").trim();
        var regFrom = (document.getElementById("filter-reg-from") && document.getElementById("filter-reg-from").value) || "";
        var regTo = (document.getElementById("filter-reg-to") && document.getElementById("filter-reg-to").value) || "";
        var bed = (document.getElementById("filter-bed") && document.getElementById("filter-bed").value || "").trim();
        var from = (document.getElementById("filter-from") && document.getElementById("filter-from").value) || "";
        var to = (document.getElementById("filter-to") && document.getElementById("filter-to").value) || "";
        var s = prefix || "";
        if (deviceCode) s += "device_code=" + encodeURIComponent(deviceCode) + "&";
        if (dept) s += "dept=" + encodeURIComponent(dept) + "&";
        if (regFrom) s += "registration_date_from=" + encodeURIComponent(regFrom) + "&";
        if (regTo) s += "registration_date_to=" + encodeURIComponent(regTo) + "&";
        if (bed) s += "bed_number=" + encodeURIComponent(bed) + "&";
        if (from) s += "from_time=" + encodeURIComponent(from + "T00:00:00") + "&";
        if (to) s += "to_time=" + encodeURIComponent(to + "T23:59:59") + "&";
        return s;
      }
      async function loadUsageSuggest() {
        var res = await fetch("/api/devices/suggest?limit=50", { headers: authHeaders() });
        if (!res.ok) return;
        var list = await res.json();
        var deviceOptions = document.getElementById("device-options");
        var deptOptions = document.getElementById("dept-options");
        if (deviceOptions) { deviceOptions.innerHTML = ""; list.forEach(function (d) { var o = document.createElement("option"); o.textContent = (d.name || "") + " (" + (d.device_code || "") + ")"; o.value = (d.name || "") + " (" + (d.device_code || "") + ")"; deviceOptions.appendChild(o); }); }
        if (deptOptions) { var seen = {}; list.forEach(function (d) { if (d.dept && !seen[d.dept]) { seen[d.dept] = true; var o = document.createElement("option"); o.value = d.dept; deptOptions.appendChild(o); } }); }
      }
      async function loadUsage() {
        var usageListEl = document.getElementById("usage-list");
        if (usageListEl) usageListEl.innerHTML = "<tr><td colspan=\"14\" class=\"loading-cell\">åŠ è½½ä¸­...</td></tr>";
        var offset = usagePage * usagePageSize;
        var queryParams = buildUsageQueryParams("limit=" + usagePageSize + "&offset=" + offset + "&");
        var countParams = buildUsageQueryParams("");
        var listUrl = "/api/usage?" + queryParams;
        var countUrl = "/api/usage/count?" + countParams;
        const [res, countRes] = await Promise.all([fetch(listUrl, { headers: authHeaders() }), fetch(countUrl, { headers: authHeaders() })]);
        const msg = document.getElementById("usage-msg");
        if (!res.ok) {
          msg.textContent = "åŠ è½½å¤±è´¥";
          msg.className = "msg err";
          return;
        }
        const data = await res.json();
        usageTotal = countRes.ok ? (await countRes.json()).total : data.length;
        var usageTypeMap = {};
        try {
          var usageTypeRes = await fetch("/api/dict?dict_type=usage_type", { headers: authHeaders() });
          if (usageTypeRes.ok) {
            var usageTypeList = await usageTypeRes.json();
            usageTypeList.forEach(function (o) { usageTypeMap[o.code] = o.label || String(o.code); });
          }
        } catch (e) {}
        var usageTypeLabel = function (code) { return usageTypeMap[code] != null ? usageTypeMap[code] : (code != null ? String(code) : ""); };
        const tbody = document.getElementById("usage-list");
        tbody.innerHTML = "";
        var EMPTY = "-";
        function regDateStr(r) { return r.registration_date ? (typeof r.registration_date === "string" ? r.registration_date : new Date(r.registration_date).toISOString().slice(0, 10)) : EMPTY; }
        function timeOnlyStr(iso) { return iso ? new Date(iso).toLocaleTimeString("zh-CN", { hour: "2-digit", minute: "2-digit" }) : EMPTY; }
        function eqCondStr(v) { return v === "abnormal" ? "å¼‚å¸¸" : (v === "normal" ? "æ­£å¸¸" : EMPTY); }
        function dailyStr(v) { return v === "disinfect" ? "æ¶ˆæ¯’" : (v === "clean" ? "æ¸…æ´" : EMPTY); }
        var USAGE_COLUMNS = [
          { label: "ç™»è®°æ—¥æœŸ", required: true },
          { label: "å®é™…ç™»è®°æ—¶é—´", required: true },
          { label: "è®¾å¤‡", required: true },
          { label: "åºŠå·", required: false },
          { label: "IDå·", required: false },
          { label: "å§“å", required: false },
          { label: "å¼€æœº", required: false },
          { label: "å…³æœº", required: false },
          { label: "ç»´æŠ¤äºº", required: false },
          { label: "ç±»å‹", required: true },
          { label: "è®¾å¤‡çŠ¶å†µ", required: false },
          { label: "æ—¥å¸¸ä¿å…»", required: false },
          { label: "ç»ˆæœ«æ¶ˆæ¯’", required: false },
          { label: "å¤‡æ³¨", required: false }
        ];
        var REQUIRED_INDICES = [0, 1, 2, 9];
        var MIDDLE_INDICES = [6, 7, 8];
        var OPTIONAL_INDICES = [10, 11, 12, 13];
        var OPTIONAL_FILL_LAST_INDICES = [3, 4, 5];
        function cellVal(title, text) {
          var t = text == null || text === undefined ? EMPTY : (String(text).trim() === "" ? EMPTY : String(text));
          var tit = title != null && title !== undefined && String(title).trim() !== "" ? String(title) : t;
          return { display: t, title: tit };
        }
        function cellValTrunc(text, maxLen) {
          var full = text == null || text === undefined ? "" : String(text);
          var display = full.trim() === "" ? EMPTY : (full.length > maxLen ? full.slice(0, maxLen) + "â€¦" : full);
          return { display: display, title: full || EMPTY };
        }
        usagePageSize = parseInt(document.getElementById("usage-page-size") && document.getElementById("usage-page-size").value, 10) || usagePageSize;
        var rowsCells = [];
        data.forEach(r => {
          var deviceCol = (r.device_name ? r.device_name + "ï¼ˆ" + (r.device_code ?? "") + "ï¼‰" : (r.device_code ?? ""));
          var createdStr = r.created_at ? new Date(r.created_at).toLocaleString() : EMPTY;
          rowsCells.push([
            cellVal(r.registration_date ? (typeof r.registration_date === "string" ? r.registration_date : new Date(r.registration_date).toISOString().slice(0, 10)) : null, regDateStr(r)),
            cellVal(r.created_at ? new Date(r.created_at).toLocaleString() : null, createdStr),
            cellVal(deviceCol, deviceCol || EMPTY),
            cellVal(r.bed_number, r.bed_number),
            cellVal(r.id_number, r.id_number),
            cellVal(r.patient_name, r.patient_name),
            cellVal(r.start_time ? new Date(r.start_time).toLocaleTimeString("zh-CN", { hour: "2-digit", minute: "2-digit" }) : null, timeOnlyStr(r.start_time)),
            cellVal(r.end_time ? new Date(r.end_time).toLocaleTimeString("zh-CN", { hour: "2-digit", minute: "2-digit" }) : null, timeOnlyStr(r.end_time)),
            cellVal(r.user_name || r.user_id, r.user_name ?? r.user_id ?? null),
            cellVal(usageTypeLabel(r.usage_type), usageTypeLabel(r.usage_type)),
            cellVal(eqCondStr(r.equipment_condition), eqCondStr(r.equipment_condition)),
            cellVal(dailyStr(r.daily_maintenance), dailyStr(r.daily_maintenance)),
            cellValTrunc(r.terminal_disinfection, 30),
            cellValTrunc(r.note, 40)
          ]);
        });
        var optionalAllDash = [];
        var optionalHasValue = [];
        OPTIONAL_INDICES.forEach(function (idx) {
          var allDash = rowsCells.length > 0 && rowsCells.every(function (cells) { return cells[idx].display === EMPTY; });
          if (allDash) optionalAllDash.push(idx); else optionalHasValue.push(idx);
        });
        var columnOrder = REQUIRED_INDICES.concat(MIDDLE_INDICES).concat(optionalHasValue).concat(optionalAllDash).concat(OPTIONAL_FILL_LAST_INDICES);
        var theadRow = document.getElementById("usage-thead-row");
        if (theadRow) theadRow.innerHTML = columnOrder.map(function (i) { return "<th>" + escapeHtml(USAGE_COLUMNS[i].label) + "</th>"; }).join("");
        rowsCells.forEach(function (cells) {
          var tr = document.createElement("tr");
          tr.innerHTML = columnOrder.map(function (i) {
            var c = cells[i];
            var isEmpty = c.display === EMPTY;
            var cls = isEmpty ? "cell-empty" : "";
            return "<td" + (cls ? " class=\"" + cls + "\"" : "") + " title=\"" + escapeHtml(c.title) + "\">" + escapeHtml(c.display) + "</td>";
          }).join("");
          tbody.appendChild(tr);
        });
        var usageTable = document.getElementById("table-usage");
        if (usageTable && typeof initResizableColumns === "function") initResizableColumns(usageTable);
        if (typeof initUsageHScrollSync === "function") initUsageHScrollSync();
        var start = offset + 1;
        var end = offset + data.length;
        document.getElementById("usage-page-info").textContent = "å…± " + usageTotal + " æ¡ï¼Œå½“å‰ç¬¬ " + (usageTotal ? start : 0) + "â€“" + end + " æ¡";
        document.getElementById("usage-prev").disabled = usagePage === 0;
        document.getElementById("usage-next").disabled = end >= usageTotal;
        msg.textContent = "";
        msg.className = "msg";
      }
      document.getElementById("usage-prev").onclick = function () { if (usagePage > 0) { usagePage--; loadUsage(); } };
      document.getElementById("usage-next").onclick = function () { if ((usagePage + 1) * usagePageSize < usageTotal) { usagePage++; loadUsage(); } };
      var usagePageSizeEl = document.getElementById("usage-page-size");
      if (usagePageSizeEl) {
        usagePageSizeEl.onchange = function () {
          usagePageSize = parseInt(usagePageSizeEl.value, 10) || 20;
          usagePage = 0;
          loadUsage();
        };
      }
      document.getElementById("btn-query").onclick = function () { usagePage = 0; loadUsage(); };

      (function () {
        var moreToggle = document.getElementById("usage-more-toggle");
        var morePanel = document.getElementById("usage-more-filters");
        if (moreToggle && morePanel) {
          moreToggle.onclick = function () {
            morePanel.classList.toggle("visible");
            moreToggle.textContent = morePanel.classList.contains("visible") ? "â–² æ”¶èµ·æ›´å¤šç­›é€‰" : "â–¼ å±•å¼€æ›´å¤šç­›é€‰";
          };
          moreToggle.addEventListener("keydown", function (e) { if (e.key === "Enter" || e.key === " ") { e.preventDefault(); moreToggle.click(); } });
        }
      })();

      var usageHScrollBound = false;
      function initUsageHScrollSync() {
        var wrap = document.getElementById("usage-table-wrap");
        var hScroll = document.getElementById("usage-table-h-scroll");
        var inner = document.getElementById("usage-table-h-scroll-inner");
        var tbl = document.getElementById("table-usage");
        if (!wrap || !hScroll || !inner || !tbl) return;
        var w = Math.max(tbl.scrollWidth, wrap.clientWidth);
        inner.style.width = w + "px";
        hScroll.scrollLeft = wrap.scrollLeft;
        if (!usageHScrollBound) {
          usageHScrollBound = true;
          wrap.addEventListener("scroll", function () {
            if (hScroll.scrollLeft !== wrap.scrollLeft) hScroll.scrollLeft = wrap.scrollLeft;
          });
          hScroll.addEventListener("scroll", function () {
            if (wrap.scrollLeft !== hScroll.scrollLeft) wrap.scrollLeft = hScroll.scrollLeft;
          });
        }
      }
      function initAuditHScrollSync() {
        var wrap = document.getElementById("audit-table-wrap");
        var hScroll = document.getElementById("audit-table-h-scroll");
        var inner = document.getElementById("audit-table-h-scroll-inner");
        var tbl = document.getElementById("table-audit");
        if (!wrap || !hScroll || !inner || !tbl) return;
        var w = Math.max(tbl.scrollWidth, wrap.clientWidth);
        inner.style.width = w + "px";
        hScroll.scrollLeft = wrap.scrollLeft;
        if (!window._auditHScrollBound) {
          window._auditHScrollBound = true;
          wrap.addEventListener("scroll", function () {
            if (hScroll.scrollLeft !== wrap.scrollLeft) hScroll.scrollLeft = wrap.scrollLeft;
          });
          hScroll.addEventListener("scroll", function () {
            if (wrap.scrollLeft !== hScroll.scrollLeft) wrap.scrollLeft = hScroll.scrollLeft;
          });
        }
      }
      window.addEventListener("resize", function () {
        if (typeof initUsageHScrollSync === "function") initUsageHScrollSync();
        if (typeof initDeviceHScrollSync === "function") initDeviceHScrollSync();
        if (typeof initAuditHScrollSync === "function") initAuditHScrollSync();
      });

      var deviceHScrollBound = false;
      function initDeviceHScrollSync() {
        var wrap = document.getElementById("device-table-wrap");
        var hScroll = document.getElementById("device-table-h-scroll");
        var inner = document.getElementById("device-table-h-scroll-inner");
        var tbl = document.getElementById("table-devices");
        if (!wrap || !hScroll || !inner || !tbl) return;
        var w = Math.max(tbl.scrollWidth, wrap.clientWidth);
        inner.style.width = w + "px";
        hScroll.scrollLeft = wrap.scrollLeft;
        if (!deviceHScrollBound) {
          deviceHScrollBound = true;
          wrap.addEventListener("scroll", function () {
            if (hScroll.scrollLeft !== wrap.scrollLeft) hScroll.scrollLeft = wrap.scrollLeft;
          });
          hScroll.addEventListener("scroll", function () {
            if (wrap.scrollLeft !== hScroll.scrollLeft) wrap.scrollLeft = hScroll.scrollLeft;
          });
        }
      }

      function buildExportUrl(format) {
        var deviceInput = (document.getElementById("filter-device") && document.getElementById("filter-device").value || "").trim();
        var deviceCode = "";
        var codeMatch = deviceInput.match(/\(([^)]+)\)/);
        if (codeMatch && codeMatch[1]) deviceCode = codeMatch[1].replace(/\s*\[å·²åœç”¨\]\s*$/, "").trim();
        else deviceCode = deviceInput;
        var dept = (document.getElementById("filter-dept") && document.getElementById("filter-dept").value || "").trim();
        var regFrom = (document.getElementById("filter-reg-from") && document.getElementById("filter-reg-from").value) || "";
        var regTo = (document.getElementById("filter-reg-to") && document.getElementById("filter-reg-to").value) || "";
        var bed = (document.getElementById("filter-bed") && document.getElementById("filter-bed").value || "").trim();
        var from = (document.getElementById("filter-from") && document.getElementById("filter-from").value) || "";
        var to = (document.getElementById("filter-to") && document.getElementById("filter-to").value) || "";
        var url = "/api/usage/export?format=" + encodeURIComponent(format);
        if (deviceCode) url += "&device_code=" + encodeURIComponent(deviceCode);
        if (dept) url += "&dept=" + encodeURIComponent(dept);
        if (regFrom) url += "&registration_date_from=" + encodeURIComponent(regFrom);
        if (regTo) url += "&registration_date_to=" + encodeURIComponent(regTo);
        if (bed) url += "&bed_number=" + encodeURIComponent(bed);
        if (from) url += "&from_time=" + encodeURIComponent(from + "T00:00:00");
        if (to) url += "&to_time=" + encodeURIComponent(to + "T23:59:59");
        return url;
      }
      async function doExport(format) {
        var btnCsv = document.getElementById("btn-export");
        var btnXlsx = document.getElementById("btn-export-xlsx");
        var btnPdf = document.getElementById("btn-export-pdf");
        if (btnCsv) { btnCsv.disabled = true; btnCsv.textContent = "å¯¼å‡ºä¸­..."; }
        if (btnXlsx) { btnXlsx.disabled = true; btnXlsx.textContent = "å¯¼å‡ºä¸­..."; }
        if (btnPdf) { btnPdf.disabled = true; btnPdf.textContent = "å¯¼å‡ºä¸­..."; }
        try {
          var msgEl = document.getElementById("usage-msg");
          var res = await fetch(buildExportUrl(format), { headers: authHeaders() });
          if (!res.ok) {
            var errBody = await res.json().catch(function () { return {}; });
            msgEl.textContent = errBody.detail || "å¯¼å‡ºå¤±è´¥ï¼ˆéœ€ç®¡ç†å‘˜æƒé™æˆ–æ¡ä»¶èŒƒå›´å†…è®°å½•è¶…è¿‡ 5 ä¸‡æ¡ï¼‰";
            msgEl.className = "msg err";
            return;
          }
          var blob = await res.blob();
          var names = { csv: "usage_records.csv", xlsx: "usage_records.xlsx", pdf: "usage_records.pdf" };
          var a = document.createElement("a");
          a.href = URL.createObjectURL(blob);
          a.download = names[format] || "usage_records.csv";
          a.click();
          URL.revokeObjectURL(a.href);
          msgEl.textContent = "å·²å¯¼å‡º";
          msgEl.className = "msg ok";
        } finally {
          if (btnCsv) { btnCsv.disabled = false; btnCsv.textContent = "å¯¼å‡º CSV"; }
          if (btnXlsx) { btnXlsx.disabled = false; btnXlsx.textContent = "å¯¼å‡º Excel"; }
          if (btnPdf) { btnPdf.disabled = false; btnPdf.textContent = "å¯¼å‡º PDF"; }
        }
      }
      document.getElementById("btn-export").onclick = function () { doExport("csv"); };
      document.getElementById("btn-export-xlsx").onclick = function () { doExport("xlsx"); };
      document.getElementById("btn-export-pdf").onclick = function () { doExport("pdf"); };

      function parseDeviceCodeFromDetails(details) {
        if (!details || details.indexOf("device_code=") !== 0) return { code: "", rest: details };
        var s = details.slice("device_code=".length);
        var comma = s.indexOf(",");
        if (comma >= 0) return { code: s.slice(0, comma), rest: s.slice(comma + 1).trim() };
        return { code: s, rest: "" };
      }
      function deviceLabelFromAuditRow(r, parsed) {
        var code = (parsed && parsed.code) ? parsed.code : (r.target_code != null && r.target_code !== "" ? String(r.target_code) : "");
        return code ? "è®¾å¤‡" + code : (r.target_id != null ? "è®¾å¤‡ ID " + r.target_id : "");
      }
      function formatAuditRow(r) {
        var action = r.action || "";
        var details = (r.details != null && r.details !== "") ? String(r.details) : "";
        var targetId = r.target_id != null ? r.target_id : "";
        var summary = "";
        var note = "";
        if (action === "device.create") {
          summary = "æ–°å¢è®¾å¤‡";
          var parsedCreate = parseDeviceCodeFromDetails(details);
          note = deviceLabelFromAuditRow(r, parsedCreate.code ? { code: parsedCreate.code } : null);
          if (!note && details) note = details;
        } else if (action === "device.update") {
          summary = "ä¿®æ”¹è®¾å¤‡ä¿¡æ¯";
          var parsed = parseDeviceCodeFromDetails(details);
          note = deviceLabelFromAuditRow(r, parsed);
          if (parsed.rest) {
            var labels = { name: "åç§°", dept: "ç§‘å®¤", location: "ä½ç½®", status: "çŠ¶æ€", is_active: "å¯ç”¨çŠ¶æ€" };
            var parts = parsed.rest.split(",").map(function (k) { return labels[k.trim()] || k.trim(); });
            note = (note ? note + "ï¼›" : "") + "ä¿®æ”¹é¡¹ï¼š" + parts.join("ã€");
          }
        } else if (action === "device.delete") {
          summary = "åˆ é™¤è®¾å¤‡ï¼ˆå¯å‹¾é€‰ã€Œåªæ˜¾ç¤ºå·²åˆ é™¤ã€åæ¢å¤ï¼‰";
          var parsed = parseDeviceCodeFromDetails(details);
          note = deviceLabelFromAuditRow(r, parsed);
        } else if (action === "device.restore") {
          summary = "æ¢å¤å·²åˆ é™¤çš„è®¾å¤‡";
          var parsed = parseDeviceCodeFromDetails(details);
          note = deviceLabelFromAuditRow(r, parsed);
        } else if (action === "usage.export") {
          var m = details.match(/format=(\w+),count=(\d+)/);
          if (m) {
            var fmtName = { csv: "CSV", xlsx: "Excel", pdf: "PDF" }[m[1]] || m[1];
            summary = "å¯¼å‡ºä½¿ç”¨è®°å½•ï¼ˆ" + fmtName + "ï¼Œå…± " + m[2] + " æ¡ï¼‰";
          } else {
            summary = "å¯¼å‡ºä½¿ç”¨è®°å½•";
            if (details) note = details;
          }
        } else if (action === "auth.login") {
          if (details === "wecom") {
            summary = "ç™»å½•ç³»ç»Ÿï¼ˆä¼ä¸šå¾®ä¿¡ï¼‰";
          } else if (details === "password") {
            summary = "ç™»å½•ç³»ç»Ÿï¼ˆè´¦å·å¯†ç ï¼‰";
          } else {
            summary = "ç™»å½•ç³»ç»Ÿ";
            if (details) note = details;
          }
        } else {
          summary = action || "â€”";
          if (details || targetId) note = [details, targetId ? "ID " + targetId : ""].filter(Boolean).join(" ");
        }
        return { summary: summary, note: note || "â€”" };
      }
      var auditLastRows = [];
      async function loadAudit() {
        const action = (document.getElementById("audit-filter-action") && document.getElementById("audit-filter-action").value) || "";
        const fromVal = (document.getElementById("audit-filter-from") && document.getElementById("audit-filter-from").value) || "";
        const toVal = (document.getElementById("audit-filter-to") && document.getElementById("audit-filter-to").value) || "";
        let url = "/api/audit-logs?limit=200";
        if (action) url += "&action=" + encodeURIComponent(action);
        if (fromVal) url += "&from_time=" + encodeURIComponent(fromVal + ":00");
        if (toVal) url += "&to_time=" + encodeURIComponent(toVal + ":59");
        const res = await fetch(url, { headers: authHeaders() });
        const msgEl = document.getElementById("audit-msg");
        const tbody = document.getElementById("audit-list");
        if (!tbody) return;
        tbody.innerHTML = "";
        if (!res.ok) {
          if (msgEl) { msgEl.textContent = "åŠ è½½å¤±è´¥ï¼ˆéœ€ç®¡ç†å‘˜æƒé™ï¼‰"; msgEl.className = "msg err"; }
          return;
        }
        const data = await res.json().catch(function () { return []; });
        const keywordEl = document.getElementById("audit-keyword");
        const kwRaw = keywordEl && keywordEl.value ? keywordEl.value.trim() : "";
        const kw = kwRaw.toLowerCase();
        function highlightAndEscape(text) {
          var s = text == null ? "" : String(text);
          if (!kw) return escapeHtml(s);
          var lower = s.toLowerCase();
          var parts = [];
          var i = 0;
          while (true) {
            var idx = lower.indexOf(kw, i);
            if (idx === -1) {
              parts.push(escapeHtml(s.slice(i)));
              break;
            }
            if (idx > i) {
              parts.push(escapeHtml(s.slice(i, idx)));
            }
            var matched = s.slice(idx, idx + kw.length);
            parts.push("<span class=\"audit-highlight\">" + escapeHtml(matched) + "</span>");
            i = idx + kw.length;
          }
          return parts.join("");
        }
        auditLastRows = [];
        const filtered = data.filter(function (r) {
          if (!kw) return true;
          var f = formatAuditRow(r);
          var actorName = (r.actor_name || ("#" + (r.actor_id || "")));
          var haystack = [
            actorName || "",
            r.action || "",
            f.summary || "",
            f.note || ""
          ].join(" ").toLowerCase();
          return haystack.indexOf(kw) !== -1;
        });
        filtered.forEach(function (r, idx) {
          const tr = document.createElement("tr");
          const timeStr = r.created_at ? new Date(r.created_at).toLocaleString() : "";
          const actor = (r.actor_name != null && r.actor_name !== "") ? r.actor_name : ("#" + (r.actor_id || ""));
          var formatted = formatAuditRow(r);
          var summaryText = formatted.summary || "";
          var noteText = formatted.note && formatted.note.trim() !== "â€”" ? formatted.note : "æ— å¤‡æ³¨";
          var actionTag = "";
          if (r.action === "device.create") {
            actionTag = "<span class=\"audit-tag-create\">æ–°å¢</span>";
          } else if (r.action && r.action.indexOf("export") !== -1) {
            actionTag = "<span class=\"audit-tag-export\">å¯¼å‡º</span>";
          }
          var noteClass = (formatted.note && formatted.note.trim() === "â€”") ? "audit-note-empty" : "";
          tr.innerHTML =
            "<td>" + escapeHtml(timeStr) + "</td>" +
            "<td>" + escapeHtml(actor || "â€”") + "</td>" +
            "<td>" + actionTag + highlightAndEscape(summaryText) + "</td>" +
            "<td class=\"" + noteClass + "\">" + highlightAndEscape(noteText) + "</td>";
          tbody.appendChild(tr);
          auditLastRows.push({
            time: timeStr,
            actor: actor || "",
            summary: summaryText,
            note: noteText
          });
        });
        if (msgEl) { msgEl.textContent = "å…± " + filtered.length + " æ¡"; msgEl.className = "msg"; }
      }
      if (document.getElementById("btn-audit-query")) {
        var btnAuditQuery = document.getElementById("btn-audit-query");
        btnAuditQuery.onclick = async function () {
          var oldText = btnAuditQuery.textContent;
          btnAuditQuery.disabled = true;
          btnAuditQuery.textContent = "æŸ¥è¯¢ä¸­...";
          try {
            await loadAudit();
          } finally {
            btnAuditQuery.disabled = false;
            btnAuditQuery.textContent = oldText;
          }
        };
        ["audit-filter-action", "audit-filter-from", "audit-filter-to"].forEach(function (id) {
          var el = document.getElementById(id);
          if (el) {
            el.addEventListener("keydown", function (e) {
              if (e.key === "Enter") {
                e.preventDefault();
                btnAuditQuery.click();
              }
            });
          }
        });
        var auditActionSearchEl = document.getElementById("audit-action-search");
        var auditActionSelect = document.getElementById("audit-filter-action");
        if (auditActionSearchEl && auditActionSelect) {
          var originalOptions = Array.prototype.slice.call(auditActionSelect.options);
          auditActionSearchEl.addEventListener("input", function () {
            var v = auditActionSearchEl.value.trim().toLowerCase();
            auditActionSelect.innerHTML = "";
            originalOptions.forEach(function (opt) {
              if (!v) {
                auditActionSelect.appendChild(opt);
              } else {
                var text = (opt.text || "").toLowerCase();
                if (text.indexOf(v) !== -1 || opt.value === "") {
                  auditActionSelect.appendChild(opt);
                }
              }
            });
          });
        }
        function setAuditQuickRange(kind) {
          var fromEl = document.getElementById("audit-filter-from");
          var toEl = document.getElementById("audit-filter-to");
          if (!fromEl || !toEl) return;
          var now = new Date();
          var start = new Date(now);
          var end = new Date(now);
          if (kind === "today") {
            start.setHours(0, 0, 0, 0);
            end.setHours(23, 59, 0, 0);
          } else if (kind === "week") {
            var day = now.getDay() || 7;
            start.setDate(now.getDate() - day + 1);
            start.setHours(0, 0, 0, 0);
            end = new Date(start);
            end.setDate(start.getDate() + 6);
            end.setHours(23, 59, 0, 0);
          } else if (kind === "month") {
            start = new Date(now.getFullYear(), now.getMonth(), 1, 0, 0, 0, 0);
            end = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 0, 0);
          }
          function toLocalInput(dt) {
            const pad = n => (n < 10 ? "0" + n : "" + n);
            return dt.getFullYear() + "-" + pad(dt.getMonth() + 1) + "-" + pad(dt.getDate()) + "T" + pad(dt.getHours()) + ":" + pad(dt.getMinutes());
          }
          fromEl.value = toLocalInput(start);
          toEl.value = toLocalInput(end);
        }
        var quickToday = document.getElementById("audit-quick-today");
        var quickWeek = document.getElementById("audit-quick-week");
        var quickMonth = document.getElementById("audit-quick-month");
        if (quickToday) quickToday.addEventListener("click", function () { setAuditQuickRange("today"); btnAuditQuery.click(); });
        if (quickWeek) quickWeek.addEventListener("click", function () { setAuditQuickRange("week"); btnAuditQuery.click(); });
        if (quickMonth) quickMonth.addEventListener("click", function () { setAuditQuickRange("month"); btnAuditQuery.click(); });

        async function exportAudit(format) {
          var btnCsv = document.getElementById("btn-audit-export-csv");
          var btnXlsx = document.getElementById("btn-audit-export-xlsx");
          var targetBtn = format === "xlsx" ? btnXlsx : btnCsv;
          if (targetBtn) { targetBtn.disabled = true; targetBtn.textContent = "å¯¼å‡ºä¸­..."; }
          try {
            if (!auditLastRows || !auditLastRows.length) {
              await loadAudit();
            }
            var rows = auditLastRows || [];
            if (!rows.length) return;
            var header = ["æ—¶é—´", "æ“ä½œäºº", "æ“ä½œè¯´æ˜", "å¤‡æ³¨"];
            var lines = [header];
            rows.forEach(function (r) {
              lines.push([r.time || "", r.actor || "", r.summary || "", r.note || ""]);
            });
            var csv = lines.map(function (cols) {
              return cols.map(function (c) {
                var s = String(c).replace(/\"/g, "\"\"");
                if (/[\",\\n]/.test(s)) s = "\"" + s + "\"";
                return s;
              }).join(",");
            }).join("\n");
            var blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
            var a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = format === "xlsx" ? "audit_logs.xlsx" : "audit_logs.csv";
            a.click();
            URL.revokeObjectURL(a.href);
          } finally {
            if (btnCsv) { btnCsv.disabled = false; btnCsv.textContent = "å¯¼å‡º CSV"; }
            if (btnXlsx) { btnXlsx.disabled = false; btnXlsx.textContent = "å¯¼å‡º Excel"; }
          }
        }
        var btnAuditExportCsv = document.getElementById("btn-audit-export-csv");
        var btnAuditExportXlsx = document.getElementById("btn-audit-export-xlsx");
        if (btnAuditExportCsv) btnAuditExportCsv.addEventListener("click", function () { exportAudit("csv"); });
        if (btnAuditExportXlsx) btnAuditExportXlsx.addEventListener("click", function () { exportAudit("xlsx"); });
      }

      async function loadDict() {
        const url = "/api/dict?include_inactive=1&include_deleted=1";
        const res = await fetch(url, { headers: authHeaders() });
        if (!res.ok) {
          var msgEl = document.getElementById("dict-usage-msg");
          if (msgEl) { msgEl.textContent = "åŠ è½½å¤±è´¥ï¼ˆ" + res.status + "ï¼‰ï¼Œè¯·ç¡®è®¤å·²ç™»å½•"; msgEl.className = "msg err"; }
          renderDictTbody("dict-usage-tbody", []);
          renderDictTbody("dict-status-tbody", []);
          return;
        }
        const all = await res.json().catch(function () { return []; });
        const usage = all.filter(function (d) { return d.dict_type === "usage_type"; });
        const status = all.filter(function (d) { return d.dict_type === "device_status"; });
        document.getElementById("dict-usage-msg").textContent = "";
        document.getElementById("dict-usage-msg").className = "msg";
        renderDictTbody("dict-usage-tbody", usage);
        renderDictTbody("dict-status-tbody", status);
      }
      function renderDictTbody(tbodyId, list) {
        const tbody = document.getElementById(tbodyId);
        tbody.innerHTML = "";
        list.forEach(function (d) {
          const tr = document.createElement("tr");
          if (d.is_deleted) tr.classList.add("dict-row-deleted");
          const statusText = d.is_deleted ? "â€”" : (d.is_active ? "å¯ç”¨" : "åœç”¨");
          const deletedText = d.is_deleted ? "æ˜¯" : "å¦";
          const statusHtml = d.is_deleted
            ? escapeHtml(statusText)
            : "<span class=\"dict-pill-status " + (d.is_active ? "dict-pill-status-on" : "dict-pill-status-off") + "\">" + escapeHtml(statusText) + "</span>";
          const deletedHtml = d.is_deleted
            ? "<span class=\"dict-pill-deleted\">æ˜¯</span>"
            : "<span class=\"dict-pill-deleted\" style=\"background:#ecfeff;color:#0f766e;\">å¦</span>";
          const actions = [];
          if (d.is_deleted) {
            actions.push("<button type=\"button\" class=\"dict-restore\" data-id=\"" + d.id + "\">æ¢å¤</button>");
          } else {
            actions.push("<button type=\"button\" class=\"dict-edit\" data-id=\"" + d.id + "\" data-label=\"" + escapeHtml(d.label || "") + "\">ç¼–è¾‘</button>");
            actions.push("<button type=\"button\" class=\"dict-delete\" data-id=\"" + d.id + "\">åˆ é™¤</button>");
            actions.push(d.is_active
              ? "<button type=\"button\" class=\"dict-disable\" data-id=\"" + d.id + "\">åœç”¨</button>"
              : "<button type=\"button\" class=\"dict-enable\" data-id=\"" + d.id + "\">å¯ç”¨</button>");
          }
          tr.innerHTML = "<td>" + (d.code != null ? escapeHtml(String(d.code)) : "") + "</td><td class=\"dict-label-cell\">" + escapeHtml(d.label || "") + "</td><td>" + statusHtml + "</td><td>" + deletedHtml + "</td><td>" + actions.join(" ") + "</td>";
          tr.dataset.id = d.id;
          tbody.appendChild(tr);
        });
        tbody.querySelectorAll(".dict-edit").forEach(function (btn) {
          btn.onclick = function () { dictEdit(btn.dataset.id, btn.dataset.label, tbody); };
        });
        tbody.querySelectorAll(".dict-delete").forEach(function (btn) {
          btn.onclick = function () { dictSoftDelete(parseInt(btn.dataset.id, 10)); };
        });
        tbody.querySelectorAll(".dict-restore").forEach(function (btn) {
          btn.onclick = function () { dictRestore(parseInt(btn.dataset.id, 10)); };
        });
        tbody.querySelectorAll(".dict-enable").forEach(function (btn) {
          btn.onclick = function () { dictSetActive(parseInt(btn.dataset.id, 10), true); };
        });
        tbody.querySelectorAll(".dict-disable").forEach(function (btn) {
          btn.onclick = function () { dictSetActive(parseInt(btn.dataset.id, 10), false); };
        });
      }
      function dictEdit(id, label, tbody) {
        const tr = tbody.querySelector("tr[data-id=\"" + id + "\"]");
        if (!tr) return;
        const cell = tr.querySelector(".dict-label-cell");
        const oldHtml = cell.innerHTML;
        cell.innerHTML = "<input type=\"text\" class=\"dict-edit-input\" value=\"" + escapeHtml(label || "") + "\" /> <button type=\"button\" class=\"dict-save\">ä¿å­˜</button> <button type=\"button\" class=\"dict-cancel\">å–æ¶ˆ</button>";
        const input = cell.querySelector(".dict-edit-input");
        cell.querySelector(".dict-save").onclick = async function () {
          const newLabel = input.value.trim();
          const res = await fetch("/api/dict/" + id, {
            method: "PATCH",
            headers: { "Content-Type": "application/json", ...authHeaders() },
            body: JSON.stringify({ label: newLabel })
          });
          if (res.ok) loadDict(); else alert((await res.json().catch(function(){return{};})).detail || "ä¿å­˜å¤±è´¥");
        };
        cell.querySelector(".dict-cancel").onclick = function () { cell.innerHTML = oldHtml; };
      }
          async function dictSoftDelete(id) {
        if (!confirm("ç¡®å®šè¦åˆ é™¤è¯¥å­—å…¸é¡¹å—ï¼Ÿä»…æ‰“æ ‡è¯†ä¸ç‰©ç†åˆ é™¤ï¼Œå¯åœ¨æœ¬åˆ—è¡¨ä¸­æŸ¥çœ‹ã€‚")) return;
        const res = await fetch("/api/dict/" + id, { method: "DELETE", headers: authHeaders() });
        if (res.ok) loadDict(); else alert((await res.json().catch(function(){return{};})).detail || "åˆ é™¤å¤±è´¥");
      }
      async function dictRestore(id) {
        const res = await fetch("/api/dict/" + id + "/restore", { method: "POST", headers: authHeaders() });
        if (res.ok) loadDict(); else alert((await res.json().catch(function(){return{};})).detail || "æ¢å¤å¤±è´¥");
      }
      async function dictSetActive(id, active) {
        const res = await fetch("/api/dict/" + id, {
          method: "PATCH",
          headers: { "Content-Type": "application/json", ...authHeaders() },
          body: JSON.stringify({ is_active: active })
        });
        if (res.ok) loadDict(); else alert((await res.json().catch(function(){return{};})).detail || "æ“ä½œå¤±è´¥");
      }
      document.getElementById("dict-usage-add").onclick = async function () {
        const codeVal = document.getElementById("dict-usage-code").value;
        const code = codeVal === "" ? NaN : parseInt(codeVal, 10);
        const label = document.getElementById("dict-usage-label").value.trim();
        const msg = document.getElementById("dict-usage-msg");
        if (!label || isNaN(code) || code < 1) { msg.textContent = "è¯·å¡«å†™æœ‰æ•ˆæ•°å­—ç¼–ç ï¼ˆâ‰¥1ï¼‰å’Œæ˜¾ç¤ºåç§°"; msg.className = "msg err"; return; }
        msg.textContent = "æäº¤ä¸­..."; msg.className = "msg";
        const res = await fetch("/api/dict", {
          method: "POST",
          headers: { "Content-Type": "application/json", ...authHeaders() },
          body: JSON.stringify({ dict_type: "usage_type", code: code, label: label })
        });
        if (!res.ok) {
          const err = await res.json().catch(function(){return{};});
          msg.textContent = err.detail || "æ–°å¢å¤±è´¥"; msg.className = "msg err";
          return;
        }
        msg.textContent = "å·²æ·»åŠ "; msg.className = "msg ok";
        document.getElementById("dict-usage-code").value = ""; document.getElementById("dict-usage-label").value = "";
        loadDict();
      };
      document.getElementById("dict-status-add").onclick = async function () {
        const codeVal = document.getElementById("dict-status-code").value;
        const code = codeVal === "" ? NaN : parseInt(codeVal, 10);
        const label = document.getElementById("dict-status-label").value.trim();
        const msg = document.getElementById("dict-status-msg");
        if (!label || isNaN(code) || code < 1) { msg.textContent = "è¯·å¡«å†™æœ‰æ•ˆæ•°å­—ç¼–ç ï¼ˆâ‰¥1ï¼‰å’Œæ˜¾ç¤ºåç§°"; msg.className = "msg err"; return; }
        msg.textContent = "æäº¤ä¸­..."; msg.className = "msg";
        const res = await fetch("/api/dict", {
          method: "POST",
          headers: { "Content-Type": "application/json", ...authHeaders() },
          body: JSON.stringify({ dict_type: "device_status", code: code, label: label })
        });
        if (!res.ok) {
          const err = await res.json().catch(function(){return{};});
          msg.textContent = err.detail || "æ–°å¢å¤±è´¥"; msg.className = "msg err";
          return;
        }
        msg.textContent = "å·²æ·»åŠ "; msg.className = "msg ok";
        document.getElementById("dict-status-code").value = ""; document.getElementById("dict-status-label").value = "";
        loadDict();
      };

      function bindLoginForm() {
        const btn = document.getElementById("btn-login");
        const msg = document.getElementById("login-msg");
        const usernameEl = document.getElementById("login-username");
        const passwordEl = document.getElementById("login-password");
        if (!btn) return;
        function doLogin() {
          const username = (usernameEl && usernameEl.value) ? usernameEl.value.trim() : "";
          const password = (passwordEl && passwordEl.value) || "";
          if (!username) { msg.textContent = "è¯·è¾“å…¥ç”¨æˆ·å"; msg.className = "msg err"; return; }
          msg.textContent = "ç™»å½•ä¸­...";
          msg.className = "msg";
          fetch("/api/auth/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username: username, password: password })
          }).then(function (res) { return res.json().then(function (data) { return { res: res, data: data }; }).catch(function () { return { res: res, data: {} }; }); })
            .then(function (_) {
              var res = _.res, data = _.data;
              if (!res.ok) {
                msg.textContent = data.detail || "ç™»å½•å¤±è´¥";
                msg.className = "msg err";
                return;
              }
              try { localStorage.setItem("device_scan_token", data.access_token); } catch (e) {}
              msg.textContent = "ç™»å½•æˆåŠŸï¼Œæ­£åœ¨åŠ è½½...";
              msg.className = "msg ok";
              location.reload();
            });
        }
        btn.onclick = doLogin;
        function onEnter(e) { if (e.key === "Enter") { e.preventDefault(); doLogin(); } }
        if (usernameEl) usernameEl.addEventListener("keydown", onEnter);
        if (passwordEl) passwordEl.addEventListener("keydown", onEnter);
      }

      if (logoutBtn) {
        logoutBtn.onclick = function () {
          try { localStorage.removeItem("device_scan_token"); } catch (e) {}
          location.reload();
        };
      }

      (async function () {
        if (!await checkAdmin()) {
          bindLoginForm();
          return;
        }
        /* ä»…åœ¨æ ¡éªŒé€šè¿‡åå‘èµ·åç»­è¯·æ±‚ï¼Œä¿è¯è¯·æ±‚å¤´å‡æºå¸¦æœ‰æ•ˆ tokenï¼Œå‡å°‘ 401 */
        loadDashboardStats();
        loadDevices();
        loadUsage();
        initAllResizableTables();
        var deviceDeletedOnlyEl = document.getElementById("device-deleted-only");
        var deviceInactiveOnlyEl = document.getElementById("device-inactive-only");
        if (deviceDeletedOnlyEl) deviceDeletedOnlyEl.addEventListener("change", function () { if (deviceDeletedOnlyEl.checked && deviceInactiveOnlyEl) deviceInactiveOnlyEl.checked = false; devicePage = 0; loadDevices(); });
        if (deviceInactiveOnlyEl) deviceInactiveOnlyEl.addEventListener("change", function () { if (deviceInactiveOnlyEl.checked && deviceDeletedOnlyEl) deviceDeletedOnlyEl.checked = false; devicePage = 0; loadDevices(); });
        var qrModalClose = document.getElementById("device-qr-modal-close");
        var qrModalBackdrop = document.querySelector("#device-qr-modal .device-qr-modal-backdrop");
        if (qrModalClose) qrModalClose.addEventListener("click", closeDeviceQrModal);
        if (qrModalBackdrop) qrModalBackdrop.addEventListener("click", closeDeviceQrModal);
      })();
    </script>
  </body>
</html>
