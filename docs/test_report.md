# 全站自动化测试报告

**执行时间**：2025-02-07  
**执行环境**：Windows / Python 3.14 / pytest 8.4.2  
**测试范围**：backend 全量 pytest（功能、异常、逻辑、并发、审计、设备、性能基础）

---

## 一、执行结果汇总

| 项目 | 数量 |
|------|------|
| 总用例数 | 58 |
| 通过 | 57 |
| 失败 | 0 |
| 跳过 | 1（可选性能用例 `test_health_latency`） |

**结论**：全站自动化测试全部通过。

---

## 二、按模块统计

| 模块 | 用例数 | 说明 |
|------|--------|------|
| test_audit | 2 | 审计列表需鉴权、管理员成功 |
| test_auth | 6 | 登录成功/空用户名/空密码/错误密码、/me 鉴权与成功 |
| test_devices | 12 | 设备创建/列表/联想/详情/分页/导出/重复编号/PATCH 鉴权与 404 |
| test_devices_validation | 2 | 设备编号/名称为空 → 400 |
| test_dict | 3 | 字典列表（使用类型/设备状态）、创建需鉴权 |
| test_full_site | 10 | 全站扩展：异常、逻辑、审计时间筛选、并发、设备分页/404 |
| test_health | 2 | /health、/ 根路径 |
| test_pages | 4 | H5 登记页、我的记录、管理页、表单优化 |
| test_performance_basic | 3 | 健康/根路径响应速度（1 个跳过） |
| test_usage | 12 | 登记鉴权/无效设备/成功/选填床号、列表/总数/导出/撤销/幂等/按床号筛选 |
| test_users | 3 | 用户列表鉴权、管理员成功、count |

---

## 三、测试维度覆盖

### 3.1 功能测试

- **认证**：登录、/me、空用户名/空密码/错误密码。
- **设备**：创建、列表、联想、详情、分页、count、导出 CSV、重复编号 400、PATCH 不存在的 404。
- **使用登记**：创建（必填/选填）、列表、count、导出、撤销、按床号筛选；与设备联动（无效设备 404）。
- **用户与字典**：用户列表/鉴权、字典列表与创建鉴权。
- **审计**：列表需鉴权、管理员成功、时间范围筛选（from_time/to_time）。
- **页面**：H5 登记、我的记录、管理页可访问与基础内容。

### 3.2 异常测试

- **空/非法输入**：登录空用户名/空密码；设备编号/名称为空；登记 `device_code` 为空（接受 400/404/422）。
- **无效资源**：登记不存在的设备 → 404；撤销不存在的记录 → 404；撤销已撤销记录 → 400；PATCH 不存在的设备 → 404。
- **鉴权**：未带 Token 访问需登录接口 → 401；设备创建/PATCH/导出、用户列表、审计、登记导出需管理员。

### 3.3 逻辑与一致性

- **列表与总数一致**：相同筛选条件下 `GET /api/usage` 的列表条数与 `GET /api/usage/count` 一致。
- **无数据导出**：无使用记录时 `GET /api/usage/export` 仍返回 200（空 CSV 或仅表头）。

### 3.4 并发与幂等

- **同设备同用户并发登记**：4 个线程同时 POST 同一设备、同一用户；全部返回 200/201，去重后记录数 ≤ 2（竞态下允许 2 条），且存在至少 2 次请求返回同一 id，体现幂等倾向。
- **重复提交**：`test_usage_duplicate_submit_idempotent` 验证短时间重复 POST 返回同一记录。

### 3.5 性能基础

- **健康与根路径**：响应时间在约定阈值内（`test_health_fast`、`test_root_fast`）；`test_health_latency` 为可选跳过。

---

## 四、已知行为与建议

### 4.1 当前实现行为

1. **空 device_code 登记**：请求体 `device_code: ""` 时，接口返回 **404**（按设备未找到处理）。用例已接受 400/404/422 任一为合法错误响应。
2. **并发同设备同用户**：无 DB 唯一约束时，极端竞态下可能产生 2 条记录；用例已放宽为「去重 id 数 ≤ 2 且存在重复 id」，既通过测试又体现幂等倾向。若需严格单条，可在业务层加唯一约束或锁。

### 4.2 建议后续优化

- **权限**：在 conftest 中增加普通用户 fixture，补充「普通用户访问仅管理员接口 → 403」用例。
- **告警**：Pydantic class-based `config` 弃用、JWT 密钥长度、`datetime.utcnow` 弃用、FastAPI `on_event` 弃用、Starlette `TemplateResponse` 参数顺序等，建议按官方迁移指南逐步处理。

---

## 五、如何复现

在项目根目录下，进入 backend 并设置 PYTHONPATH 后执行：

```bash
cd backend
# Windows PowerShell
$env:PYTHONPATH=".."; poetry run pytest tests/ -v --tb=short
```

或使用 pytest 标记只跑部分用例（如仅全站扩展）：

```bash
$env:PYTHONPATH=".."; poetry run pytest tests/test_full_site.py -v --tb=short
```

---

**报告生成**：基于上述 pytest 全量执行结果整理。
