# 全栈产品与测试检查报告

> 视角：高级产品经理 + 高级测试经理 | 检查时间：基于当前代码库

---

## 一、已修复问题（本次检查中修复）

| 问题 | 位置 | 说明 |
|------|------|------|
| 登记时未排除已删除设备 | `routes_usage.py` 创建设备查询 | 原仅过滤 `is_active`，未排除 `is_deleted`，已补充判断，并统一错误提示为「设备不存在或已停用/已删除」。 |

---

## 二、功能与业务逻辑

### 2.1 登记与使用记录

| 类别 | 问题 | 建议 |
|------|------|------|
| 撤销时效 | 「我的记录」撤销确认弹窗未展示「仅支持最近 N 小时内」的说明 | 在确认文案中补充：如「仅支持撤销最近 24 小时内的登记，超过后不可撤销。」便于用户预期。 |
| 防重复逻辑 | 10 秒内同人同设备重复提交会静默返回已有记录，前端无提示 | 可考虑：返回 200 时若为“重复”，在响应或前端提示「已登记过该设备，无需重复提交」。 |
| 备注长度 | 备注无后端长度限制，仅前端无 maxlength | 建议在 `UsageRecordBase.note` 或 DB 层增加合理上限（如 500/1000 字），避免异常长文本。 |

### 2.2 设备管理

| 类别 | 问题 | 建议 |
|------|------|------|
| 设备编号唯一性 | 新增时校验唯一，但编辑时若改为已存在编号未做校验 | 编辑设备（PATCH）时若修改了 `device_code`，应校验新编号未被其他设备占用。 |
| 搜索与列表 | 设备列表默认不包含已删除，搜索仅对“当前筛选结果”的科室做 datalist | 产品上可接受；若需「科室」为全量可选，可单独提供科室列表接口或从 suggest 拉全量科室。 |
| 导出 | 设备导出状态已按中文展示（此前已修复） | 保持当前逻辑即可。 |

### 2.3 用户与权限

| 类别 | 问题 | 建议 |
|------|------|------|
| 用户管理 | 仅列表与统计，无编辑/改角色/禁用 | 若产品需要，可增加：编辑姓名/科室、角色变更、账号停用（仅列表展示时过滤）。 |
| Token 失效 | 前端未统一处理 401（如弹窗提示 + 跳转登录） | 可在公共请求封装中统一 401 处理：提示「登录已过期」并跳转登录或登记页。 |
| 管理员密码 | 首次用 ADMIN_* 登录创建用户后，密码仅存于 DB，无法在系统内修改 | 可后续增加「修改密码」接口与后台入口。 |

---

## 三、体验与交互（UX）

| 类别 | 问题 | 建议 |
|------|------|------|
| 加载态 | 设备/用户/使用记录列表已有「加载中…」 | 可考虑为导出按钮增加 loading（禁用 + 文案「导出中…」），避免重复点击。 |
| 空状态 | 设备/用户/使用记录空列表有「共 0 条」等 | 可补充简短说明（如「暂无设备，请点击上方新增」）提升引导。 |
| 错误提示 | 部分接口错误仅 alert 或 status 区文字 | 重要操作（如删除、撤销）建议统一为页面内明显区域或确认框，避免依赖 alert。 |
| 分页 | 设备/用户/使用记录均为「上一页/下一页」 | 若总页数较多，可增加「共 N 页」或跳页，便于快速定位。 |
| 登记成功 | 成功后面板有「登记下一台」且焦点已到输入框 | 当前逻辑合理，可保持。 |

---

## 四、安全与合规

| 类别 | 问题 | 建议 |
|------|------|------|
| XSS | 列表与表单展示处已使用 escapeHtml 或 textContent | 继续保持；新增展示用户输入的地方需统一用 escape 或安全渲染。 |
| 敏感信息 | JWT 存 localStorage，登出仅前端 remove | 若有「远程登出」需求，可增加 token 黑名单或短期失效机制。 |
| 导出权限 | 设备/使用记录导出已做角色校验 | 建议导出审计日志中记录导出人、时间、条件，便于追溯。 |
| 输入校验 | 设备名称/科室等有 schema max_length；备注无上限 | 见 2.1 备注长度。 |

---

## 五、接口与数据

| 类别 | 问题 | 建议 |
|------|------|------|
| 列表过滤 | 使用记录列表/导出默认不含已撤销；设备列表/导出支持 deleted_only、inactive_only | 行为符合当前产品设定，保持即可。 |
| 时间格式 | 导出与列表时间格式已统一为 YYYY-MM-DD HH:mm:ss | 无问题。 |
| 字典 | 设备状态/使用类型导出已用中文 | 已修复，保持。 |
| 分页上限 | 设备/用户单页最大 500，使用记录 100 | 可按需要调整；过大需注意性能与超时。 |

---

## 六、兼容与边界

| 类别 | 问题 | 建议 |
|------|------|------|
| 旧库 | devices 表可能无 is_deleted 列，已用 _devices_table_has_is_deleted() 兼容 | 保持；新环境跑迁移脚本即可。 |
| 字典 code | dict_items.code 可能为数字类型，导出状态映射已用 str 统一 | 已修复，保持。 |
| 无 token | 登记/我的记录会提示登录并（登记页）有开发环境引导 | 可考虑在 H5 入口页无 token 时弱提示「请先登录」并突出登录入口。 |

---

## 七、测试建议（测试经理视角）

| 场景 | 建议用例 |
|------|----------|
| 登记 | 未登录提交 → 401；已删除/已停用设备编号提交 → 404；10 秒内同设备重复提交 → 返回已有记录且可考虑前端提示。 |
| 撤销 | 他人记录撤销 → 403；超过 N 小时撤销 → 400；已撤销再次撤销 → 400。 |
| 设备 | 新增重复编号 → 400；编辑改为已存在编号 → 建议 400；只显示已删除/只显示已停用 + 导出 → 仅对应数据。 |
| 工作台 | 各数字点击 → 进入对应面板且筛选正确；二次点击不同数字 → 列表与筛选更新。 |
| 导出 | 设备/使用记录导出大数量（如 1 万+）→ 是否超时或限流，与 EXPORT_MAX_RECORDS 一致。 |
| 权限 | 普通用户访问 /admin → 403 或重定向；普通用户调管理员接口 → 403。 |

---

## 八、优先级建议

- **高**：登记时排除已删除设备（已修）、编辑设备时 device_code 唯一性校验、401 统一处理与提示。
- **中**：撤销确认文案补充时效说明、备注长度限制、导出按钮 loading、用户管理扩展（若需要）。
- **低**：空状态文案优化、分页增强、远程登出/密码修改等。

---

*报告基于当前代码库静态检查与逻辑推演，实际行为请以运行环境与测试为准。*
