# 全站测试清单（上线前逐项打勾）

用于人工/业务测试，按模块逐项验证后再交付生产。

---

## 一、环境与入口

| 序号 | 检查项 | 预期 | 结果 |
|------|--------|------|------|
| 1.1 | 后端启动无报错（端口 8010） | 控制台无异常 | ☐ |
| 1.2 | 访问 `http://127.0.0.1:8010/health` | `{"status":"ok"}` | ☐ |
| 1.3 | 访问 `http://127.0.0.1:8010/` | API 欢迎信息 | ☐ |
| 1.4 | 访问 `http://127.0.0.1:8010/docs` | Swagger 文档可打开（若配置了院内来源则需在白名单内） | ☐ |

---

## 二、认证与权限

| 序号 | 检查项 | 预期 | 结果 |
|------|--------|------|------|
| 2.1 | 管理员登录：正确账号密码 | 200，返回 `access_token`，可进入后台 | ☐ |
| 2.2 | 管理员登录：错误密码 | 401 或 400，提示错误 | ☐ |
| 2.3 | 未登录访问 `/api/usage` 列表 | 401 | ☐ |
| 2.4 | 未登录访问 `/api/devices` 列表 | 可 200（若接口设计为可选鉴权） | ☐ |
| 2.5 | 未登录访问 `/api/users` | 401 | ☐ |
| 2.6 | 企业微信登录（若已配置 WECOM_*） | 跳转企业微信后回调并登录成功 | ☐ |

---

## 三、H5 登记页 `/h5/scan`

| 序号 | 检查项 | 预期 | 结果 |
|------|--------|------|------|
| 3.1 | 页面打开无白屏、控制台无报错 | 正常渲染 | ☐ |
| 3.2 | URL 带 `?device_code=XXX` | 自动带出设备信息并展示表单 | ☐ |
| 3.3 | 选择「常规使用」 | 显示对应字段（设备、日期、时间、床号等） | ☐ |
| 3.4 | 选择「借用」 | 显示借用相关字段（预计归还时间等） | ☐ |
| 3.5 | 选择「维修/故障」 | 显示维修相关字段 | ☐ |
| 3.6 | 必填项不填点提交 | 前端或接口返回校验提示 | ☐ |
| 3.7 | 登记日期选未来日期提交 | 接口返回错误提示 | ☐ |
| 3.8 | 结束时间早于开始时间 | 接口返回错误提示 | ☐ |
| 3.9 | 借用时该设备已有未归还借用 | 接口返回“存在未归还借用”类提示 | ☐ |
| 3.10 | 全部填写正确提交 | 成功提示，可「继续登记」或「查看我的记录」 | ☐ |
| 3.11 | 未登录时提交 | 提示需登录（或跳转企业微信/后台登录） | ☐ |

---

## 四、H5 我的记录 `/h5/my-records`

| 序号 | 检查项 | 预期 | 结果 |
|------|--------|------|------|
| 4.1 | 未登录访问 | 提示登录或跳转登录 | ☐ |
| 4.2 | 登录后访问 | 展示当前用户登记记录列表 | ☐ |
| 4.3 | 借用记录显示「归还」按钮 | 点击后调用归还接口，列表更新为已归还 | ☐ |
| 4.4 | 维修记录显示「完成」按钮 | 点击后调用完成接口，列表更新为已完成 | ☐ |
| 4.5 | 撤销：在允许时间内的记录 | 可撤销，列表更新 | ☐ |
| 4.6 | 导航「登记」/「我的记录」 | 切换正常 | ☐ |

---

## 五、后台管理 `/admin`

### 5.1 工作台（首页）

| 序号 | 检查项 | 预期 | 结果 |
|------|--------|------|------|
| 5.1.1 | 设备总数、启用、停用、已删 | 数字正确 | ☐ |
| 5.1.2 | 用户总数 | 正确 | ☐ |
| 5.1.3 | 使用记录总数 | 正确 | ☐ |
| 5.1.4 | 今日/本周/本月登记量 | 按登记日期统计，数字合理 | ☐ |

### 5.2 设备管理

| 序号 | 检查项 | 预期 | 结果 |
|------|--------|------|------|
| 5.2.1 | 设备列表加载 | 分页、搜索正常 | ☐ |
| 5.2.2 | 新增设备 | 保存成功，列表刷新 | ☐ |
| 5.2.3 | 编辑设备 | 保存成功 | ☐ |
| 5.2.4 | 设备二维码 | 弹窗显示二维码，扫码可得完整 URL | ☐ |
| 5.2.5 | 导出 CSV/Excel | 下载文件正常 | ☐ |
| 5.2.6 | 批量导入：下载模板 | 下载 `.xlsx` 模板 | ☐ |
| 5.2.7 | 批量导入：上传合规 Excel | 显示成功导入 X 条、跳过 Y 条，列表刷新 | ☐ |
| 5.2.8 | 批量导入：设备编号重复 | 该行跳过，errors 中有提示 | ☐ |
| 5.2.9 | 停用/启用、删除/恢复 | 状态与列表更新正确 | ☐ |

### 5.3 使用记录

| 序号 | 检查项 | 预期 | 结果 |
|------|--------|------|------|
| 5.3.1 | 按日期/床号/设备筛选 | 结果符合筛选条件 | ☐ |
| 5.3.2 | 导出 CSV/Excel | 下载文件、内容与列表一致 | ☐ |

### 5.4 用户管理

| 序号 | 检查项 | 预期 | 结果 |
|------|--------|------|------|
| 5.4.1 | 用户列表、新增用户 | 正常 | ☐ |
| 5.4.2 | 修改密码、启用/停用 | 正常 | ☐ |

### 5.5 字典与审计

| 序号 | 检查项 | 预期 | 结果 |
|------|--------|------|------|
| 5.5.1 | 字典管理：操作类型、设备状态 | 列表与增删改正常 | ☐ |
| 5.5.2 | 审计日志 | 有列表、可按时间筛选 | ☐ |

---

## 六、API 关键接口（可选用 Postman/curl 抽查）

| 接口 | 方法 | 检查要点 | 结果 |
|------|------|----------|------|
| `/api/auth/login` | POST | 正确账号密码返回 token | ☐ |
| `/api/auth/me` | GET | 带 token 返回当前用户 | ☐ |
| `/api/dashboard/stats` | GET | 返回设备/用户/记录/今日本周本月统计 | ☐ |
| `/api/devices` | GET | 列表；POST 创建设备（管理员） | ☐ |
| `/api/devices/import-template` | GET | 返回 Excel 文件 | ☐ |
| `/api/devices/import` | POST | multipart 上传 .xlsx，返回 created/skipped/errors | ☐ |
| `/api/usage/form-schema` | GET | 按 usage_type 返回表单 schema | ☐ |
| `/api/usage` | POST | 按模板必填提交登记 | ☐ |
| `/api/usage/{id}/return` | POST | 借用归还 | ☐ |
| `/api/usage/{id}/repair-complete` | POST | 维修完成 | ☐ |
| `/api/usage/{id}/undo` | POST | 撤销（时间窗内） | ☐ |

---

## 七、自动化测试结果（参考）

- 命令：`cd my-first-project && python -m pytest backend/tests -v --tb=short`
- 当前状态：**66 通过，1 跳过**（用例已与表单模板、借用/维修闭环规则对齐；H5 页面用例仅做 ASCII 断言以兼容 Windows 编码）。
- **结论**：自动化测试通过后，再按本清单做人工全站走查即可作为上线依据。

---

## 八、生产上线前必做

- [ ] 设置 `JWT_SECRET` 为强随机值（≥32 字节），且不为默认值
- [ ] 设置 `BASE_URL` 为生产域名（如 `https://device.xxx.edu.cn`），二维码与回调依赖此配置
- [ ] 配置 `ALLOWED_ADMIN_ORIGINS` 或 `ALLOWED_ADMIN_IPS`（若需限制后台仅院内访问）
- [ ] 生产数据库备份与迁移方案（若使用 SQLite 可先备份 db 文件；PostgreSQL 建议用 Alembic）
- [ ] 确认企业微信 `WECOM_*` 与生产 BASE_URL 回调地址一致（若使用企微登录）
- [ ] 管理员首次登录后修改默认密码（若曾用 .env 中的 ADMIN_* 初始账号）

完成上述全站检查并打勾后，即可安排生产发布。
