# 生产部署与数据库表结构说明

部署到生产时，**应用启动时会自动处理表结构**，无需单独执行建表或迁移脚本（除非有特殊说明）。

## 会自动做的几件事

1. **新建表**  
   若数据库里还没有 `users`、`devices`、`usage_records`、`dict_items`、`audit_logs` 等表，会在**首次启动**时通过 `Base.metadata.create_all()` 按当前代码里的模型**自动建表**。

2. **已有表补列（轻量自迁移）**  
   若表已存在但缺少某些列（例如从旧版本升级），启动时会尝试执行 `ALTER TABLE ... ADD COLUMN ...` 补上缺列，例如：
   - `users`: `is_active`
   - `usage_records`: `returned_at`, `repair_completed_at`, `registration_date`, `is_deleted`, `photo_urls`, `terminal_disinfection`
   - `devices`: `is_deleted`  
   列已存在则会跳过，不会报错。

3. **字典种子数据**  
   若 `dict_items` 表为空，会自动写入使用类型、设备状态等初始字典项。

## 不会自动做的事

- **删列、改列类型、改约束**：不会自动执行，需要 DBA 或运维按变更说明手写 SQL 或使用迁移脚本。
- **改索引名、拆表、合表**：需人工处理。

## 部署步骤建议

1. 配置环境变量：`DATABASE_URL`、`JWT_SECRET` 等（见项目根目录或运维文档）。
2. 启动应用（如 `poetry run python run.py` 或 uvicorn）。首次启动或升级后启动时，上述建表与补列会自动执行。
3. 若启动日志中有「自迁移 … 跳过」或「轻量自迁移失败」，可查看日志详情；列已存在时的跳过属正常，其它错误需检查数据库权限或手工执行对应 SQL。

## 新增表或新列时

- **新增一张表**：只需在代码里加上对应 SQLAlchemy 模型并部署，下次启动时 `create_all()` 会创建该表。
- **在已有表上新增列**：在 `models` 里加列后，在 `main.py` 的 `_add_columns` 列表里增加一项 `(表名, 列名, 类型)`，部署后启动即可自动补列（列已存在会自动跳过）。

这样部署到生产、重新设计页面后，只要表/列变更按上面方式做，**都会在应用启动时自动建表或补列**，无需单独跑迁移脚本（除非有特殊结构调整）。
